import{_registerComponent as t,registerVersion as e,_getProvider as n,getApp as s,_removeServiceInstance as r,SDK_VERSION as i}from"https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js";const o=function(t){const e=[];let n=0;for(let s=0;s<t.length;s++){let r=t.charCodeAt(s);r<128?e[n++]=r:r<2048?(e[n++]=r>>6|192,e[n++]=63&r|128):55296==(64512&r)&&s+1<t.length&&56320==(64512&t.charCodeAt(s+1))?(r=65536+((1023&r)<<10)+(1023&t.charCodeAt(++s)),e[n++]=r>>18|240,e[n++]=r>>12&63|128,e[n++]=r>>6&63|128,e[n++]=63&r|128):(e[n++]=r>>12|224,e[n++]=r>>6&63|128,e[n++]=63&r|128)}return e},a={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray(t,e){if(!Array.isArray(t))throw Error("encodeByteArray takes an array as a parameter");this.init_();const n=e?this.byteToCharMapWebSafe_:this.byteToCharMap_,s=[];for(let e=0;e<t.length;e+=3){const r=t[e],i=e+1<t.length,o=i?t[e+1]:0,a=e+2<t.length,u=a?t[e+2]:0,c=r>>2,h=(3&r)<<4|o>>4;let l=(15&o)<<2|u>>6,d=63&u;a||(d=64,i||(l=64)),s.push(n[c],n[h],n[l],n[d])}return s.join("")},encodeString(t,e){return this.HAS_NATIVE_SUPPORT&&!e?btoa(t):this.encodeByteArray(o(t),e)},decodeString(t,e){return this.HAS_NATIVE_SUPPORT&&!e?atob(t):function(t){const e=[];let n=0,s=0;for(;n<t.length;){const r=t[n++];if(r<128)e[s++]=String.fromCharCode(r);else if(r>191&&r<224){const i=t[n++];e[s++]=String.fromCharCode((31&r)<<6|63&i)}else if(r>239&&r<365){const i=((7&r)<<18|(63&t[n++])<<12|(63&t[n++])<<6|63&t[n++])-65536;e[s++]=String.fromCharCode(55296+(i>>10)),e[s++]=String.fromCharCode(56320+(1023&i))}else{const i=t[n++],o=t[n++];e[s++]=String.fromCharCode((15&r)<<12|(63&i)<<6|63&o)}}return e.join("")}(this.decodeStringToByteArray(t,e))},decodeStringToByteArray(t,e){this.init_();const n=e?this.charToByteMapWebSafe_:this.charToByteMap_,s=[];for(let e=0;e<t.length;){const r=n[t.charAt(e++)],i=e<t.length?n[t.charAt(e)]:0;++e;const o=e<t.length?n[t.charAt(e)]:64;++e;const a=e<t.length?n[t.charAt(e)]:64;if(++e,null==r||null==i||null==o||null==a)throw Error();const u=r<<2|i>>4;if(s.push(u),64!==o){const t=i<<4&240|o>>2;if(s.push(t),64!==a){const t=o<<6&192|a;s.push(t)}}}return s},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let t=0;t<this.ENCODED_VALS.length;t++)this.byteToCharMap_[t]=this.ENCODED_VALS.charAt(t),this.charToByteMap_[this.byteToCharMap_[t]]=t,this.byteToCharMapWebSafe_[t]=this.ENCODED_VALS_WEBSAFE.charAt(t),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[t]]=t,t>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(t)]=t,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(t)]=t)}}},u=function(t){return function(t){const e=o(t);return a.encodeByteArray(e,!0)}(t).replace(/\./g,"")};function c(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}function h(){return!function(){try{return"[object process]"===Object.prototype.toString.call(global.process)}catch(t){return!1}}()&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")}class l extends Error{constructor(t,e,n){super(e),this.code=t,this.customData=n,this.name="FirebaseError",Object.setPrototypeOf(this,l.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,d.prototype.create)}}class d{constructor(t,e,n){this.service=t,this.serviceName=e,this.errors=n}create(t,...e){const n=e[0]||{},s=`${this.service}/${t}`,r=this.errors[t],i=r?function(t,e){return t.replace(f,((t,n)=>{const s=e[n];return null!=s?String(s):`<${n}?>`}))}(r,n):"Error",o=`${this.serviceName}: ${i} (${s}).`;return new l(s,o,n)}}const f=/\{\$([^}]+)}/g;function m(t,e){if(t===e)return!0;const n=Object.keys(t),s=Object.keys(e);for(const r of n){if(!s.includes(r))return!1;const n=t[r],i=e[r];if(g(n)&&g(i)){if(!m(n,i))return!1}else if(n!==i)return!1}for(const t of s)if(!n.includes(t))return!1;return!0}function g(t){return null!==t&&"object"==typeof t}function p(t){return t&&t._delegate?t._delegate:t}class y{constructor(t,e,n){this.name=t,this.instanceFactory=e,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(t){return this.instantiationMode=t,this}setMultipleInstances(t){return this.multipleInstances=t,this}setServiceProps(t){return this.serviceProps=t,this}setInstanceCreatedCallback(t){return this.onInstanceCreated=t,this}}var w;!function(t){t[t.DEBUG=0]="DEBUG",t[t.VERBOSE=1]="VERBOSE",t[t.INFO=2]="INFO",t[t.WARN=3]="WARN",t[t.ERROR=4]="ERROR",t[t.SILENT=5]="SILENT"}(w||(w={}));const v={debug:w.DEBUG,verbose:w.VERBOSE,info:w.INFO,warn:w.WARN,error:w.ERROR,silent:w.SILENT},I=w.INFO,b={[w.DEBUG]:"log",[w.VERBOSE]:"log",[w.INFO]:"info",[w.WARN]:"warn",[w.ERROR]:"error"},E=(t,e,...n)=>{if(e<t.logLevel)return;const s=(new Date).toISOString(),r=b[e];if(!r)throw new Error(`Attempted to log a message with an invalid logType (value: ${e})`);console[r](`[${s}]  ${t.name}:`,...n)};var T,S="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},x=x||{},D=S||self;function _(){}function A(t){var e=typeof t;return"array"==(e="object"!=e?e:t?Array.isArray(t)?"array":e:"null")||"object"==e&&"number"==typeof t.length}function C(t){var e=typeof t;return"object"==e&&null!=t||"function"==e}var N="closure_uid_"+(1e9*Math.random()>>>0),k=0;function R(t,e,n){return t.call.apply(t.bind,arguments)}function L(t,e,n){if(!t)throw Error();if(2<arguments.length){var s=Array.prototype.slice.call(arguments,2);return function(){var n=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(n,s),t.apply(e,n)}}return function(){return t.apply(e,arguments)}}function M(t,e,n){return(M=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?R:L).apply(null,arguments)}function O(t,e){var n=Array.prototype.slice.call(arguments,1);return function(){var e=n.slice();return e.push.apply(e,arguments),t.apply(this,e)}}function V(t,e){function n(){}n.prototype=e.prototype,t.X=e.prototype,t.prototype=new n,t.prototype.constructor=t,t.Vb=function(t,n,s){for(var r=Array(arguments.length-2),i=2;i<arguments.length;i++)r[i-2]=arguments[i];return e.prototype[n].apply(t,r)}}function F(){this.s=this.s,this.o=this.o}var P={};F.prototype.s=!1,F.prototype.na=function(){if(!this.s&&(this.s=!0,this.M(),0)){var t=function(t){return Object.prototype.hasOwnProperty.call(t,N)&&t[N]||(t[N]=++k)}(this);delete P[t]}},F.prototype.M=function(){if(this.o)for(;this.o.length;)this.o.shift()()};const B=Array.prototype.indexOf?function(t,e){return Array.prototype.indexOf.call(t,e,void 0)}:function(t,e){if("string"==typeof t)return"string"!=typeof e||1!=e.length?-1:t.indexOf(e,0);for(let n=0;n<t.length;n++)if(n in t&&t[n]===e)return n;return-1};function U(t){const e=t.length;if(0<e){const n=Array(e);for(let s=0;s<e;s++)n[s]=t[s];return n}return[]}function q(t,e){for(let e=1;e<arguments.length;e++){const n=arguments[e];if(A(n)){const e=t.length||0,s=n.length||0;t.length=e+s;for(let r=0;r<s;r++)t[e+r]=n[r]}else t.push(n)}}function G(t,e){this.type=t,this.g=this.target=e,this.defaultPrevented=!1}G.prototype.h=function(){this.defaultPrevented=!0};var K=function(){if(!D.addEventListener||!Object.defineProperty)return!1;var t=!1,e=Object.defineProperty({},"passive",{get:function(){t=!0}});try{D.addEventListener("test",_,e),D.removeEventListener("test",_,e)}catch(t){}return t}();function j(t){return/^[\s\xa0]*$/.test(t)}var $=String.prototype.trim?function(t){return t.trim()}:function(t){return/^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(t)[1]};function z(t,e){return t<e?-1:t>e?1:0}function Q(){var t=D.navigator;return t&&(t=t.userAgent)?t:""}function H(t){return-1!=Q().indexOf(t)}function W(t){return W[" "](t),t}W[" "]=_;var Y,X,J=H("Opera"),Z=H("Trident")||H("MSIE"),tt=H("Edge"),et=tt||Z,nt=H("Gecko")&&!(-1!=Q().toLowerCase().indexOf("webkit")&&!H("Edge"))&&!(H("Trident")||H("MSIE"))&&!H("Edge"),st=-1!=Q().toLowerCase().indexOf("webkit")&&!H("Edge");function rt(){var t=D.document;return t?t.documentMode:void 0}t:{var it="",ot=(X=Q(),nt?/rv:([^\);]+)(\)|;)/.exec(X):tt?/Edge\/([\d\.]+)/.exec(X):Z?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(X):st?/WebKit\/(\S+)/.exec(X):J?/(?:Version)[ \/]?(\S+)/.exec(X):void 0);if(ot&&(it=ot?ot[1]:""),Z){var at=rt();if(null!=at&&at>parseFloat(it)){Y=String(at);break t}}Y=it}var ut,ct={};function ht(){return function(t){var e=ct;return Object.prototype.hasOwnProperty.call(e,9)?e[9]:e[9]=t(9)}((function(){let t=0;const e=$(String(Y)).split("."),n=$("9").split("."),s=Math.max(e.length,n.length);for(let o=0;0==t&&o<s;o++){var r=e[o]||"",i=n[o]||"";do{if(r=/(\d*)(\D*)(.*)/.exec(r)||["","","",""],i=/(\d*)(\D*)(.*)/.exec(i)||["","","",""],0==r[0].length&&0==i[0].length)break;t=z(0==r[1].length?0:parseInt(r[1],10),0==i[1].length?0:parseInt(i[1],10))||z(0==r[2].length,0==i[2].length)||z(r[2],i[2]),r=r[3],i=i[3]}while(0==t)}return 0<=t}))}if(D.document&&Z){var lt=rt();ut=lt||(parseInt(Y,10)||void 0)}else ut=void 0;var dt=ut;function ft(t,e){if(G.call(this,t?t.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,t){var n=this.type=t.type,s=t.changedTouches&&t.changedTouches.length?t.changedTouches[0]:null;if(this.target=t.target||t.srcElement,this.g=e,e=t.relatedTarget){if(nt){t:{try{W(e.nodeName);var r=!0;break t}catch(t){}r=!1}r||(e=null)}}else"mouseover"==n?e=t.fromElement:"mouseout"==n&&(e=t.toElement);this.relatedTarget=e,s?(this.clientX=void 0!==s.clientX?s.clientX:s.pageX,this.clientY=void 0!==s.clientY?s.clientY:s.pageY,this.screenX=s.screenX||0,this.screenY=s.screenY||0):(this.clientX=void 0!==t.clientX?t.clientX:t.pageX,this.clientY=void 0!==t.clientY?t.clientY:t.pageY,this.screenX=t.screenX||0,this.screenY=t.screenY||0),this.button=t.button,this.key=t.key||"",this.ctrlKey=t.ctrlKey,this.altKey=t.altKey,this.shiftKey=t.shiftKey,this.metaKey=t.metaKey,this.pointerId=t.pointerId||0,this.pointerType="string"==typeof t.pointerType?t.pointerType:mt[t.pointerType]||"",this.state=t.state,this.i=t,t.defaultPrevented&&ft.X.h.call(this)}}V(ft,G);var mt={2:"touch",3:"pen",4:"mouse"};ft.prototype.h=function(){ft.X.h.call(this);var t=this.i;t.preventDefault?t.preventDefault():t.returnValue=!1};var gt="closure_listenable_"+(1e6*Math.random()|0),pt=0;function yt(t,e,n,s,r){this.listener=t,this.proxy=null,this.src=e,this.type=n,this.capture=!!s,this.ha=r,this.key=++pt,this.ba=this.ea=!1}function wt(t){t.ba=!0,t.listener=null,t.proxy=null,t.src=null,t.ha=null}function vt(t,e,n){for(const s in t)e.call(n,t[s],s,t)}function It(t){const e={};for(const n in t)e[n]=t[n];return e}const bt="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function Et(t,e){let n,s;for(let e=1;e<arguments.length;e++){for(n in s=arguments[e],s)t[n]=s[n];for(let e=0;e<bt.length;e++)n=bt[e],Object.prototype.hasOwnProperty.call(s,n)&&(t[n]=s[n])}}function Tt(t){this.src=t,this.g={},this.h=0}function St(t,e){var n=e.type;if(n in t.g){var s,r=t.g[n],i=B(r,e);(s=0<=i)&&Array.prototype.splice.call(r,i,1),s&&(wt(e),0==t.g[n].length&&(delete t.g[n],t.h--))}}function xt(t,e,n,s){for(var r=0;r<t.length;++r){var i=t[r];if(!i.ba&&i.listener==e&&i.capture==!!n&&i.ha==s)return r}return-1}Tt.prototype.add=function(t,e,n,s,r){var i=t.toString();(t=this.g[i])||(t=this.g[i]=[],this.h++);var o=xt(t,e,s,r);return-1<o?(e=t[o],n||(e.ea=!1)):((e=new yt(e,this.src,i,!!s,r)).ea=n,t.push(e)),e};var Dt="closure_lm_"+(1e6*Math.random()|0),_t={};function At(t,e,n,s,r){if(s&&s.once)return Nt(t,e,n,s,r);if(Array.isArray(e)){for(var i=0;i<e.length;i++)At(t,e[i],n,s,r);return null}return n=Ft(n),t&&t[gt]?t.N(e,n,C(s)?!!s.capture:!!s,r):Ct(t,e,n,!1,s,r)}function Ct(t,e,n,s,r,i){if(!e)throw Error("Invalid event type");var o=C(r)?!!r.capture:!!r,a=Ot(t);if(a||(t[Dt]=a=new Tt(t)),(n=a.add(e,n,s,o,i)).proxy)return n;if(s=function(){function t(n){return e.call(t.src,t.listener,n)}const e=Mt;return t}(),n.proxy=s,s.src=t,s.listener=n,t.addEventListener)K||(r=o),void 0===r&&(r=!1),t.addEventListener(e.toString(),s,r);else if(t.attachEvent)t.attachEvent(Lt(e.toString()),s);else{if(!t.addListener||!t.removeListener)throw Error("addEventListener and attachEvent are unavailable.");t.addListener(s)}return n}function Nt(t,e,n,s,r){if(Array.isArray(e)){for(var i=0;i<e.length;i++)Nt(t,e[i],n,s,r);return null}return n=Ft(n),t&&t[gt]?t.O(e,n,C(s)?!!s.capture:!!s,r):Ct(t,e,n,!0,s,r)}function kt(t,e,n,s,r){if(Array.isArray(e))for(var i=0;i<e.length;i++)kt(t,e[i],n,s,r);else s=C(s)?!!s.capture:!!s,n=Ft(n),t&&t[gt]?(t=t.i,(e=String(e).toString())in t.g&&(-1<(n=xt(i=t.g[e],n,s,r))&&(wt(i[n]),Array.prototype.splice.call(i,n,1),0==i.length&&(delete t.g[e],t.h--)))):t&&(t=Ot(t))&&(e=t.g[e.toString()],t=-1,e&&(t=xt(e,n,s,r)),(n=-1<t?e[t]:null)&&Rt(n))}function Rt(t){if("number"!=typeof t&&t&&!t.ba){var e=t.src;if(e&&e[gt])St(e.i,t);else{var n=t.type,s=t.proxy;e.removeEventListener?e.removeEventListener(n,s,t.capture):e.detachEvent?e.detachEvent(Lt(n),s):e.addListener&&e.removeListener&&e.removeListener(s),(n=Ot(e))?(St(n,t),0==n.h&&(n.src=null,e[Dt]=null)):wt(t)}}}function Lt(t){return t in _t?_t[t]:_t[t]="on"+t}function Mt(t,e){if(t.ba)t=!0;else{e=new ft(e,this);var n=t.listener,s=t.ha||t.src;t.ea&&Rt(t),t=n.call(s,e)}return t}function Ot(t){return(t=t[Dt])instanceof Tt?t:null}var Vt="__closure_events_fn_"+(1e9*Math.random()>>>0);function Ft(t){return"function"==typeof t?t:(t[Vt]||(t[Vt]=function(e){return t.handleEvent(e)}),t[Vt])}function Pt(){F.call(this),this.i=new Tt(this),this.P=this,this.I=null}function Bt(t,e){var n,s=t.I;if(s)for(n=[];s;s=s.I)n.push(s);if(t=t.P,s=e.type||e,"string"==typeof e)e=new G(e,t);else if(e instanceof G)e.target=e.target||t;else{var r=e;Et(e=new G(s,t),r)}if(r=!0,n)for(var i=n.length-1;0<=i;i--){var o=e.g=n[i];r=Ut(o,s,!0,e)&&r}if(r=Ut(o=e.g=t,s,!0,e)&&r,r=Ut(o,s,!1,e)&&r,n)for(i=0;i<n.length;i++)r=Ut(o=e.g=n[i],s,!1,e)&&r}function Ut(t,e,n,s){if(!(e=t.i.g[String(e)]))return!0;e=e.concat();for(var r=!0,i=0;i<e.length;++i){var o=e[i];if(o&&!o.ba&&o.capture==n){var a=o.listener,u=o.ha||o.src;o.ea&&St(t.i,o),r=!1!==a.call(u,s)&&r}}return r&&!s.defaultPrevented}V(Pt,F),Pt.prototype[gt]=!0,Pt.prototype.removeEventListener=function(t,e,n,s){kt(this,t,e,n,s)},Pt.prototype.M=function(){if(Pt.X.M.call(this),this.i){var t,e=this.i;for(t in e.g){for(var n=e.g[t],s=0;s<n.length;s++)wt(n[s]);delete e.g[t],e.h--}}this.I=null},Pt.prototype.N=function(t,e,n,s){return this.i.add(String(t),e,!1,n,s)},Pt.prototype.O=function(t,e,n,s){return this.i.add(String(t),e,!0,n,s)};var qt=D.JSON.stringify;function Gt(){var t=Wt;let e=null;return t.g&&(e=t.g,t.g=t.g.next,t.g||(t.h=null),e.next=null),e}var Kt,jt=new class{constructor(t,e){this.i=t,this.j=e,this.h=0,this.g=null}get(){let t;return 0<this.h?(this.h--,t=this.g,this.g=t.next,t.next=null):t=this.i(),t}}((()=>new $t),(t=>t.reset()));class $t{constructor(){this.next=this.g=this.h=null}set(t,e){this.h=t,this.g=e,this.next=null}reset(){this.next=this.g=this.h=null}}function zt(t){D.setTimeout((()=>{throw t}),0)}function Qt(t,e){Kt||function(){var t=D.Promise.resolve(void 0);Kt=function(){t.then(Yt)}}(),Ht||(Kt(),Ht=!0),Wt.add(t,e)}var Ht=!1,Wt=new class{constructor(){this.h=this.g=null}add(t,e){const n=jt.get();n.set(t,e),this.h?this.h.next=n:this.g=n,this.h=n}};function Yt(){for(var t;t=Gt();){try{t.h.call(t.g)}catch(t){zt(t)}var e=jt;e.j(t),100>e.h&&(e.h++,t.next=e.g,e.g=t)}Ht=!1}function Xt(t,e){Pt.call(this),this.h=t||1,this.g=e||D,this.j=M(this.kb,this),this.l=Date.now()}function Jt(t){t.ca=!1,t.R&&(t.g.clearTimeout(t.R),t.R=null)}function Zt(t,e,n){if("function"==typeof t)n&&(t=M(t,n));else{if(!t||"function"!=typeof t.handleEvent)throw Error("Invalid listener argument");t=M(t.handleEvent,t)}return 2147483647<Number(e)?-1:D.setTimeout(t,e||0)}function te(t){t.g=Zt((()=>{t.g=null,t.i&&(t.i=!1,te(t))}),t.j);const e=t.h;t.h=null,t.m.apply(null,e)}V(Xt,Pt),(T=Xt.prototype).ca=!1,T.R=null,T.kb=function(){if(this.ca){var t=Date.now()-this.l;0<t&&t<.8*this.h?this.R=this.g.setTimeout(this.j,this.h-t):(this.R&&(this.g.clearTimeout(this.R),this.R=null),Bt(this,"tick"),this.ca&&(Jt(this),this.start()))}},T.start=function(){this.ca=!0,this.R||(this.R=this.g.setTimeout(this.j,this.h),this.l=Date.now())},T.M=function(){Xt.X.M.call(this),Jt(this),delete this.g};class ee extends F{constructor(t,e){super(),this.m=t,this.j=e,this.h=null,this.i=!1,this.g=null}l(t){this.h=arguments,this.g?this.i=!0:te(this)}M(){super.M(),this.g&&(D.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function ne(t){F.call(this),this.h=t,this.g={}}V(ne,F);var se=[];function re(t,e,n,s){Array.isArray(n)||(n&&(se[0]=n.toString()),n=se);for(var r=0;r<n.length;r++){var i=At(e,n[r],s||t.handleEvent,!1,t.h||t);if(!i)break;t.g[i.key]=i}}function ie(t){vt(t.g,(function(t,e){this.g.hasOwnProperty(e)&&Rt(t)}),t),t.g={}}function oe(){this.g=!0}function ae(t,e,n,s){t.info((function(){return"XMLHTTP TEXT ("+e+"): "+function(t,e){if(!t.g)return e;if(!e)return null;try{var n=JSON.parse(e);if(n)for(t=0;t<n.length;t++)if(Array.isArray(n[t])){var s=n[t];if(!(2>s.length)){var r=s[1];if(Array.isArray(r)&&!(1>r.length)){var i=r[0];if("noop"!=i&&"stop"!=i&&"close"!=i)for(var o=1;o<r.length;o++)r[o]=""}}}return qt(n)}catch(t){return e}}(t,n)+(s?" "+s:"")}))}ne.prototype.M=function(){ne.X.M.call(this),ie(this)},ne.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},oe.prototype.Aa=function(){this.g=!1},oe.prototype.info=function(){};var ue={},ce=null;function he(){return ce=ce||new Pt}function le(t){G.call(this,ue.Oa,t)}function de(t){const e=he();Bt(e,new le(e,t))}function fe(t,e){G.call(this,ue.STAT_EVENT,t),this.stat=e}function me(t){const e=he();Bt(e,new fe(e,t))}function ge(t,e){G.call(this,ue.Pa,t),this.size=e}function pe(t,e){if("function"!=typeof t)throw Error("Fn must not be null and must be a function");return D.setTimeout((function(){t()}),e)}ue.Oa="serverreachability",V(le,G),ue.STAT_EVENT="statevent",V(fe,G),ue.Pa="timingevent",V(ge,G);var ye={NO_ERROR:0,lb:1,yb:2,xb:3,sb:4,wb:5,zb:6,La:7,TIMEOUT:8,Cb:9},we={qb:"complete",Mb:"success",Ma:"error",La:"abort",Eb:"ready",Fb:"readystatechange",TIMEOUT:"timeout",Ab:"incrementaldata",Db:"progress",tb:"downloadprogress",Ub:"uploadprogress"};function ve(){}function Ie(t){return t.h||(t.h=t.i())}function be(){}ve.prototype.h=null;var Ee,Te={OPEN:"a",pb:"b",Ma:"c",Bb:"d"};function Se(){G.call(this,"d")}function xe(){G.call(this,"c")}function De(){}function _e(t,e,n,s){this.l=t,this.j=e,this.m=n,this.U=s||1,this.S=new ne(this),this.O=Ce,t=et?125:void 0,this.T=new Xt(t),this.H=null,this.i=!1,this.s=this.A=this.v=this.K=this.F=this.V=this.B=null,this.D=[],this.g=null,this.C=0,this.o=this.u=null,this.Y=-1,this.I=!1,this.N=0,this.L=null,this.$=this.J=this.Z=this.P=!1,this.h=new Ae}function Ae(){this.i=null,this.g="",this.h=!1}V(Se,G),V(xe,G),V(De,ve),De.prototype.g=function(){return new XMLHttpRequest},De.prototype.i=function(){return{}},Ee=new De;var Ce=45e3,Ne={},ke={};function Re(t,e,n){t.K=1,t.v=Xe(ze(e)),t.s=n,t.P=!0,Le(t,null)}function Le(t,e){t.F=Date.now(),Fe(t),t.A=ze(t.v);var n=t.A,s=t.U;Array.isArray(s)||(s=[String(s)]),ln(n.i,"t",s),t.C=0,n=t.l.H,t.h=new Ae,t.g=hs(t.l,n?e:null,!t.s),0<t.N&&(t.L=new ee(M(t.Ka,t,t.g),t.N)),re(t.S,t.g,"readystatechange",t.hb),e=t.H?It(t.H):{},t.s?(t.u||(t.u="POST"),e["Content-Type"]="application/x-www-form-urlencoded",t.g.da(t.A,t.u,t.s,e)):(t.u="GET",t.g.da(t.A,t.u,null,e)),de(1),function(t,e,n,s,r,i){t.info((function(){if(t.g)if(i)for(var o="",a=i.split("&"),u=0;u<a.length;u++){var c=a[u].split("=");if(1<c.length){var h=c[0];c=c[1];var l=h.split("_");o=2<=l.length&&"type"==l[1]?o+(h+"=")+c+"&":o+(h+"=redacted&")}}else o=null;else o=i;return"XMLHTTP REQ ("+s+") [attempt "+r+"]: "+e+"\n"+n+"\n"+o}))}(t.j,t.u,t.A,t.m,t.U,t.s)}function Me(t){return!!t.g&&("GET"==t.u&&2!=t.K&&t.l.Da)}function Oe(t,e,n){let s,r=!0;for(;!t.I&&t.C<n.length;){if(s=Ve(t,n),s==ke){4==e&&(t.o=4,me(14),r=!1),ae(t.j,t.m,null,"[Incomplete Response]");break}if(s==Ne){t.o=4,me(15),ae(t.j,t.m,n,"[Invalid Chunk]"),r=!1;break}ae(t.j,t.m,s,null),Ge(t,s)}Me(t)&&s!=ke&&s!=Ne&&(t.h.g="",t.C=0),4!=e||0!=n.length||t.h.h||(t.o=1,me(16),r=!1),t.i=t.i&&r,r?0<n.length&&!t.$&&(t.$=!0,(e=t.l).g==t&&e.$&&!e.K&&(e.j.info("Great, no buffering proxy detected. Bytes received: "+n.length),ns(e),e.K=!0,me(11))):(ae(t.j,t.m,n,"[Invalid Chunked Response]"),qe(t),Ue(t))}function Ve(t,e){var n=t.C,s=e.indexOf("\n",n);return-1==s?ke:(n=Number(e.substring(n,s)),isNaN(n)?Ne:(s+=1)+n>e.length?ke:(e=e.substr(s,n),t.C=s+n,e))}function Fe(t){t.V=Date.now()+t.O,Pe(t,t.O)}function Pe(t,e){if(null!=t.B)throw Error("WatchDog timer not null");t.B=pe(M(t.fb,t),e)}function Be(t){t.B&&(D.clearTimeout(t.B),t.B=null)}function Ue(t){0==t.l.G||t.I||is(t.l,t)}function qe(t){Be(t);var e=t.L;e&&"function"==typeof e.na&&e.na(),t.L=null,Jt(t.T),ie(t.S),t.g&&(e=t.g,t.g=null,e.abort(),e.na())}function Ge(t,e){try{var n=t.l;if(0!=n.G&&(n.g==t||yn(n.h,t)))if(!t.J&&yn(n.h,t)&&3==n.G){try{var s=n.Fa.g.parse(e)}catch(t){s=null}if(Array.isArray(s)&&3==s.length){var r=s;if(0==r[0]){t:if(!n.u){if(n.g){if(!(n.g.F+3e3<t.F))break t;rs(n),Hn(n)}es(n),me(18)}}else n.Ba=r[1],0<n.Ba-n.T&&37500>r[2]&&n.L&&0==n.A&&!n.v&&(n.v=pe(M(n.bb,n),6e3));if(1>=pn(n.h)&&n.ja){try{n.ja()}catch(t){}n.ja=void 0}}else as(n,11)}else if((t.J||n.g==t)&&rs(n),!j(e))for(r=n.Fa.g.parse(e),e=0;e<r.length;e++){let c=r[e];if(n.T=c[0],c=c[1],2==n.G)if("c"==c[0]){n.I=c[1],n.ka=c[2];const e=c[3];null!=e&&(n.ma=e,n.j.info("VER="+n.ma));const r=c[4];null!=r&&(n.Ca=r,n.j.info("SVER="+n.Ca));const h=c[5];null!=h&&"number"==typeof h&&0<h&&(s=1.5*h,n.J=s,n.j.info("backChannelRequestTimeoutMs_="+s)),s=n;const l=t.g;if(l){const t=l.g?l.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(t){var i=s.h;i.g||-1==t.indexOf("spdy")&&-1==t.indexOf("quic")&&-1==t.indexOf("h2")||(i.j=i.l,i.g=new Set,i.h&&(wn(i,i.h),i.h=null))}if(s.D){const t=l.g?l.g.getResponseHeader("X-HTTP-Session-Id"):null;t&&(s.za=t,Ye(s.F,s.D,t))}}n.G=3,n.l&&n.l.xa(),n.$&&(n.P=Date.now()-t.F,n.j.info("Handshake RTT: "+n.P+"ms"));var o=t;if((s=n).sa=cs(s,s.H?s.ka:null,s.V),o.J){vn(s.h,o);var a=o,u=s.J;u&&a.setTimeout(u),a.B&&(Be(a),Fe(a)),s.g=o}else ts(s);0<n.i.length&&Yn(n)}else"stop"!=c[0]&&"close"!=c[0]||as(n,7);else 3==n.G&&("stop"==c[0]||"close"==c[0]?"stop"==c[0]?as(n,7):Qn(n):"noop"!=c[0]&&n.l&&n.l.wa(c),n.A=0)}de(4)}catch(t){}}function Ke(t,e){if(t.forEach&&"function"==typeof t.forEach)t.forEach(e,void 0);else if(A(t)||"string"==typeof t)Array.prototype.forEach.call(t,e,void 0);else for(var n=function(t){if(t.oa&&"function"==typeof t.oa)return t.oa();if(!t.W||"function"!=typeof t.W){if("undefined"!=typeof Map&&t instanceof Map)return Array.from(t.keys());if(!("undefined"!=typeof Set&&t instanceof Set)){if(A(t)||"string"==typeof t){var e=[];t=t.length;for(var n=0;n<t;n++)e.push(n);return e}e=[],n=0;for(const s in t)e[n++]=s;return e}}}(t),s=function(t){if(t.W&&"function"==typeof t.W)return t.W();if("undefined"!=typeof Map&&t instanceof Map||"undefined"!=typeof Set&&t instanceof Set)return Array.from(t.values());if("string"==typeof t)return t.split("");if(A(t)){for(var e=[],n=t.length,s=0;s<n;s++)e.push(t[s]);return e}for(s in e=[],n=0,t)e[n++]=t[s];return e}(t),r=s.length,i=0;i<r;i++)e.call(void 0,s[i],n&&n[i],t)}(T=_e.prototype).setTimeout=function(t){this.O=t},T.hb=function(t){t=t.target;const e=this.L;e&&3==qn(t)?e.l():this.Ka(t)},T.Ka=function(t){try{if(t==this.g)t:{const h=qn(this.g);var e=this.g.Ea();const l=this.g.aa();if(!(3>h)&&(3!=h||et||this.g&&(this.h.h||this.g.fa()||Gn(this.g)))){this.I||4!=h||7==e||de(8==e||0>=l?3:2),Be(this);var n=this.g.aa();this.Y=n;e:if(Me(this)){var s=Gn(this.g);t="";var r=s.length,i=4==qn(this.g);if(!this.h.i){if("undefined"==typeof TextDecoder){qe(this),Ue(this);var o="";break e}this.h.i=new D.TextDecoder}for(e=0;e<r;e++)this.h.h=!0,t+=this.h.i.decode(s[e],{stream:i&&e==r-1});s.splice(0,r),this.h.g+=t,this.C=0,o=this.h.g}else o=this.g.fa();if(this.i=200==n,function(t,e,n,s,r,i,o){t.info((function(){return"XMLHTTP RESP ("+s+") [ attempt "+r+"]: "+e+"\n"+n+"\n"+i+" "+o}))}(this.j,this.u,this.A,this.m,this.U,h,n),this.i){if(this.Z&&!this.J){e:{if(this.g){var a,u=this.g;if((a=u.g?u.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!j(a)){var c=a;break e}}c=null}if(!(n=c)){this.i=!1,this.o=3,me(12),qe(this),Ue(this);break t}ae(this.j,this.m,n,"Initial handshake response via X-HTTP-Initial-Response"),this.J=!0,Ge(this,n)}this.P?(Oe(this,h,o),et&&this.i&&3==h&&(re(this.S,this.T,"tick",this.gb),this.T.start())):(ae(this.j,this.m,o,null),Ge(this,o)),4==h&&qe(this),this.i&&!this.I&&(4==h?is(this.l,this):(this.i=!1,Fe(this)))}else 400==n&&0<o.indexOf("Unknown SID")?(this.o=3,me(12)):(this.o=0,me(13)),qe(this),Ue(this)}}}catch(t){}},T.gb=function(){if(this.g){var t=qn(this.g),e=this.g.fa();this.C<e.length&&(Be(this),Oe(this,t,e),this.i&&4!=t&&Fe(this))}},T.cancel=function(){this.I=!0,qe(this)},T.fb=function(){this.B=null;const t=Date.now();0<=t-this.V?(function(t,e){t.info((function(){return"TIMEOUT: "+e}))}(this.j,this.A),2!=this.K&&(de(3),me(17)),qe(this),this.o=2,Ue(this)):Pe(this,this.V-t)};var je=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function $e(t,e){if(this.g=this.s=this.j="",this.m=null,this.o=this.l="",this.h=!1,t instanceof $e){this.h=void 0!==e?e:t.h,Qe(this,t.j),this.s=t.s,this.g=t.g,He(this,t.m),this.l=t.l,e=t.i;var n=new an;n.i=e.i,e.g&&(n.g=new Map(e.g),n.h=e.h),We(this,n),this.o=t.o}else t&&(n=String(t).match(je))?(this.h=!!e,Qe(this,n[1]||"",!0),this.s=Je(n[2]||""),this.g=Je(n[3]||"",!0),He(this,n[4]),this.l=Je(n[5]||"",!0),We(this,n[6]||"",!0),this.o=Je(n[7]||"")):(this.h=!!e,this.i=new an(null,this.h))}function ze(t){return new $e(t)}function Qe(t,e,n){t.j=n?Je(e,!0):e,t.j&&(t.j=t.j.replace(/:$/,""))}function He(t,e){if(e){if(e=Number(e),isNaN(e)||0>e)throw Error("Bad port number "+e);t.m=e}else t.m=null}function We(t,e,n){e instanceof an?(t.i=e,function(t,e){e&&!t.j&&(un(t),t.i=null,t.g.forEach((function(t,e){var n=e.toLowerCase();e!=n&&(cn(this,e),ln(this,n,t))}),t)),t.j=e}(t.i,t.h)):(n||(e=Ze(e,rn)),t.i=new an(e,t.h))}function Ye(t,e,n){t.i.set(e,n)}function Xe(t){return Ye(t,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),t}function Je(t,e){return t?e?decodeURI(t.replace(/%25/g,"%2525")):decodeURIComponent(t):""}function Ze(t,e,n){return"string"==typeof t?(t=encodeURI(t).replace(e,tn),n&&(t=t.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),t):null}function tn(t){return"%"+((t=t.charCodeAt(0))>>4&15).toString(16)+(15&t).toString(16)}$e.prototype.toString=function(){var t=[],e=this.j;e&&t.push(Ze(e,en,!0),":");var n=this.g;return(n||"file"==e)&&(t.push("//"),(e=this.s)&&t.push(Ze(e,en,!0),"@"),t.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.m)&&t.push(":",String(n))),(n=this.l)&&(this.g&&"/"!=n.charAt(0)&&t.push("/"),t.push(Ze(n,"/"==n.charAt(0)?sn:nn,!0))),(n=this.i.toString())&&t.push("?",n),(n=this.o)&&t.push("#",Ze(n,on)),t.join("")};var en=/[#\/\?@]/g,nn=/[#\?:]/g,sn=/[#\?]/g,rn=/[#\?@]/g,on=/#/g;function an(t,e){this.h=this.g=null,this.i=t||null,this.j=!!e}function un(t){t.g||(t.g=new Map,t.h=0,t.i&&function(t,e){if(t){t=t.split("&");for(var n=0;n<t.length;n++){var s=t[n].indexOf("="),r=null;if(0<=s){var i=t[n].substring(0,s);r=t[n].substring(s+1)}else i=t[n];e(i,r?decodeURIComponent(r.replace(/\+/g," ")):"")}}}(t.i,(function(e,n){t.add(decodeURIComponent(e.replace(/\+/g," ")),n)})))}function cn(t,e){un(t),e=dn(t,e),t.g.has(e)&&(t.i=null,t.h-=t.g.get(e).length,t.g.delete(e))}function hn(t,e){return un(t),e=dn(t,e),t.g.has(e)}function ln(t,e,n){cn(t,e),0<n.length&&(t.i=null,t.g.set(dn(t,e),U(n)),t.h+=n.length)}function dn(t,e){return e=String(e),t.j&&(e=e.toLowerCase()),e}(T=an.prototype).add=function(t,e){un(this),this.i=null,t=dn(this,t);var n=this.g.get(t);return n||this.g.set(t,n=[]),n.push(e),this.h+=1,this},T.forEach=function(t,e){un(this),this.g.forEach((function(n,s){n.forEach((function(n){t.call(e,n,s,this)}),this)}),this)},T.oa=function(){un(this);const t=Array.from(this.g.values()),e=Array.from(this.g.keys()),n=[];for(let s=0;s<e.length;s++){const r=t[s];for(let t=0;t<r.length;t++)n.push(e[s])}return n},T.W=function(t){un(this);let e=[];if("string"==typeof t)hn(this,t)&&(e=e.concat(this.g.get(dn(this,t))));else{t=Array.from(this.g.values());for(let n=0;n<t.length;n++)e=e.concat(t[n])}return e},T.set=function(t,e){return un(this),this.i=null,hn(this,t=dn(this,t))&&(this.h-=this.g.get(t).length),this.g.set(t,[e]),this.h+=1,this},T.get=function(t,e){return t&&0<(t=this.W(t)).length?String(t[0]):e},T.toString=function(){if(this.i)return this.i;if(!this.g)return"";const t=[],e=Array.from(this.g.keys());for(var n=0;n<e.length;n++){var s=e[n];const i=encodeURIComponent(String(s)),o=this.W(s);for(s=0;s<o.length;s++){var r=i;""!==o[s]&&(r+="="+encodeURIComponent(String(o[s]))),t.push(r)}}return this.i=t.join("&")};function fn(t){this.l=t||mn,D.PerformanceNavigationTiming?t=0<(t=D.performance.getEntriesByType("navigation")).length&&("hq"==t[0].nextHopProtocol||"h2"==t[0].nextHopProtocol):t=!!(D.g&&D.g.Ga&&D.g.Ga()&&D.g.Ga().Zb),this.j=t?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}var mn=10;function gn(t){return!!t.h||!!t.g&&t.g.size>=t.j}function pn(t){return t.h?1:t.g?t.g.size:0}function yn(t,e){return t.h?t.h==e:!!t.g&&t.g.has(e)}function wn(t,e){t.g?t.g.add(e):t.h=e}function vn(t,e){t.h&&t.h==e?t.h=null:t.g&&t.g.has(e)&&t.g.delete(e)}function In(t){if(null!=t.h)return t.i.concat(t.h.D);if(null!=t.g&&0!==t.g.size){let e=t.i;for(const n of t.g.values())e=e.concat(n.D);return e}return U(t.i)}function bn(){}function En(){this.g=new bn}function Tn(t,e,n){const s=n||"";try{Ke(t,(function(t,n){let r=t;C(t)&&(r=qt(t)),e.push(s+n+"="+encodeURIComponent(r))}))}catch(t){throw e.push(s+"type="+encodeURIComponent("_badmap")),t}}function Sn(t,e,n,s,r){try{e.onload=null,e.onerror=null,e.onabort=null,e.ontimeout=null,r(s)}catch(t){}}function xn(t){this.l=t.$b||null,this.j=t.ib||!1}function Dn(t,e){Pt.call(this),this.D=t,this.u=e,this.m=void 0,this.readyState=_n,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}fn.prototype.cancel=function(){if(this.i=In(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const t of this.g.values())t.cancel();this.g.clear()}},bn.prototype.stringify=function(t){return D.JSON.stringify(t,void 0)},bn.prototype.parse=function(t){return D.JSON.parse(t,void 0)},V(xn,ve),xn.prototype.g=function(){return new Dn(this.l,this.j)},xn.prototype.i=function(t){return function(){return t}}({}),V(Dn,Pt);var _n=0;function An(t){t.j.read().then(t.Sa.bind(t)).catch(t.ga.bind(t))}function Cn(t){t.readyState=4,t.l=null,t.j=null,t.A=null,Nn(t)}function Nn(t){t.onreadystatechange&&t.onreadystatechange.call(t)}(T=Dn.prototype).open=function(t,e){if(this.readyState!=_n)throw this.abort(),Error("Error reopening a connection");this.C=t,this.B=e,this.readyState=1,Nn(this)},T.send=function(t){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const e={headers:this.v,method:this.C,credentials:this.m,cache:void 0};t&&(e.body=t),(this.D||D).fetch(new Request(this.B,e)).then(this.Va.bind(this),this.ga.bind(this))},T.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch((()=>{})),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,Cn(this)),this.readyState=_n},T.Va=function(t){if(this.g&&(this.l=t,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=t.headers,this.readyState=2,Nn(this)),this.g&&(this.readyState=3,Nn(this),this.g)))if("arraybuffer"===this.responseType)t.arrayBuffer().then(this.Ta.bind(this),this.ga.bind(this));else if(void 0!==D.ReadableStream&&"body"in t){if(this.j=t.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;An(this)}else t.text().then(this.Ua.bind(this),this.ga.bind(this))},T.Sa=function(t){if(this.g){if(this.u&&t.value)this.response.push(t.value);else if(!this.u){var e=t.value?t.value:new Uint8Array(0);(e=this.A.decode(e,{stream:!t.done}))&&(this.response=this.responseText+=e)}t.done?Cn(this):Nn(this),3==this.readyState&&An(this)}},T.Ua=function(t){this.g&&(this.response=this.responseText=t,Cn(this))},T.Ta=function(t){this.g&&(this.response=t,Cn(this))},T.ga=function(){this.g&&Cn(this)},T.setRequestHeader=function(t,e){this.v.append(t,e)},T.getResponseHeader=function(t){return this.h&&this.h.get(t.toLowerCase())||""},T.getAllResponseHeaders=function(){if(!this.h)return"";const t=[],e=this.h.entries();for(var n=e.next();!n.done;)n=n.value,t.push(n[0]+": "+n[1]),n=e.next();return t.join("\r\n")},Object.defineProperty(Dn.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(t){this.m=t?"include":"same-origin"}});var kn=D.JSON.parse;function Rn(t){Pt.call(this),this.headers=new Map,this.u=t||null,this.h=!1,this.C=this.g=null,this.H="",this.m=0,this.j="",this.l=this.F=this.v=this.D=!1,this.B=0,this.A=null,this.J=Ln,this.K=this.L=!1}V(Rn,Pt);var Ln="",Mn=/^https?$/i,On=["POST","PUT"];function Vn(t,e){t.h=!1,t.g&&(t.l=!0,t.g.abort(),t.l=!1),t.j=e,t.m=5,Fn(t),Bn(t)}function Fn(t){t.D||(t.D=!0,Bt(t,"complete"),Bt(t,"error"))}function Pn(t){if(t.h&&void 0!==x&&(!t.C[1]||4!=qn(t)||2!=t.aa()))if(t.v&&4==qn(t))Zt(t.Ha,0,t);else if(Bt(t,"readystatechange"),4==qn(t)){t.h=!1;try{const a=t.aa();t:switch(a){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var e=!0;break t;default:e=!1}var n;if(!(n=e)){var s;if(s=0===a){var r=String(t.H).match(je)[1]||null;if(!r&&D.self&&D.self.location){var i=D.self.location.protocol;r=i.substr(0,i.length-1)}s=!Mn.test(r?r.toLowerCase():"")}n=s}if(n)Bt(t,"complete"),Bt(t,"success");else{t.m=6;try{var o=2<qn(t)?t.g.statusText:""}catch(t){o=""}t.j=o+" ["+t.aa()+"]",Fn(t)}}finally{Bn(t)}}}function Bn(t,e){if(t.g){Un(t);const n=t.g,s=t.C[0]?_:null;t.g=null,t.C=null,e||Bt(t,"ready");try{n.onreadystatechange=s}catch(t){}}}function Un(t){t.g&&t.K&&(t.g.ontimeout=null),t.A&&(D.clearTimeout(t.A),t.A=null)}function qn(t){return t.g?t.g.readyState:0}function Gn(t){try{if(!t.g)return null;if("response"in t.g)return t.g.response;switch(t.J){case Ln:case"text":return t.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in t.g)return t.g.mozResponseArrayBuffer}return null}catch(t){return null}}function Kn(t){let e="";return vt(t,(function(t,n){e+=n,e+=":",e+=t,e+="\r\n"})),e}function jn(t,e,n){t:{for(s in n){var s=!1;break t}s=!0}s||(n=Kn(n),"string"==typeof t?null!=n&&encodeURIComponent(String(n)):Ye(t,e,n))}function $n(t,e,n){return n&&n.internalChannelParams&&n.internalChannelParams[t]||e}function zn(t){this.Ca=0,this.i=[],this.j=new oe,this.ka=this.sa=this.F=this.V=this.g=this.za=this.D=this.ia=this.o=this.S=this.s=null,this.$a=this.U=0,this.Ya=$n("failFast",!1,t),this.L=this.v=this.u=this.m=this.l=null,this.Y=!0,this.pa=this.Ba=this.T=-1,this.Z=this.A=this.C=0,this.Wa=$n("baseRetryDelayMs",5e3,t),this.ab=$n("retryDelaySeedMs",1e4,t),this.Za=$n("forwardChannelMaxRetries",2,t),this.ta=$n("forwardChannelRequestTimeoutMs",2e4,t),this.ra=t&&t.xmlHttpFactory||void 0,this.Da=t&&t.Yb||!1,this.J=void 0,this.H=t&&t.supportsCrossDomainXhr||!1,this.I="",this.h=new fn(t&&t.concurrentRequestLimit),this.Fa=new En,this.O=t&&t.fastHandshake||!1,this.N=t&&t.encodeInitMessageHeaders||!1,this.O&&this.N&&(this.N=!1),this.Xa=t&&t.Wb||!1,t&&t.Aa&&this.j.Aa(),t&&t.forceLongPolling&&(this.Y=!1),this.$=!this.O&&this.Y&&t&&t.detectBufferingProxy||!1,this.ja=void 0,this.P=0,this.K=!1,this.la=this.B=null}function Qn(t){if(Wn(t),3==t.G){var e=t.U++,n=ze(t.F);Ye(n,"SID",t.I),Ye(n,"RID",e),Ye(n,"TYPE","terminate"),Jn(t,n),(e=new _e(t,t.j,e,void 0)).K=2,e.v=Xe(ze(n)),n=!1,D.navigator&&D.navigator.sendBeacon&&(n=D.navigator.sendBeacon(e.v.toString(),"")),!n&&D.Image&&((new Image).src=e.v,n=!0),n||(e.g=hs(e.l,null),e.g.da(e.v)),e.F=Date.now(),Fe(e)}us(t)}function Hn(t){t.g&&(ns(t),t.g.cancel(),t.g=null)}function Wn(t){Hn(t),t.u&&(D.clearTimeout(t.u),t.u=null),rs(t),t.h.cancel(),t.m&&("number"==typeof t.m&&D.clearTimeout(t.m),t.m=null)}function Yn(t){gn(t.h)||t.m||(t.m=!0,Qt(t.Ja,t),t.C=0)}function Xn(t,e){var n;n=e?e.m:t.U++;const s=ze(t.F);Ye(s,"SID",t.I),Ye(s,"RID",n),Ye(s,"AID",t.T),Jn(t,s),t.o&&t.s&&jn(s,t.o,t.s),n=new _e(t,t.j,n,t.C+1),null===t.o&&(n.H=t.s),e&&(t.i=e.D.concat(t.i)),e=Zn(t,n,1e3),n.setTimeout(Math.round(.5*t.ta)+Math.round(.5*t.ta*Math.random())),wn(t.h,n),Re(n,s,e)}function Jn(t,e){t.ia&&vt(t.ia,(function(t,n){Ye(e,n,t)})),t.l&&Ke({},(function(t,n){Ye(e,n,t)}))}function Zn(t,e,n){n=Math.min(t.i.length,n);var s=t.l?M(t.l.Qa,t.l,t):null;t:{var r=t.i;let e=-1;for(;;){const t=["count="+n];-1==e?0<n?(e=r[0].h,t.push("ofs="+e)):e=0:t.push("ofs="+e);let i=!0;for(let o=0;o<n;o++){let n=r[o].h;const a=r[o].g;if(n-=e,0>n)e=Math.max(0,r[o].h-100),i=!1;else try{Tn(a,t,"req"+n+"_")}catch(t){s&&s(a)}}if(i){s=t.join("&");break t}}}return t=t.i.splice(0,n),e.D=t,s}function ts(t){t.g||t.u||(t.Z=1,Qt(t.Ia,t),t.A=0)}function es(t){return!(t.g||t.u||3<=t.A)&&(t.Z++,t.u=pe(M(t.Ia,t),os(t,t.A)),t.A++,!0)}function ns(t){null!=t.B&&(D.clearTimeout(t.B),t.B=null)}function ss(t){t.g=new _e(t,t.j,"rpc",t.Z),null===t.o&&(t.g.H=t.s),t.g.N=0;var e=ze(t.sa);Ye(e,"RID","rpc"),Ye(e,"SID",t.I),Ye(e,"CI",t.L?"0":"1"),Ye(e,"AID",t.T),Ye(e,"TYPE","xmlhttp"),Jn(t,e),t.o&&t.s&&jn(e,t.o,t.s),t.J&&t.g.setTimeout(t.J);var n=t.g;t=t.ka,n.K=1,n.v=Xe(ze(e)),n.s=null,n.P=!0,Le(n,t)}function rs(t){null!=t.v&&(D.clearTimeout(t.v),t.v=null)}function is(t,e){var n=null;if(t.g==e){rs(t),ns(t),t.g=null;var s=2}else{if(!yn(t.h,e))return;n=e.D,vn(t.h,e),s=1}if(0!=t.G)if(t.pa=e.Y,e.i)if(1==s){n=e.s?e.s.length:0,e=Date.now()-e.F;var r=t.C;Bt(s=he(),new ge(s,n,e,r)),Yn(t)}else ts(t);else if(3==(r=e.o)||0==r&&0<t.pa||!(1==s&&function(t,e){return!(pn(t.h)>=t.h.j-(t.m?1:0)||(t.m?(t.i=e.D.concat(t.i),0):1==t.G||2==t.G||t.C>=(t.Ya?0:t.Za)||(t.m=pe(M(t.Ja,t,e),os(t,t.C)),t.C++,0)))}(t,e)||2==s&&es(t)))switch(n&&0<n.length&&(e=t.h,e.i=e.i.concat(n)),r){case 1:as(t,5);break;case 4:as(t,10);break;case 3:as(t,6);break;default:as(t,2)}}function os(t,e){let n=t.Wa+Math.floor(Math.random()*t.ab);return t.l||(n*=2),n*e}function as(t,e){if(t.j.info("Error code "+e),2==e){var n=null;t.l&&(n=null);var s=M(t.jb,t);n||(n=new $e("//www.google.com/images/cleardot.gif"),D.location&&"http"==D.location.protocol||Qe(n,"https"),Xe(n)),function(t,e){const n=new oe;if(D.Image){const s=new Image;s.onload=O(Sn,n,s,"TestLoadImage: loaded",!0,e),s.onerror=O(Sn,n,s,"TestLoadImage: error",!1,e),s.onabort=O(Sn,n,s,"TestLoadImage: abort",!1,e),s.ontimeout=O(Sn,n,s,"TestLoadImage: timeout",!1,e),D.setTimeout((function(){s.ontimeout&&s.ontimeout()}),1e4),s.src=t}else e(!1)}(n.toString(),s)}else me(2);t.G=0,t.l&&t.l.va(e),us(t),Wn(t)}function us(t){if(t.G=0,t.la=[],t.l){const e=In(t.h);0==e.length&&0==t.i.length||(q(t.la,e),q(t.la,t.i),t.h.i.length=0,U(t.i),t.i.length=0),t.l.ua()}}function cs(t,e,n){var s=n instanceof $e?ze(n):new $e(n,void 0);if(""!=s.g)e&&(s.g=e+"."+s.g),He(s,s.m);else{var r=D.location;s=r.protocol,e=e?e+"."+r.hostname:r.hostname,r=+r.port;var i=new $e(null,void 0);s&&Qe(i,s),e&&(i.g=e),r&&He(i,r),n&&(i.l=n),s=i}return n=t.D,e=t.za,n&&e&&Ye(s,n,e),Ye(s,"VER",t.ma),Jn(t,s),s}function hs(t,e,n){if(e&&!t.H)throw Error("Can't create secondary domain capable XhrIo object.");return(e=n&&t.Da&&!t.ra?new Rn(new xn({ib:!0})):new Rn(t.ra)).L=t.H,e}function ls(){}function ds(){if(Z&&!(10<=Number(dt)))throw Error("Environmental error: no available transport.")}function fs(t,e){Pt.call(this),this.g=new zn(e),this.l=t,this.h=e&&e.messageUrlParams||null,t=e&&e.messageHeaders||null,e&&e.clientProtocolHeaderRequired&&(t?t["X-Client-Protocol"]="webchannel":t={"X-Client-Protocol":"webchannel"}),this.g.s=t,t=e&&e.initMessageHeaders||null,e&&e.messageContentType&&(t?t["X-WebChannel-Content-Type"]=e.messageContentType:t={"X-WebChannel-Content-Type":e.messageContentType}),e&&e.ya&&(t?t["X-WebChannel-Client-Profile"]=e.ya:t={"X-WebChannel-Client-Profile":e.ya}),this.g.S=t,(t=e&&e.Xb)&&!j(t)&&(this.g.o=t),this.A=e&&e.supportsCrossDomainXhr||!1,this.v=e&&e.sendRawJson||!1,(e=e&&e.httpSessionIdParam)&&!j(e)&&(this.g.D=e,null!==(t=this.h)&&e in t&&(e in(t=this.h)&&delete t[e])),this.j=new ps(this)}function ms(t){Se.call(this);var e=t.__sm__;if(e){t:{for(const n in e){t=n;break t}t=void 0}(this.i=t)&&(t=this.i,e=null!==e&&t in e?e[t]:void 0),this.data=e}else this.data=t}function gs(){xe.call(this),this.status=1}function ps(t){this.g=t}(T=Rn.prototype).da=function(t,e,n,s){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.H+"; newUri="+t);e=e?e.toUpperCase():"GET",this.H=t,this.j="",this.m=0,this.D=!1,this.h=!0,this.g=this.u?this.u.g():Ee.g(),this.C=this.u?Ie(this.u):Ie(Ee),this.g.onreadystatechange=M(this.Ha,this);try{this.F=!0,this.g.open(e,String(t),!0),this.F=!1}catch(t){return void Vn(this,t)}if(t=n||"",n=new Map(this.headers),s)if(Object.getPrototypeOf(s)===Object.prototype)for(var r in s)n.set(r,s[r]);else{if("function"!=typeof s.keys||"function"!=typeof s.get)throw Error("Unknown input type for opt_headers: "+String(s));for(const t of s.keys())n.set(t,s.get(t))}s=Array.from(n.keys()).find((t=>"content-type"==t.toLowerCase())),r=D.FormData&&t instanceof D.FormData,!(0<=B(On,e))||s||r||n.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(const[t,e]of n)this.g.setRequestHeader(t,e);this.J&&(this.g.responseType=this.J),"withCredentials"in this.g&&this.g.withCredentials!==this.L&&(this.g.withCredentials=this.L);try{Un(this),0<this.B&&((this.K=function(t){return Z&&ht()&&"number"==typeof t.timeout&&void 0!==t.ontimeout}(this.g))?(this.g.timeout=this.B,this.g.ontimeout=M(this.qa,this)):this.A=Zt(this.qa,this.B,this)),this.v=!0,this.g.send(t),this.v=!1}catch(t){Vn(this,t)}},T.qa=function(){void 0!==x&&this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,Bt(this,"timeout"),this.abort(8))},T.abort=function(t){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=t||7,Bt(this,"complete"),Bt(this,"abort"),Bn(this))},T.M=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),Bn(this,!0)),Rn.X.M.call(this)},T.Ha=function(){this.s||(this.F||this.v||this.l?Pn(this):this.eb())},T.eb=function(){Pn(this)},T.aa=function(){try{return 2<qn(this)?this.g.status:-1}catch(t){return-1}},T.fa=function(){try{return this.g?this.g.responseText:""}catch(t){return""}},T.Ra=function(t){if(this.g){var e=this.g.responseText;return t&&0==e.indexOf(t)&&(e=e.substring(t.length)),kn(e)}},T.Ea=function(){return this.m},T.Na=function(){return"string"==typeof this.j?this.j:String(this.j)},(T=zn.prototype).ma=8,T.G=1,T.Ja=function(t){if(this.m)if(this.m=null,1==this.G){if(!t){this.U=Math.floor(1e5*Math.random()),t=this.U++;const r=new _e(this,this.j,t,void 0);let i=this.s;if(this.S&&(i?(i=It(i),Et(i,this.S)):i=this.S),null!==this.o||this.N||(r.H=i,i=null),this.O)t:{for(var e=0,n=0;n<this.i.length;n++){var s=this.i[n];if(void 0===(s="__data__"in s.g&&"string"==typeof(s=s.g.__data__)?s.length:void 0))break;if(4096<(e+=s)){e=n;break t}if(4096===e||n===this.i.length-1){e=n+1;break t}}e=1e3}else e=1e3;e=Zn(this,r,e),Ye(n=ze(this.F),"RID",t),Ye(n,"CVER",22),this.D&&Ye(n,"X-HTTP-Session-Id",this.D),Jn(this,n),i&&(this.N?e="headers="+encodeURIComponent(String(Kn(i)))+"&"+e:this.o&&jn(n,this.o,i)),wn(this.h,r),this.Xa&&Ye(n,"TYPE","init"),this.O?(Ye(n,"$req",e),Ye(n,"SID","null"),r.Z=!0,Re(r,n,null)):Re(r,n,e),this.G=2}}else 3==this.G&&(t?Xn(this,t):0==this.i.length||gn(this.h)||Xn(this))},T.Ia=function(){if(this.u=null,ss(this),this.$&&!(this.K||null==this.g||0>=this.P)){var t=2*this.P;this.j.info("BP detection timer enabled: "+t),this.B=pe(M(this.cb,this),t)}},T.cb=function(){this.B&&(this.B=null,this.j.info("BP detection timeout reached."),this.j.info("Buffering proxy detected and switch to long-polling!"),this.L=!1,this.K=!0,me(10),Hn(this),ss(this))},T.bb=function(){null!=this.v&&(this.v=null,Hn(this),es(this),me(19))},T.jb=function(t){t?(this.j.info("Successfully pinged google.com"),me(2)):(this.j.info("Failed to ping google.com"),me(1))},(T=ls.prototype).xa=function(){},T.wa=function(){},T.va=function(){},T.ua=function(){},T.Qa=function(){},ds.prototype.g=function(t,e){return new fs(t,e)},V(fs,Pt),fs.prototype.m=function(){this.g.l=this.j,this.A&&(this.g.H=!0);var t=this.g,e=this.l,n=this.h||void 0;me(0),t.V=e,t.ia=n||{},t.L=t.Y,t.F=cs(t,null,t.V),Yn(t)},fs.prototype.close=function(){Qn(this.g)},fs.prototype.u=function(t){var e=this.g;if("string"==typeof t){var n={};n.__data__=t,t=n}else this.v&&((n={}).__data__=qt(t),t=n);e.i.push(new class{constructor(t,e){this.h=t,this.g=e}}(e.$a++,t)),3==e.G&&Yn(e)},fs.prototype.M=function(){this.g.l=null,delete this.j,Qn(this.g),delete this.g,fs.X.M.call(this)},V(ms,Se),V(gs,xe),V(ps,ls),ps.prototype.xa=function(){Bt(this.g,"a")},ps.prototype.wa=function(t){Bt(this.g,new ms(t))},ps.prototype.va=function(t){Bt(this.g,new gs(t))},ps.prototype.ua=function(){Bt(this.g,"b")},ds.prototype.createWebChannel=ds.prototype.g,fs.prototype.send=fs.prototype.u,fs.prototype.open=fs.prototype.m,fs.prototype.close=fs.prototype.close,ye.NO_ERROR=0,ye.TIMEOUT=8,ye.HTTP_ERROR=6,we.COMPLETE="complete",be.EventType=Te,Te.OPEN="a",Te.CLOSE="b",Te.ERROR="c",Te.MESSAGE="d",Pt.prototype.listen=Pt.prototype.N,Rn.prototype.listenOnce=Rn.prototype.O,Rn.prototype.getLastError=Rn.prototype.Na,Rn.prototype.getLastErrorCode=Rn.prototype.Ea,Rn.prototype.getStatus=Rn.prototype.aa,Rn.prototype.getResponseJson=Rn.prototype.Ra,Rn.prototype.getResponseText=Rn.prototype.fa,Rn.prototype.send=Rn.prototype.da;var ys=ye,ws=we,vs=ue,Is=10,bs=11,Es=xn,Ts=be,Ss=Rn;const xs="@firebase/firestore";class Ds{constructor(t){this.uid=t}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(t){return t.uid===this.uid}}Ds.UNAUTHENTICATED=new Ds(null),Ds.GOOGLE_CREDENTIALS=new Ds("google-credentials-uid"),Ds.FIRST_PARTY=new Ds("first-party-uid"),Ds.MOCK_USER=new Ds("mock-user");let _s="9.10.0";const As=new class{constructor(t){this.name=t,this._logLevel=I,this._logHandler=E,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(t){if(!(t in w))throw new TypeError(`Invalid value "${t}" assigned to \`logLevel\``);this._logLevel=t}setLogLevel(t){this._logLevel="string"==typeof t?v[t]:t}get logHandler(){return this._logHandler}set logHandler(t){if("function"!=typeof t)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=t}get userLogHandler(){return this._userLogHandler}set userLogHandler(t){this._userLogHandler=t}debug(...t){this._userLogHandler&&this._userLogHandler(this,w.DEBUG,...t),this._logHandler(this,w.DEBUG,...t)}log(...t){this._userLogHandler&&this._userLogHandler(this,w.VERBOSE,...t),this._logHandler(this,w.VERBOSE,...t)}info(...t){this._userLogHandler&&this._userLogHandler(this,w.INFO,...t),this._logHandler(this,w.INFO,...t)}warn(...t){this._userLogHandler&&this._userLogHandler(this,w.WARN,...t),this._logHandler(this,w.WARN,...t)}error(...t){this._userLogHandler&&this._userLogHandler(this,w.ERROR,...t),this._logHandler(this,w.ERROR,...t)}}("@firebase/firestore");function Cs(){return As.logLevel}function Ns(t){As.setLogLevel(t)}function ks(t,...e){if(As.logLevel<=w.DEBUG){const n=e.map(Ms);As.debug(`Firestore (${_s}): ${t}`,...n)}}function Rs(t,...e){if(As.logLevel<=w.ERROR){const n=e.map(Ms);As.error(`Firestore (${_s}): ${t}`,...n)}}function Ls(t,...e){if(As.logLevel<=w.WARN){const n=e.map(Ms);As.warn(`Firestore (${_s}): ${t}`,...n)}}function Ms(t){if("string"==typeof t)return t;try{return e=t,JSON.stringify(e)}catch(e){return t}var e}function Os(t="Unexpected state"){const e=`FIRESTORE (${_s}) INTERNAL ASSERTION FAILED: `+t;throw Rs(e),new Error(e)}function Vs(t,e){t||Os()}function Fs(t,e){t||Os()}function Ps(t,e){return t}const Bs={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class Us extends l{constructor(t,e){super(t,e),this.code=t,this.message=e,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class qs{constructor(){this.promise=new Promise(((t,e)=>{this.resolve=t,this.reject=e}))}}class Gs{constructor(t,e){this.user=e,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${t}`)}}class Ks{getToken(){return Promise.resolve(null)}invalidateToken(){}start(t,e){t.enqueueRetryable((()=>e(Ds.UNAUTHENTICATED)))}shutdown(){}}class js{constructor(t){this.token=t,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(t,e){this.changeListener=e,t.enqueueRetryable((()=>e(this.token.user)))}shutdown(){this.changeListener=null}}class $s{constructor(t){this.t=t,this.currentUser=Ds.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,e){let n=this.i;const s=t=>this.i!==n?(n=this.i,e(t)):Promise.resolve();let r=new qs;this.o=()=>{this.i++,this.currentUser=this.u(),r.resolve(),r=new qs,t.enqueueRetryable((()=>s(this.currentUser)))};const i=()=>{const e=r;t.enqueueRetryable((async()=>{await e.promise,await s(this.currentUser)}))},o=t=>{ks("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=t,this.auth.addAuthTokenListener(this.o),i()};this.t.onInit((t=>o(t))),setTimeout((()=>{if(!this.auth){const t=this.t.getImmediate({optional:!0});t?o(t):(ks("FirebaseAuthCredentialsProvider","Auth not yet detected"),r.resolve(),r=new qs)}}),0),i()}getToken(){const t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then((e=>this.i!==t?(ks("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):e?(Vs("string"==typeof e.accessToken),new Gs(e.accessToken,this.currentUser)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){const t=this.auth&&this.auth.getUid();return Vs(null===t||"string"==typeof t),new Ds(t)}}class zs{constructor(t,e,n,s){this.h=t,this.l=e,this.m=n,this.g=s,this.type="FirstParty",this.user=Ds.FIRST_PARTY,this.p=new Map}I(){return this.g?this.g():(Vs(!("object"!=typeof this.h||null===this.h||!this.h.auth||!this.h.auth.getAuthHeaderValueForFirstParty)),this.h.auth.getAuthHeaderValueForFirstParty([]))}get headers(){this.p.set("X-Goog-AuthUser",this.l);const t=this.I();return t&&this.p.set("Authorization",t),this.m&&this.p.set("X-Goog-Iam-Authorization-Token",this.m),this.p}}class Qs{constructor(t,e,n,s){this.h=t,this.l=e,this.m=n,this.g=s}getToken(){return Promise.resolve(new zs(this.h,this.l,this.m,this.g))}start(t,e){t.enqueueRetryable((()=>e(Ds.FIRST_PARTY)))}shutdown(){}invalidateToken(){}}class Hs{constructor(t){this.value=t,this.type="AppCheck",this.headers=new Map,t&&t.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class Ws{constructor(t){this.T=t,this.forceRefresh=!1,this.appCheck=null,this.A=null}start(t,e){const n=t=>{null!=t.error&&ks("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${t.error.message}`);const n=t.token!==this.A;return this.A=t.token,ks("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?e(t.token):Promise.resolve()};this.o=e=>{t.enqueueRetryable((()=>n(e)))};const s=t=>{ks("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=t,this.appCheck.addTokenListener(this.o)};this.T.onInit((t=>s(t))),setTimeout((()=>{if(!this.appCheck){const t=this.T.getImmediate({optional:!0});t?s(t):ks("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}}),0)}getToken(){const t=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(t).then((t=>t?(Vs("string"==typeof t.token),this.A=t.token,new Hs(t.token)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}class Ys{getToken(){return Promise.resolve(new Hs(""))}invalidateToken(){}start(t,e){}shutdown(){}}function Xs(t){const e="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(t);if(e&&"function"==typeof e.getRandomValues)e.getRandomValues(n);else for(let e=0;e<t;e++)n[e]=Math.floor(256*Math.random());return n}class Js{static R(){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e=Math.floor(256/t.length)*t.length;let n="";for(;n.length<20;){const s=Xs(40);for(let r=0;r<s.length;++r)n.length<20&&s[r]<e&&(n+=t.charAt(s[r]%t.length))}return n}}function Zs(t,e){return t<e?-1:t>e?1:0}function tr(t,e,n){return t.length===e.length&&t.every(((t,s)=>n(t,e[s])))}function er(t){return t+"\0"}class nr{constructor(t,e){if(this.seconds=t,this.nanoseconds=e,e<0)throw new Us(Bs.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(e>=1e9)throw new Us(Bs.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<-62135596800)throw new Us(Bs.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(t>=253402300800)throw new Us(Bs.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}static now(){return nr.fromMillis(Date.now())}static fromDate(t){return nr.fromMillis(t.getTime())}static fromMillis(t){const e=Math.floor(t/1e3),n=Math.floor(1e6*(t-1e3*e));return new nr(e,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(t){return this.seconds===t.seconds?Zs(this.nanoseconds,t.nanoseconds):Zs(this.seconds,t.seconds)}isEqual(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const t=this.seconds- -62135596800;return String(t).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class sr{constructor(t){this.timestamp=t}static fromTimestamp(t){return new sr(t)}static min(){return new sr(new nr(0,0))}static max(){return new sr(new nr(253402300799,999999999))}compareTo(t){return this.timestamp._compareTo(t.timestamp)}isEqual(t){return this.timestamp.isEqual(t.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class rr{constructor(t,e,n){void 0===e?e=0:e>t.length&&Os(),void 0===n?n=t.length-e:n>t.length-e&&Os(),this.segments=t,this.offset=e,this.len=n}get length(){return this.len}isEqual(t){return 0===rr.comparator(this,t)}child(t){const e=this.segments.slice(this.offset,this.limit());return t instanceof rr?t.forEach((t=>{e.push(t)})):e.push(t),this.construct(e)}limit(){return this.offset+this.length}popFirst(t){return t=void 0===t?1:t,this.construct(this.segments,this.offset+t,this.length-t)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(t){return this.segments[this.offset+t]}isEmpty(){return 0===this.length}isPrefixOf(t){if(t.length<this.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}isImmediateParentOf(t){if(this.length+1!==t.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}forEach(t){for(let e=this.offset,n=this.limit();e<n;e++)t(this.segments[e])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(t,e){const n=Math.min(t.length,e.length);for(let s=0;s<n;s++){const n=t.get(s),r=e.get(s);if(n<r)return-1;if(n>r)return 1}return t.length<e.length?-1:t.length>e.length?1:0}}class ir extends rr{construct(t,e,n){return new ir(t,e,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...t){const e=[];for(const n of t){if(n.indexOf("//")>=0)throw new Us(Bs.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);e.push(...n.split("/").filter((t=>t.length>0)))}return new ir(e)}static emptyPath(){return new ir([])}}const or=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class ar extends rr{construct(t,e,n){return new ar(t,e,n)}static isValidIdentifier(t){return or.test(t)}canonicalString(){return this.toArray().map((t=>(t=t.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),ar.isValidIdentifier(t)||(t="`"+t+"`"),t))).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new ar(["__name__"])}static fromServerFormat(t){const e=[];let n="",s=0;const r=()=>{if(0===n.length)throw new Us(Bs.INVALID_ARGUMENT,`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);e.push(n),n=""};let i=!1;for(;s<t.length;){const e=t[s];if("\\"===e){if(s+1===t.length)throw new Us(Bs.INVALID_ARGUMENT,"Path has trailing escape character: "+t);const e=t[s+1];if("\\"!==e&&"."!==e&&"`"!==e)throw new Us(Bs.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);n+=e,s+=2}else"`"===e?(i=!i,s++):"."!==e||i?(n+=e,s++):(r(),s++)}if(r(),i)throw new Us(Bs.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new ar(e)}static emptyPath(){return new ar([])}}class ur{constructor(t){this.path=t}static fromPath(t){return new ur(ir.fromString(t))}static fromName(t){return new ur(ir.fromString(t).popFirst(5))}static empty(){return new ur(ir.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(t){return this.path.length>=2&&this.path.get(this.path.length-2)===t}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(t){return null!==t&&0===ir.comparator(this.path,t.path)}toString(){return this.path.toString()}static comparator(t,e){return ir.comparator(t.path,e.path)}static isDocumentKey(t){return t.length%2==0}static fromSegments(t){return new ur(new ir(t.slice()))}}class cr{constructor(t,e,n,s){this.indexId=t,this.collectionGroup=e,this.fields=n,this.indexState=s}}function hr(t){return t.fields.find((t=>2===t.kind))}function lr(t){return t.fields.filter((t=>2!==t.kind))}function dr(t,e){let n=Zs(t.collectionGroup,e.collectionGroup);if(0!==n)return n;for(let s=0;s<Math.min(t.fields.length,e.fields.length);++s)if(n=mr(t.fields[s],e.fields[s]),0!==n)return n;return Zs(t.fields.length,e.fields.length)}cr.UNKNOWN_ID=-1;class fr{constructor(t,e){this.fieldPath=t,this.kind=e}}function mr(t,e){const n=ar.comparator(t.fieldPath,e.fieldPath);return 0!==n?n:Zs(t.kind,e.kind)}class gr{constructor(t,e){this.sequenceNumber=t,this.offset=e}static empty(){return new gr(0,wr.min())}}function pr(t,e){const n=t.toTimestamp().seconds,s=t.toTimestamp().nanoseconds+1,r=sr.fromTimestamp(1e9===s?new nr(n+1,0):new nr(n,s));return new wr(r,ur.empty(),e)}function yr(t){return new wr(t.readTime,t.key,-1)}class wr{constructor(t,e,n){this.readTime=t,this.documentKey=e,this.largestBatchId=n}static min(){return new wr(sr.min(),ur.empty(),-1)}static max(){return new wr(sr.max(),ur.empty(),-1)}}function vr(t,e){let n=t.readTime.compareTo(e.readTime);return 0!==n?n:(n=ur.comparator(t.documentKey,e.documentKey),0!==n?n:Zs(t.largestBatchId,e.largestBatchId))}const Ir="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class br{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(t){this.onCommittedListeners.push(t)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach((t=>t()))}}async function Er(t){if(t.code!==Bs.FAILED_PRECONDITION||t.message!==Ir)throw t;ks("LocalStore","Unexpectedly lost primary lease")}class Tr{constructor(t){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t((t=>{this.isDone=!0,this.result=t,this.nextCallback&&this.nextCallback(t)}),(t=>{this.isDone=!0,this.error=t,this.catchCallback&&this.catchCallback(t)}))}catch(t){return this.next(void 0,t)}next(t,e){return this.callbackAttached&&Os(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(e,this.error):this.wrapSuccess(t,this.result):new Tr(((n,s)=>{this.nextCallback=e=>{this.wrapSuccess(t,e).next(n,s)},this.catchCallback=t=>{this.wrapFailure(e,t).next(n,s)}}))}toPromise(){return new Promise(((t,e)=>{this.next(t,e)}))}wrapUserFunction(t){try{const e=t();return e instanceof Tr?e:Tr.resolve(e)}catch(t){return Tr.reject(t)}}wrapSuccess(t,e){return t?this.wrapUserFunction((()=>t(e))):Tr.resolve(e)}wrapFailure(t,e){return t?this.wrapUserFunction((()=>t(e))):Tr.reject(e)}static resolve(t){return new Tr(((e,n)=>{e(t)}))}static reject(t){return new Tr(((e,n)=>{n(t)}))}static waitFor(t){return new Tr(((e,n)=>{let s=0,r=0,i=!1;t.forEach((t=>{++s,t.next((()=>{++r,i&&r===s&&e()}),(t=>n(t)))})),i=!0,r===s&&e()}))}static or(t){let e=Tr.resolve(!1);for(const n of t)e=e.next((t=>t?Tr.resolve(t):n()));return e}static forEach(t,e){const n=[];return t.forEach(((t,s)=>{n.push(e.call(this,t,s))})),this.waitFor(n)}static mapArray(t,e){return new Tr(((n,s)=>{const r=t.length,i=new Array(r);let o=0;for(let a=0;a<r;a++){const u=a;e(t[u]).next((t=>{i[u]=t,++o,o===r&&n(i)}),(t=>s(t)))}}))}static doWhile(t,e){return new Tr(((n,s)=>{const r=()=>{!0===t()?e().next((()=>{r()}),s):n()};r()}))}}class Sr{constructor(t,e){this.action=t,this.transaction=e,this.aborted=!1,this.P=new qs,this.transaction.oncomplete=()=>{this.P.resolve()},this.transaction.onabort=()=>{e.error?this.P.reject(new _r(t,e.error)):this.P.resolve()},this.transaction.onerror=e=>{const n=Rr(e.target.error);this.P.reject(new _r(t,n))}}static open(t,e,n,s){try{return new Sr(e,t.transaction(s,n))}catch(t){throw new _r(e,t)}}get v(){return this.P.promise}abort(t){t&&this.P.reject(t),this.aborted||(ks("SimpleDb","Aborting transaction:",t?t.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}V(){const t=this.transaction;this.aborted||"function"!=typeof t.commit||t.commit()}store(t){const e=this.transaction.objectStore(t);return new Cr(e)}}class xr{constructor(t,e,n){this.name=t,this.version=e,this.S=n,12.2===xr.D(c())&&Rs("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(t){return ks("SimpleDb","Removing database:",t),Nr(window.indexedDB.deleteDatabase(t)).toPromise()}static C(){if("object"!=typeof indexedDB)return!1;if(xr.N())return!0;const t=c(),e=xr.D(t),n=0<e&&e<10,s=xr.k(t),r=0<s&&s<4.5;return!(t.indexOf("MSIE ")>0||t.indexOf("Trident/")>0||t.indexOf("Edge/")>0||n||r)}static N(){var t;return"undefined"!=typeof process&&"YES"===(null===(t=process.env)||void 0===t?void 0:t.M)}static O(t,e){return t.store(e)}static D(t){const e=t.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=e?e[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static k(t){const e=t.match(/Android ([\d.]+)/i),n=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async F(t){return this.db||(ks("SimpleDb","Opening database:",this.name),this.db=await new Promise(((e,n)=>{const s=indexedDB.open(this.name,this.version);s.onsuccess=t=>{const n=t.target.result;e(n)},s.onblocked=()=>{n(new _r(t,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},s.onerror=e=>{const s=e.target.error;"VersionError"===s.name?n(new Us(Bs.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===s.name?n(new Us(Bs.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+s)):n(new _r(t,s))},s.onupgradeneeded=t=>{ks("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',t.oldVersion);const e=t.target.result;this.S.$(e,s.transaction,t.oldVersion,this.version).next((()=>{ks("SimpleDb","Database upgrade to version "+this.version+" complete")}))}}))),this.B&&(this.db.onversionchange=t=>this.B(t)),this.db}L(t){this.B=t,this.db&&(this.db.onversionchange=e=>t(e))}async runTransaction(t,e,n,s){const r="readonly"===e;let i=0;for(;;){++i;try{this.db=await this.F(t);const e=Sr.open(this.db,t,r?"readonly":"readwrite",n),i=s(e).next((t=>(e.V(),t))).catch((t=>(e.abort(t),Tr.reject(t)))).toPromise();return i.catch((()=>{})),await e.v,i}catch(t){const e=t,n="FirebaseError"!==e.name&&i<3;if(ks("SimpleDb","Transaction failed with error:",e.message,"Retrying:",n),this.close(),!n)return Promise.reject(e)}}}close(){this.db&&this.db.close(),this.db=void 0}}class Dr{constructor(t){this.U=t,this.q=!1,this.K=null}get isDone(){return this.q}get G(){return this.K}set cursor(t){this.U=t}done(){this.q=!0}j(t){this.K=t}delete(){return Nr(this.U.delete())}}class _r extends Us{constructor(t,e){super(Bs.UNAVAILABLE,`IndexedDB transaction '${t}' failed: ${e}`),this.name="IndexedDbTransactionError"}}function Ar(t){return"IndexedDbTransactionError"===t.name}class Cr{constructor(t){this.store=t}put(t,e){let n;return void 0!==e?(ks("SimpleDb","PUT",this.store.name,t,e),n=this.store.put(e,t)):(ks("SimpleDb","PUT",this.store.name,"<auto-key>",t),n=this.store.put(t)),Nr(n)}add(t){return ks("SimpleDb","ADD",this.store.name,t,t),Nr(this.store.add(t))}get(t){return Nr(this.store.get(t)).next((e=>(void 0===e&&(e=null),ks("SimpleDb","GET",this.store.name,t,e),e)))}delete(t){return ks("SimpleDb","DELETE",this.store.name,t),Nr(this.store.delete(t))}count(){return ks("SimpleDb","COUNT",this.store.name),Nr(this.store.count())}W(t,e){const n=this.options(t,e);if(n.index||"function"!=typeof this.store.getAll){const t=this.cursor(n),e=[];return this.H(t,((t,n)=>{e.push(n)})).next((()=>e))}{const t=this.store.getAll(n.range);return new Tr(((e,n)=>{t.onerror=t=>{n(t.target.error)},t.onsuccess=t=>{e(t.target.result)}}))}}J(t,e){const n=this.store.getAll(t,null===e?void 0:e);return new Tr(((t,e)=>{n.onerror=t=>{e(t.target.error)},n.onsuccess=e=>{t(e.target.result)}}))}Y(t,e){ks("SimpleDb","DELETE ALL",this.store.name);const n=this.options(t,e);n.X=!1;const s=this.cursor(n);return this.H(s,((t,e,n)=>n.delete()))}Z(t,e){let n;e?n=t:(n={},e=t);const s=this.cursor(n);return this.H(s,e)}tt(t){const e=this.cursor({});return new Tr(((n,s)=>{e.onerror=t=>{const e=Rr(t.target.error);s(e)},e.onsuccess=e=>{const s=e.target.result;s?t(s.primaryKey,s.value).next((t=>{t?s.continue():n()})):n()}}))}H(t,e){const n=[];return new Tr(((s,r)=>{t.onerror=t=>{r(t.target.error)},t.onsuccess=t=>{const r=t.target.result;if(!r)return void s();const i=new Dr(r),o=e(r.primaryKey,r.value,i);if(o instanceof Tr){const t=o.catch((t=>(i.done(),Tr.reject(t))));n.push(t)}i.isDone?s():null===i.G?r.continue():r.continue(i.G)}})).next((()=>Tr.waitFor(n)))}options(t,e){let n;return void 0!==t&&("string"==typeof t?n=t:e=t),{index:n,range:e}}cursor(t){let e="next";if(t.reverse&&(e="prev"),t.index){const n=this.store.index(t.index);return t.X?n.openKeyCursor(t.range,e):n.openCursor(t.range,e)}return this.store.openCursor(t.range,e)}}function Nr(t){return new Tr(((e,n)=>{t.onsuccess=t=>{const n=t.target.result;e(n)},t.onerror=t=>{const e=Rr(t.target.error);n(e)}}))}let kr=!1;function Rr(t){const e=xr.D(c());if(e>=12.2&&e<13){const e="An internal error was encountered in the Indexed Database server";if(t.message.indexOf(e)>=0){const t=new Us("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${e}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return kr||(kr=!0,setTimeout((()=>{throw t}),0)),t}}return t}class Lr{constructor(t,e){this.asyncQueue=t,this.et=e,this.task=null}start(){this.nt(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}nt(t){ks("IndexBackiller",`Scheduled in ${t}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",t,(async()=>{this.task=null;try{ks("IndexBackiller",`Documents written: ${await this.et.st()}`)}catch(t){Ar(t)?ks("IndexBackiller","Ignoring IndexedDB error during index backfill: ",t):await Er(t)}await this.nt(6e4)}))}}class Mr{constructor(t,e){this.localStore=t,this.persistence=e}async st(t=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",(e=>this.it(e,t)))}it(t,e){const n=new Set;let s=e,r=!0;return Tr.doWhile((()=>!0===r&&s>0),(()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(t).next((e=>{if(null!==e&&!n.has(e))return ks("IndexBackiller",`Processing collection: ${e}`),this.rt(t,e,s).next((t=>{s-=t,n.add(e)}));r=!1})))).next((()=>e-s))}rt(t,e,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(t,e).next((s=>this.localStore.localDocuments.getNextDocuments(t,e,s,n).next((n=>{const r=n.changes;return this.localStore.indexManager.updateIndexEntries(t,r).next((()=>this.ot(s,n))).next((n=>(ks("IndexBackiller",`Updating offset: ${n}`),this.localStore.indexManager.updateCollectionGroup(t,e,n)))).next((()=>r.size))}))))}ot(t,e){let n=t;return e.changes.forEach(((t,e)=>{const s=yr(e);vr(s,n)>0&&(n=s)})),new wr(n.readTime,n.documentKey,Math.max(e.batchId,t.largestBatchId))}}class Or{constructor(t,e){this.previousValue=t,e&&(e.sequenceNumberHandler=t=>this.ut(t),this.ct=t=>e.writeSequenceNumber(t))}ut(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue}next(){const t=++this.previousValue;return this.ct&&this.ct(t),t}}function Vr(t){let e=0;for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e++;return e}function Fr(t,e){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e(n,t[n])}function Pr(t){for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}Or.at=-1;class Br{constructor(t,e){this.comparator=t,this.root=e||qr.EMPTY}insert(t,e){return new Br(this.comparator,this.root.insert(t,e,this.comparator).copy(null,null,qr.BLACK,null,null))}remove(t){return new Br(this.comparator,this.root.remove(t,this.comparator).copy(null,null,qr.BLACK,null,null))}get(t){let e=this.root;for(;!e.isEmpty();){const n=this.comparator(t,e.key);if(0===n)return e.value;n<0?e=e.left:n>0&&(e=e.right)}return null}indexOf(t){let e=0,n=this.root;for(;!n.isEmpty();){const s=this.comparator(t,n.key);if(0===s)return e+n.left.size;s<0?n=n.left:(e+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(t){return this.root.inorderTraversal(t)}forEach(t){this.inorderTraversal(((e,n)=>(t(e,n),!1)))}toString(){const t=[];return this.inorderTraversal(((e,n)=>(t.push(`${e}:${n}`),!1))),`{${t.join(", ")}}`}reverseTraversal(t){return this.root.reverseTraversal(t)}getIterator(){return new Ur(this.root,null,this.comparator,!1)}getIteratorFrom(t){return new Ur(this.root,t,this.comparator,!1)}getReverseIterator(){return new Ur(this.root,null,this.comparator,!0)}getReverseIteratorFrom(t){return new Ur(this.root,t,this.comparator,!0)}}class Ur{constructor(t,e,n,s){this.isReverse=s,this.nodeStack=[];let r=1;for(;!t.isEmpty();)if(r=e?n(t.key,e):1,e&&s&&(r*=-1),r<0)t=this.isReverse?t.left:t.right;else{if(0===r){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}getNext(){let t=this.nodeStack.pop();const e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}}}class qr{constructor(t,e,n,s,r){this.key=t,this.value=e,this.color=null!=n?n:qr.RED,this.left=null!=s?s:qr.EMPTY,this.right=null!=r?r:qr.EMPTY,this.size=this.left.size+1+this.right.size}copy(t,e,n,s,r){return new qr(null!=t?t:this.key,null!=e?e:this.value,null!=n?n:this.color,null!=s?s:this.left,null!=r?r:this.right)}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,e,n){let s=this;const r=n(t,s.key);return s=r<0?s.copy(null,null,null,s.left.insert(t,e,n),null):0===r?s.copy(null,e,null,null,null):s.copy(null,null,null,null,s.right.insert(t,e,n)),s.fixUp()}removeMin(){if(this.left.isEmpty())return qr.EMPTY;let t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),t=t.copy(null,null,null,t.left.removeMin(),null),t.fixUp()}remove(t,e){let n,s=this;if(e(t,s.key)<0)s.left.isEmpty()||s.left.isRed()||s.left.left.isRed()||(s=s.moveRedLeft()),s=s.copy(null,null,null,s.left.remove(t,e),null);else{if(s.left.isRed()&&(s=s.rotateRight()),s.right.isEmpty()||s.right.isRed()||s.right.left.isRed()||(s=s.moveRedRight()),0===e(t,s.key)){if(s.right.isEmpty())return qr.EMPTY;n=s.right.min(),s=s.copy(n.key,n.value,null,null,s.right.removeMin())}s=s.copy(null,null,null,null,s.right.remove(t,e))}return s.fixUp()}isRed(){return this.color}fixUp(){let t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t}moveRedLeft(){let t=this.colorFlip();return t.right.left.isRed()&&(t=t.copy(null,null,null,null,t.right.rotateRight()),t=t.rotateLeft(),t=t.colorFlip()),t}moveRedRight(){let t=this.colorFlip();return t.left.left.isRed()&&(t=t.rotateRight(),t=t.colorFlip()),t}rotateLeft(){const t=this.copy(null,null,qr.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight(){const t=this.copy(null,null,qr.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip(){const t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)}checkMaxDepth(){const t=this.check();return Math.pow(2,t)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw Os();if(this.right.isRed())throw Os();const t=this.left.check();if(t!==this.right.check())throw Os();return t+(this.isRed()?0:1)}}qr.EMPTY=null,qr.RED=!0,qr.BLACK=!1,qr.EMPTY=new class{constructor(){this.size=0}get key(){throw Os()}get value(){throw Os()}get color(){throw Os()}get left(){throw Os()}get right(){throw Os()}copy(t,e,n,s,r){return this}insert(t,e,n){return new qr(t,e)}remove(t,e){return this}isEmpty(){return!0}inorderTraversal(t){return!1}reverseTraversal(t){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class Gr{constructor(t){this.comparator=t,this.data=new Br(this.comparator)}has(t){return null!==this.data.get(t)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(t){return this.data.indexOf(t)}forEach(t){this.data.inorderTraversal(((e,n)=>(t(e),!1)))}forEachInRange(t,e){const n=this.data.getIteratorFrom(t[0]);for(;n.hasNext();){const s=n.getNext();if(this.comparator(s.key,t[1])>=0)return;e(s.key)}}forEachWhile(t,e){let n;for(n=void 0!==e?this.data.getIteratorFrom(e):this.data.getIterator();n.hasNext();)if(!t(n.getNext().key))return}firstAfterOrEqual(t){const e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null}getIterator(){return new Kr(this.data.getIterator())}getIteratorFrom(t){return new Kr(this.data.getIteratorFrom(t))}add(t){return this.copy(this.data.remove(t).insert(t,!0))}delete(t){return this.has(t)?this.copy(this.data.remove(t)):this}isEmpty(){return this.data.isEmpty()}unionWith(t){let e=this;return e.size<t.size&&(e=t,t=this),t.forEach((t=>{e=e.add(t)})),e}isEqual(t){if(!(t instanceof Gr))return!1;if(this.size!==t.size)return!1;const e=this.data.getIterator(),n=t.data.getIterator();for(;e.hasNext();){const t=e.getNext().key,s=n.getNext().key;if(0!==this.comparator(t,s))return!1}return!0}toArray(){const t=[];return this.forEach((e=>{t.push(e)})),t}toString(){const t=[];return this.forEach((e=>t.push(e))),"SortedSet("+t.toString()+")"}copy(t){const e=new Gr(this.comparator);return e.data=t,e}}class Kr{constructor(t){this.iter=t}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function jr(t){return t.hasNext()?t.getNext():void 0}class $r{constructor(t){this.fields=t,t.sort(ar.comparator)}static empty(){return new $r([])}unionWith(t){let e=new Gr(ar.comparator);for(const t of this.fields)e=e.add(t);for(const n of t)e=e.add(n);return new $r(e.toArray())}covers(t){for(const e of this.fields)if(e.isPrefixOf(t))return!0;return!1}isEqual(t){return tr(this.fields,t.fields,((t,e)=>t.isEqual(e)))}}function zr(){return"undefined"!=typeof atob}class Qr{constructor(t){this.binaryString=t}static fromBase64String(t){const e=atob(t);return new Qr(e)}static fromUint8Array(t){const e=function(t){let e="";for(let n=0;n<t.length;++n)e+=String.fromCharCode(t[n]);return e}(t);return new Qr(e)}[Symbol.iterator](){let t=0;return{next:()=>t<this.binaryString.length?{value:this.binaryString.charCodeAt(t++),done:!1}:{value:void 0,done:!0}}}toBase64(){return t=this.binaryString,btoa(t);var t}toUint8Array(){return function(t){const e=new Uint8Array(t.length);for(let n=0;n<t.length;n++)e[n]=t.charCodeAt(n);return e}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(t){return Zs(this.binaryString,t.binaryString)}isEqual(t){return this.binaryString===t.binaryString}}Qr.EMPTY_BYTE_STRING=new Qr("");const Hr=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Wr(t){if(Vs(!!t),"string"==typeof t){let e=0;const n=Hr.exec(t);if(Vs(!!n),n[1]){let t=n[1];t=(t+"000000000").substr(0,9),e=Number(t)}const s=new Date(t);return{seconds:Math.floor(s.getTime()/1e3),nanos:e}}return{seconds:Yr(t.seconds),nanos:Yr(t.nanos)}}function Yr(t){return"number"==typeof t?t:"string"==typeof t?Number(t):0}function Xr(t){return"string"==typeof t?Qr.fromBase64String(t):Qr.fromUint8Array(t)}function Jr(t){var e,n;return"server_timestamp"===(null===(n=((null===(e=null==t?void 0:t.mapValue)||void 0===e?void 0:e.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function Zr(t){const e=t.mapValue.fields.__previous_value__;return Jr(e)?Zr(e):e}function ti(t){const e=Wr(t.mapValue.fields.__local_write_time__.timestampValue);return new nr(e.seconds,e.nanos)}class ei{constructor(t,e,n,s,r,i,o,a){this.databaseId=t,this.appId=e,this.persistenceKey=n,this.host=s,this.ssl=r,this.forceLongPolling=i,this.autoDetectLongPolling=o,this.useFetchStreams=a}}class ni{constructor(t,e){this.projectId=t,this.database=e||"(default)"}static empty(){return new ni("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(t){return t instanceof ni&&t.projectId===this.projectId&&t.database===this.database}}function si(t){return null==t}function ri(t){return 0===t&&1/t==-1/0}function ii(t){return"number"==typeof t&&Number.isInteger(t)&&!ri(t)&&t<=Number.MAX_SAFE_INTEGER&&t>=Number.MIN_SAFE_INTEGER}const oi={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},ai={nullValue:"NULL_VALUE"};function ui(t){return"nullValue"in t?0:"booleanValue"in t?1:"integerValue"in t||"doubleValue"in t?2:"timestampValue"in t?3:"stringValue"in t?5:"bytesValue"in t?6:"referenceValue"in t?7:"geoPointValue"in t?8:"arrayValue"in t?9:"mapValue"in t?Jr(t)?4:Ei(t)?9007199254740991:10:Os()}function ci(t,e){if(t===e)return!0;const n=ui(t);if(n!==ui(e))return!1;switch(n){case 0:case 9007199254740991:return!0;case 1:return t.booleanValue===e.booleanValue;case 4:return ti(t).isEqual(ti(e));case 3:return function(t,e){if("string"==typeof t.timestampValue&&"string"==typeof e.timestampValue&&t.timestampValue.length===e.timestampValue.length)return t.timestampValue===e.timestampValue;const n=Wr(t.timestampValue),s=Wr(e.timestampValue);return n.seconds===s.seconds&&n.nanos===s.nanos}(t,e);case 5:return t.stringValue===e.stringValue;case 6:return function(t,e){return Xr(t.bytesValue).isEqual(Xr(e.bytesValue))}(t,e);case 7:return t.referenceValue===e.referenceValue;case 8:return function(t,e){return Yr(t.geoPointValue.latitude)===Yr(e.geoPointValue.latitude)&&Yr(t.geoPointValue.longitude)===Yr(e.geoPointValue.longitude)}(t,e);case 2:return function(t,e){if("integerValue"in t&&"integerValue"in e)return Yr(t.integerValue)===Yr(e.integerValue);if("doubleValue"in t&&"doubleValue"in e){const n=Yr(t.doubleValue),s=Yr(e.doubleValue);return n===s?ri(n)===ri(s):isNaN(n)&&isNaN(s)}return!1}(t,e);case 9:return tr(t.arrayValue.values||[],e.arrayValue.values||[],ci);case 10:return function(t,e){const n=t.mapValue.fields||{},s=e.mapValue.fields||{};if(Vr(n)!==Vr(s))return!1;for(const t in n)if(n.hasOwnProperty(t)&&(void 0===s[t]||!ci(n[t],s[t])))return!1;return!0}(t,e);default:return Os()}}function hi(t,e){return void 0!==(t.values||[]).find((t=>ci(t,e)))}function li(t,e){if(t===e)return 0;const n=ui(t),s=ui(e);if(n!==s)return Zs(n,s);switch(n){case 0:case 9007199254740991:return 0;case 1:return Zs(t.booleanValue,e.booleanValue);case 2:return function(t,e){const n=Yr(t.integerValue||t.doubleValue),s=Yr(e.integerValue||e.doubleValue);return n<s?-1:n>s?1:n===s?0:isNaN(n)?isNaN(s)?0:-1:1}(t,e);case 3:return di(t.timestampValue,e.timestampValue);case 4:return di(ti(t),ti(e));case 5:return Zs(t.stringValue,e.stringValue);case 6:return function(t,e){const n=Xr(t),s=Xr(e);return n.compareTo(s)}(t.bytesValue,e.bytesValue);case 7:return function(t,e){const n=t.split("/"),s=e.split("/");for(let t=0;t<n.length&&t<s.length;t++){const e=Zs(n[t],s[t]);if(0!==e)return e}return Zs(n.length,s.length)}(t.referenceValue,e.referenceValue);case 8:return function(t,e){const n=Zs(Yr(t.latitude),Yr(e.latitude));return 0!==n?n:Zs(Yr(t.longitude),Yr(e.longitude))}(t.geoPointValue,e.geoPointValue);case 9:return function(t,e){const n=t.values||[],s=e.values||[];for(let t=0;t<n.length&&t<s.length;++t){const e=li(n[t],s[t]);if(e)return e}return Zs(n.length,s.length)}(t.arrayValue,e.arrayValue);case 10:return function(t,e){if(t===oi.mapValue&&e===oi.mapValue)return 0;if(t===oi.mapValue)return 1;if(e===oi.mapValue)return-1;const n=t.fields||{},s=Object.keys(n),r=e.fields||{},i=Object.keys(r);s.sort(),i.sort();for(let t=0;t<s.length&&t<i.length;++t){const e=Zs(s[t],i[t]);if(0!==e)return e;const o=li(n[s[t]],r[i[t]]);if(0!==o)return o}return Zs(s.length,i.length)}(t.mapValue,e.mapValue);default:throw Os()}}function di(t,e){if("string"==typeof t&&"string"==typeof e&&t.length===e.length)return Zs(t,e);const n=Wr(t),s=Wr(e),r=Zs(n.seconds,s.seconds);return 0!==r?r:Zs(n.nanos,s.nanos)}function fi(t){return mi(t)}function mi(t){return"nullValue"in t?"null":"booleanValue"in t?""+t.booleanValue:"integerValue"in t?""+t.integerValue:"doubleValue"in t?""+t.doubleValue:"timestampValue"in t?function(t){const e=Wr(t);return`time(${e.seconds},${e.nanos})`}(t.timestampValue):"stringValue"in t?t.stringValue:"bytesValue"in t?Xr(t.bytesValue).toBase64():"referenceValue"in t?(n=t.referenceValue,ur.fromName(n).toString()):"geoPointValue"in t?`geo(${(e=t.geoPointValue).latitude},${e.longitude})`:"arrayValue"in t?function(t){let e="[",n=!0;for(const s of t.values||[])n?n=!1:e+=",",e+=mi(s);return e+"]"}(t.arrayValue):"mapValue"in t?function(t){const e=Object.keys(t.fields||{}).sort();let n="{",s=!0;for(const r of e)s?s=!1:n+=",",n+=`${r}:${mi(t.fields[r])}`;return n+"}"}(t.mapValue):Os();var e,n}function gi(t,e){return{referenceValue:`projects/${t.projectId}/databases/${t.database}/documents/${e.path.canonicalString()}`}}function pi(t){return!!t&&"integerValue"in t}function yi(t){return!!t&&"arrayValue"in t}function wi(t){return!!t&&"nullValue"in t}function vi(t){return!!t&&"doubleValue"in t&&isNaN(Number(t.doubleValue))}function Ii(t){return!!t&&"mapValue"in t}function bi(t){if(t.geoPointValue)return{geoPointValue:Object.assign({},t.geoPointValue)};if(t.timestampValue&&"object"==typeof t.timestampValue)return{timestampValue:Object.assign({},t.timestampValue)};if(t.mapValue){const e={mapValue:{fields:{}}};return Fr(t.mapValue.fields,((t,n)=>e.mapValue.fields[t]=bi(n))),e}if(t.arrayValue){const e={arrayValue:{values:[]}};for(let n=0;n<(t.arrayValue.values||[]).length;++n)e.arrayValue.values[n]=bi(t.arrayValue.values[n]);return e}return Object.assign({},t)}function Ei(t){return"__max__"===(((t.mapValue||{}).fields||{}).__type__||{}).stringValue}function Ti(t){return"nullValue"in t?ai:"booleanValue"in t?{booleanValue:!1}:"integerValue"in t||"doubleValue"in t?{doubleValue:NaN}:"timestampValue"in t?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in t?{stringValue:""}:"bytesValue"in t?{bytesValue:""}:"referenceValue"in t?gi(ni.empty(),ur.empty()):"geoPointValue"in t?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in t?{arrayValue:{}}:"mapValue"in t?{mapValue:{}}:Os()}function Si(t){return"nullValue"in t?{booleanValue:!1}:"booleanValue"in t?{doubleValue:NaN}:"integerValue"in t||"doubleValue"in t?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in t?{stringValue:""}:"stringValue"in t?{bytesValue:""}:"bytesValue"in t?gi(ni.empty(),ur.empty()):"referenceValue"in t?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in t?{arrayValue:{}}:"arrayValue"in t?{mapValue:{}}:"mapValue"in t?oi:Os()}function xi(t,e){const n=li(t.value,e.value);return 0!==n?n:t.inclusive&&!e.inclusive?-1:!t.inclusive&&e.inclusive?1:0}function Di(t,e){const n=li(t.value,e.value);return 0!==n?n:t.inclusive&&!e.inclusive?1:!t.inclusive&&e.inclusive?-1:0}class _i{constructor(t){this.value=t}static empty(){return new _i({mapValue:{}})}field(t){if(t.isEmpty())return this.value;{let e=this.value;for(let n=0;n<t.length-1;++n)if(e=(e.mapValue.fields||{})[t.get(n)],!Ii(e))return null;return e=(e.mapValue.fields||{})[t.lastSegment()],e||null}}set(t,e){this.getFieldsMap(t.popLast())[t.lastSegment()]=bi(e)}setAll(t){let e=ar.emptyPath(),n={},s=[];t.forEach(((t,r)=>{if(!e.isImmediateParentOf(r)){const t=this.getFieldsMap(e);this.applyChanges(t,n,s),n={},s=[],e=r.popLast()}t?n[r.lastSegment()]=bi(t):s.push(r.lastSegment())}));const r=this.getFieldsMap(e);this.applyChanges(r,n,s)}delete(t){const e=this.field(t.popLast());Ii(e)&&e.mapValue.fields&&delete e.mapValue.fields[t.lastSegment()]}isEqual(t){return ci(this.value,t.value)}getFieldsMap(t){let e=this.value;e.mapValue.fields||(e.mapValue={fields:{}});for(let n=0;n<t.length;++n){let s=e.mapValue.fields[t.get(n)];Ii(s)&&s.mapValue.fields||(s={mapValue:{fields:{}}},e.mapValue.fields[t.get(n)]=s),e=s}return e.mapValue.fields}applyChanges(t,e,n){Fr(e,((e,n)=>t[e]=n));for(const e of n)delete t[e]}clone(){return new _i(bi(this.value))}}function Ai(t){const e=[];return Fr(t.fields,((t,n)=>{const s=new ar([t]);if(Ii(n)){const t=Ai(n.mapValue).fields;if(0===t.length)e.push(s);else for(const n of t)e.push(s.child(n))}else e.push(s)})),new $r(e)}class Ci{constructor(t,e,n,s,r,i){this.key=t,this.documentType=e,this.version=n,this.readTime=s,this.data=r,this.documentState=i}static newInvalidDocument(t){return new Ci(t,0,sr.min(),sr.min(),_i.empty(),0)}static newFoundDocument(t,e,n){return new Ci(t,1,e,sr.min(),n,0)}static newNoDocument(t,e){return new Ci(t,2,e,sr.min(),_i.empty(),0)}static newUnknownDocument(t,e){return new Ci(t,3,e,sr.min(),_i.empty(),2)}convertToFoundDocument(t,e){return this.version=t,this.documentType=1,this.data=e,this.documentState=0,this}convertToNoDocument(t){return this.version=t,this.documentType=2,this.data=_i.empty(),this.documentState=0,this}convertToUnknownDocument(t){return this.version=t,this.documentType=3,this.data=_i.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=sr.min(),this}setReadTime(t){return this.readTime=t,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(t){return t instanceof Ci&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.documentType===t.documentType&&this.documentState===t.documentState&&this.data.isEqual(t.data)}mutableCopy(){return new Ci(this.key,this.documentType,this.version,this.readTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Ni{constructor(t,e=null,n=[],s=[],r=null,i=null,o=null){this.path=t,this.collectionGroup=e,this.orderBy=n,this.filters=s,this.limit=r,this.startAt=i,this.endAt=o,this.ht=null}}function ki(t,e=null,n=[],s=[],r=null,i=null,o=null){return new Ni(t,e,n,s,r,i,o)}function Ri(t){const e=Ps(t);if(null===e.ht){let t=e.path.canonicalString();null!==e.collectionGroup&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map((t=>{return(e=t).field.canonicalString()+e.op.toString()+fi(e.value);var e})).join(","),t+="|ob:",t+=e.orderBy.map((t=>function(t){return t.field.canonicalString()+t.dir}(t))).join(","),si(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map((t=>fi(t))).join(",")),e.endAt&&(t+="|ub:",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map((t=>fi(t))).join(",")),e.ht=t}return e.ht}function Li(t,e){if(t.limit!==e.limit)return!1;if(t.orderBy.length!==e.orderBy.length)return!1;for(let n=0;n<t.orderBy.length;n++)if(!Wi(t.orderBy[n],e.orderBy[n]))return!1;if(t.filters.length!==e.filters.length)return!1;for(let r=0;r<t.filters.length;r++)if(n=t.filters[r],s=e.filters[r],n.op!==s.op||!n.field.isEqual(s.field)||!ci(n.value,s.value))return!1;var n,s;return t.collectionGroup===e.collectionGroup&&!!t.path.isEqual(e.path)&&!!Xi(t.startAt,e.startAt)&&Xi(t.endAt,e.endAt)}function Mi(t){return ur.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}function Oi(t,e){return t.filters.filter((t=>t instanceof Pi&&t.field.isEqual(e)))}function Vi(t,e,n){let s=ai,r=!0;for(const n of Oi(t,e)){let t=ai,e=!0;switch(n.op){case"<":case"<=":t=Ti(n.value);break;case"==":case"in":case">=":t=n.value;break;case">":t=n.value,e=!1;break;case"!=":case"not-in":t=ai}xi({value:s,inclusive:r},{value:t,inclusive:e})<0&&(s=t,r=e)}if(null!==n)for(let i=0;i<t.orderBy.length;++i)if(t.orderBy[i].field.isEqual(e)){const t=n.position[i];xi({value:s,inclusive:r},{value:t,inclusive:n.inclusive})<0&&(s=t,r=n.inclusive);break}return{value:s,inclusive:r}}function Fi(t,e,n){let s=oi,r=!0;for(const n of Oi(t,e)){let t=oi,e=!0;switch(n.op){case">=":case">":t=Si(n.value),e=!1;break;case"==":case"in":case"<=":t=n.value;break;case"<":t=n.value,e=!1;break;case"!=":case"not-in":t=oi}Di({value:s,inclusive:r},{value:t,inclusive:e})>0&&(s=t,r=e)}if(null!==n)for(let i=0;i<t.orderBy.length;++i)if(t.orderBy[i].field.isEqual(e)){const t=n.position[i];Di({value:s,inclusive:r},{value:t,inclusive:n.inclusive})>0&&(s=t,r=n.inclusive);break}return{value:s,inclusive:r}}class Pi extends class{}{constructor(t,e,n){super(),this.field=t,this.op=e,this.value=n}static create(t,e,n){return t.isKeyField()?"in"===e||"not-in"===e?this.lt(t,e,n):new Bi(t,e,n):"array-contains"===e?new Ki(t,n):"in"===e?new ji(t,n):"not-in"===e?new $i(t,n):"array-contains-any"===e?new zi(t,n):new Pi(t,e,n)}static lt(t,e,n){return"in"===e?new Ui(t,n):new qi(t,n)}matches(t){const e=t.data.field(this.field);return"!="===this.op?null!==e&&this.ft(li(e,this.value)):null!==e&&ui(this.value)===ui(e)&&this.ft(li(e,this.value))}ft(t){switch(this.op){case"<":return t<0;case"<=":return t<=0;case"==":return 0===t;case"!=":return 0!==t;case">":return t>0;case">=":return t>=0;default:return Os()}}dt(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}}class Bi extends Pi{constructor(t,e,n){super(t,e,n),this.key=ur.fromName(n.referenceValue)}matches(t){const e=ur.comparator(t.key,this.key);return this.ft(e)}}class Ui extends Pi{constructor(t,e){super(t,"in",e),this.keys=Gi("in",e)}matches(t){return this.keys.some((e=>e.isEqual(t.key)))}}class qi extends Pi{constructor(t,e){super(t,"not-in",e),this.keys=Gi("not-in",e)}matches(t){return!this.keys.some((e=>e.isEqual(t.key)))}}function Gi(t,e){var n;return((null===(n=e.arrayValue)||void 0===n?void 0:n.values)||[]).map((t=>ur.fromName(t.referenceValue)))}class Ki extends Pi{constructor(t,e){super(t,"array-contains",e)}matches(t){const e=t.data.field(this.field);return yi(e)&&hi(e.arrayValue,this.value)}}class ji extends Pi{constructor(t,e){super(t,"in",e)}matches(t){const e=t.data.field(this.field);return null!==e&&hi(this.value.arrayValue,e)}}class $i extends Pi{constructor(t,e){super(t,"not-in",e)}matches(t){if(hi(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const e=t.data.field(this.field);return null!==e&&!hi(this.value.arrayValue,e)}}class zi extends Pi{constructor(t,e){super(t,"array-contains-any",e)}matches(t){const e=t.data.field(this.field);return!(!yi(e)||!e.arrayValue.values)&&e.arrayValue.values.some((t=>hi(this.value.arrayValue,t)))}}class Qi{constructor(t,e){this.position=t,this.inclusive=e}}class Hi{constructor(t,e="asc"){this.field=t,this.dir=e}}function Wi(t,e){return t.dir===e.dir&&t.field.isEqual(e.field)}function Yi(t,e,n){let s=0;for(let r=0;r<t.position.length;r++){const i=e[r],o=t.position[r];if(s=i.field.isKeyField()?ur.comparator(ur.fromName(o.referenceValue),n.key):li(o,n.data.field(i.field)),"desc"===i.dir&&(s*=-1),0!==s)break}return s}function Xi(t,e){if(null===t)return null===e;if(null===e)return!1;if(t.inclusive!==e.inclusive||t.position.length!==e.position.length)return!1;for(let n=0;n<t.position.length;n++)if(!ci(t.position[n],e.position[n]))return!1;return!0}class Ji{constructor(t,e=null,n=[],s=[],r=null,i="F",o=null,a=null){this.path=t,this.collectionGroup=e,this.explicitOrderBy=n,this.filters=s,this.limit=r,this.limitType=i,this.startAt=o,this.endAt=a,this._t=null,this.wt=null,this.startAt,this.endAt}}function Zi(t,e,n,s,r,i,o,a){return new Ji(t,e,n,s,r,i,o,a)}function to(t){return new Ji(t)}function eo(t){return 0===t.filters.length&&null===t.limit&&null==t.startAt&&null==t.endAt&&(0===t.explicitOrderBy.length||1===t.explicitOrderBy.length&&t.explicitOrderBy[0].field.isKeyField())}function no(t){return t.explicitOrderBy.length>0?t.explicitOrderBy[0].field:null}function so(t){for(const e of t.filters)if(e.dt())return e.field;return null}function ro(t){return null!==t.collectionGroup}function io(t){const e=Ps(t);if(null===e._t){e._t=[];const t=so(e),n=no(e);if(null!==t&&null===n)t.isKeyField()||e._t.push(new Hi(t)),e._t.push(new Hi(ar.keyField(),"asc"));else{let t=!1;for(const n of e.explicitOrderBy)e._t.push(n),n.field.isKeyField()&&(t=!0);if(!t){const t=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc";e._t.push(new Hi(ar.keyField(),t))}}}return e._t}function oo(t){const e=Ps(t);if(!e.wt)if("F"===e.limitType)e.wt=ki(e.path,e.collectionGroup,io(e),e.filters,e.limit,e.startAt,e.endAt);else{const t=[];for(const n of io(e)){const e="desc"===n.dir?"asc":"desc";t.push(new Hi(n.field,e))}const n=e.endAt?new Qi(e.endAt.position,e.endAt.inclusive):null,s=e.startAt?new Qi(e.startAt.position,e.startAt.inclusive):null;e.wt=ki(e.path,e.collectionGroup,t,e.filters,e.limit,n,s)}return e.wt}function ao(t,e,n){return new Ji(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),e,n,t.startAt,t.endAt)}function uo(t,e){return Li(oo(t),oo(e))&&t.limitType===e.limitType}function co(t){return`${Ri(oo(t))}|lt:${t.limitType}`}function ho(t){return`Query(target=${function(t){let e=t.path.canonicalString();return null!==t.collectionGroup&&(e+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(e+=`, filters: [${t.filters.map((t=>{return`${(e=t).field.canonicalString()} ${e.op} ${fi(e.value)}`;var e})).join(", ")}]`),si(t.limit)||(e+=", limit: "+t.limit),t.orderBy.length>0&&(e+=`, orderBy: [${t.orderBy.map((t=>function(t){return`${t.field.canonicalString()} (${t.dir})`}(t))).join(", ")}]`),t.startAt&&(e+=", startAt: ",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map((t=>fi(t))).join(",")),t.endAt&&(e+=", endAt: ",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map((t=>fi(t))).join(",")),`Target(${e})`}(oo(t))}; limitType=${t.limitType})`}function lo(t,e){return e.isFoundDocument()&&function(t,e){const n=e.key.path;return null!==t.collectionGroup?e.key.hasCollectionId(t.collectionGroup)&&t.path.isPrefixOf(n):ur.isDocumentKey(t.path)?t.path.isEqual(n):t.path.isImmediateParentOf(n)}(t,e)&&function(t,e){for(const n of t.explicitOrderBy)if(!n.field.isKeyField()&&null===e.data.field(n.field))return!1;return!0}(t,e)&&function(t,e){for(const n of t.filters)if(!n.matches(e))return!1;return!0}(t,e)&&function(t,e){return!(t.startAt&&!function(t,e,n){const s=Yi(t,e,n);return t.inclusive?s<=0:s<0}(t.startAt,io(t),e))&&!(t.endAt&&!function(t,e,n){const s=Yi(t,e,n);return t.inclusive?s>=0:s>0}(t.endAt,io(t),e))}(t,e)}function fo(t){return t.collectionGroup||(t.path.length%2==1?t.path.lastSegment():t.path.get(t.path.length-2))}function mo(t){return(e,n)=>{let s=!1;for(const r of io(t)){const t=go(r,e,n);if(0!==t)return t;s=s||r.field.isKeyField()}return 0}}function go(t,e,n){const s=t.field.isKeyField()?ur.comparator(e.key,n.key):function(t,e,n){const s=e.data.field(t),r=n.data.field(t);return null!==s&&null!==r?li(s,r):Os()}(t.field,e,n);switch(t.dir){case"asc":return s;case"desc":return-1*s;default:return Os()}}function po(t,e){if(t.gt){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:ri(e)?"-0":e}}function yo(t){return{integerValue:""+t}}function wo(t,e){return ii(e)?yo(e):po(t,e)}class vo{constructor(){this._=void 0}}function Io(t,e,n){return t instanceof To?function(t,e){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:t.seconds,nanos:t.nanoseconds}}}};return e&&(n.fields.__previous_value__=e),{mapValue:n}}(n,e):t instanceof So?xo(t,e):t instanceof Do?_o(t,e):function(t,e){const n=Eo(t,e),s=Co(n)+Co(t.yt);return pi(n)&&pi(t.yt)?yo(s):po(t.It,s)}(t,e)}function bo(t,e,n){return t instanceof So?xo(t,e):t instanceof Do?_o(t,e):n}function Eo(t,e){return t instanceof Ao?pi(n=e)||function(t){return!!t&&"doubleValue"in t}(n)?e:{integerValue:0}:null;var n}class To extends vo{}class So extends vo{constructor(t){super(),this.elements=t}}function xo(t,e){const n=No(e);for(const e of t.elements)n.some((t=>ci(t,e)))||n.push(e);return{arrayValue:{values:n}}}class Do extends vo{constructor(t){super(),this.elements=t}}function _o(t,e){let n=No(e);for(const e of t.elements)n=n.filter((t=>!ci(t,e)));return{arrayValue:{values:n}}}class Ao extends vo{constructor(t,e){super(),this.It=t,this.yt=e}}function Co(t){return Yr(t.integerValue||t.doubleValue)}function No(t){return yi(t)&&t.arrayValue.values?t.arrayValue.values.slice():[]}class ko{constructor(t,e){this.field=t,this.transform=e}}class Ro{constructor(t,e){this.version=t,this.transformResults=e}}class Lo{constructor(t,e){this.updateTime=t,this.exists=e}static none(){return new Lo}static exists(t){return new Lo(void 0,t)}static updateTime(t){return new Lo(t)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(t){return this.exists===t.exists&&(this.updateTime?!!t.updateTime&&this.updateTime.isEqual(t.updateTime):!t.updateTime)}}function Mo(t,e){return void 0!==t.updateTime?e.isFoundDocument()&&e.version.isEqual(t.updateTime):void 0===t.exists||t.exists===e.isFoundDocument()}class Oo{}function Vo(t,e){if(!t.hasLocalMutations||e&&0===e.fields.length)return null;if(null===e)return t.isNoDocument()?new zo(t.key,Lo.none()):new qo(t.key,t.data,Lo.none());{const n=t.data,s=_i.empty();let r=new Gr(ar.comparator);for(let t of e.fields)if(!r.has(t)){let e=n.field(t);null===e&&t.length>1&&(t=t.popLast(),e=n.field(t)),null===e?s.delete(t):s.set(t,e),r=r.add(t)}return new Go(t.key,s,new $r(r.toArray()),Lo.none())}}function Fo(t,e,n){t instanceof qo?function(t,e,n){const s=t.value.clone(),r=jo(t.fieldTransforms,e,n.transformResults);s.setAll(r),e.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(t,e,n):t instanceof Go?function(t,e,n){if(!Mo(t.precondition,e))return void e.convertToUnknownDocument(n.version);const s=jo(t.fieldTransforms,e,n.transformResults),r=e.data;r.setAll(Ko(t)),r.setAll(s),e.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(t,e,n):function(t,e,n){e.convertToNoDocument(n.version).setHasCommittedMutations()}(0,e,n)}function Po(t,e,n,s){return t instanceof qo?function(t,e,n,s){if(!Mo(t.precondition,e))return n;const r=t.value.clone(),i=$o(t.fieldTransforms,s,e);return r.setAll(i),e.convertToFoundDocument(e.version,r).setHasLocalMutations(),null}(t,e,n,s):t instanceof Go?function(t,e,n,s){if(!Mo(t.precondition,e))return n;const r=$o(t.fieldTransforms,s,e),i=e.data;return i.setAll(Ko(t)),i.setAll(r),e.convertToFoundDocument(e.version,i).setHasLocalMutations(),null===n?null:n.unionWith(t.fieldMask.fields).unionWith(t.fieldTransforms.map((t=>t.field)))}(t,e,n,s):function(t,e,n){return Mo(t.precondition,e)?(e.convertToNoDocument(e.version).setHasLocalMutations(),null):n}(t,e,n)}function Bo(t,e){let n=null;for(const s of t.fieldTransforms){const t=e.data.field(s.field),r=Eo(s.transform,t||null);null!=r&&(null===n&&(n=_i.empty()),n.set(s.field,r))}return n||null}function Uo(t,e){return t.type===e.type&&!!t.key.isEqual(e.key)&&!!t.precondition.isEqual(e.precondition)&&!!function(t,e){return void 0===t&&void 0===e||!(!t||!e)&&tr(t,e,((t,e)=>function(t,e){return t.field.isEqual(e.field)&&function(t,e){return t instanceof So&&e instanceof So||t instanceof Do&&e instanceof Do?tr(t.elements,e.elements,ci):t instanceof Ao&&e instanceof Ao?ci(t.yt,e.yt):t instanceof To&&e instanceof To}(t.transform,e.transform)}(t,e)))}(t.fieldTransforms,e.fieldTransforms)&&(0===t.type?t.value.isEqual(e.value):1!==t.type||t.data.isEqual(e.data)&&t.fieldMask.isEqual(e.fieldMask))}class qo extends Oo{constructor(t,e,n,s=[]){super(),this.key=t,this.value=e,this.precondition=n,this.fieldTransforms=s,this.type=0}getFieldMask(){return null}}class Go extends Oo{constructor(t,e,n,s,r=[]){super(),this.key=t,this.data=e,this.fieldMask=n,this.precondition=s,this.fieldTransforms=r,this.type=1}getFieldMask(){return this.fieldMask}}function Ko(t){const e=new Map;return t.fieldMask.fields.forEach((n=>{if(!n.isEmpty()){const s=t.data.field(n);e.set(n,s)}})),e}function jo(t,e,n){const s=new Map;Vs(t.length===n.length);for(let r=0;r<n.length;r++){const i=t[r],o=i.transform,a=e.data.field(i.field);s.set(i.field,bo(o,a,n[r]))}return s}function $o(t,e,n){const s=new Map;for(const r of t){const t=r.transform,i=n.data.field(r.field);s.set(r.field,Io(t,i,e))}return s}class zo extends Oo{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class Qo extends Oo{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class Ho{constructor(t){this.count=t}}var Wo,Yo;function Xo(t){switch(t){default:return Os();case Bs.CANCELLED:case Bs.UNKNOWN:case Bs.DEADLINE_EXCEEDED:case Bs.RESOURCE_EXHAUSTED:case Bs.INTERNAL:case Bs.UNAVAILABLE:case Bs.UNAUTHENTICATED:return!1;case Bs.INVALID_ARGUMENT:case Bs.NOT_FOUND:case Bs.ALREADY_EXISTS:case Bs.PERMISSION_DENIED:case Bs.FAILED_PRECONDITION:case Bs.ABORTED:case Bs.OUT_OF_RANGE:case Bs.UNIMPLEMENTED:case Bs.DATA_LOSS:return!0}}function Jo(t){if(void 0===t)return Rs("GRPC error has no .code"),Bs.UNKNOWN;switch(t){case Wo.OK:return Bs.OK;case Wo.CANCELLED:return Bs.CANCELLED;case Wo.UNKNOWN:return Bs.UNKNOWN;case Wo.DEADLINE_EXCEEDED:return Bs.DEADLINE_EXCEEDED;case Wo.RESOURCE_EXHAUSTED:return Bs.RESOURCE_EXHAUSTED;case Wo.INTERNAL:return Bs.INTERNAL;case Wo.UNAVAILABLE:return Bs.UNAVAILABLE;case Wo.UNAUTHENTICATED:return Bs.UNAUTHENTICATED;case Wo.INVALID_ARGUMENT:return Bs.INVALID_ARGUMENT;case Wo.NOT_FOUND:return Bs.NOT_FOUND;case Wo.ALREADY_EXISTS:return Bs.ALREADY_EXISTS;case Wo.PERMISSION_DENIED:return Bs.PERMISSION_DENIED;case Wo.FAILED_PRECONDITION:return Bs.FAILED_PRECONDITION;case Wo.ABORTED:return Bs.ABORTED;case Wo.OUT_OF_RANGE:return Bs.OUT_OF_RANGE;case Wo.UNIMPLEMENTED:return Bs.UNIMPLEMENTED;case Wo.DATA_LOSS:return Bs.DATA_LOSS;default:return Os()}}(Yo=Wo||(Wo={}))[Yo.OK=0]="OK",Yo[Yo.CANCELLED=1]="CANCELLED",Yo[Yo.UNKNOWN=2]="UNKNOWN",Yo[Yo.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",Yo[Yo.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",Yo[Yo.NOT_FOUND=5]="NOT_FOUND",Yo[Yo.ALREADY_EXISTS=6]="ALREADY_EXISTS",Yo[Yo.PERMISSION_DENIED=7]="PERMISSION_DENIED",Yo[Yo.UNAUTHENTICATED=16]="UNAUTHENTICATED",Yo[Yo.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",Yo[Yo.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",Yo[Yo.ABORTED=10]="ABORTED",Yo[Yo.OUT_OF_RANGE=11]="OUT_OF_RANGE",Yo[Yo.UNIMPLEMENTED=12]="UNIMPLEMENTED",Yo[Yo.INTERNAL=13]="INTERNAL",Yo[Yo.UNAVAILABLE=14]="UNAVAILABLE",Yo[Yo.DATA_LOSS=15]="DATA_LOSS";class Zo{constructor(t,e){this.mapKeyFn=t,this.equalsFn=e,this.inner={},this.innerSize=0}get(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0!==n)for(const[e,s]of n)if(this.equalsFn(e,t))return s}has(t){return void 0!==this.get(t)}set(t,e){const n=this.mapKeyFn(t),s=this.inner[n];if(void 0===s)return this.inner[n]=[[t,e]],void this.innerSize++;for(let n=0;n<s.length;n++)if(this.equalsFn(s[n][0],t))return void(s[n]=[t,e]);s.push([t,e]),this.innerSize++}delete(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0===n)return!1;for(let s=0;s<n.length;s++)if(this.equalsFn(n[s][0],t))return 1===n.length?delete this.inner[e]:n.splice(s,1),this.innerSize--,!0;return!1}forEach(t){Fr(this.inner,((e,n)=>{for(const[e,s]of n)t(e,s)}))}isEmpty(){return Pr(this.inner)}size(){return this.innerSize}}const ta=new Br(ur.comparator);function ea(){return ta}const na=new Br(ur.comparator);function sa(...t){let e=na;for(const n of t)e=e.insert(n.key,n);return e}function ra(t){let e=na;return t.forEach(((t,n)=>e=e.insert(t,n.overlayedDocument))),e}function ia(){return aa()}function oa(){return aa()}function aa(){return new Zo((t=>t.toString()),((t,e)=>t.isEqual(e)))}const ua=new Br(ur.comparator),ca=new Gr(ur.comparator);function ha(...t){let e=ca;for(const n of t)e=e.add(n);return e}const la=new Gr(Zs);function da(){return la}class fa{constructor(t,e,n,s,r){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=n,this.documentUpdates=s,this.resolvedLimboDocuments=r}static createSynthesizedRemoteEventForCurrentChange(t,e){const n=new Map;return n.set(t,ma.createSynthesizedTargetChangeForCurrentChange(t,e)),new fa(sr.min(),n,da(),ea(),ha())}}class ma{constructor(t,e,n,s,r){this.resumeToken=t,this.current=e,this.addedDocuments=n,this.modifiedDocuments=s,this.removedDocuments=r}static createSynthesizedTargetChangeForCurrentChange(t,e){return new ma(Qr.EMPTY_BYTE_STRING,e,ha(),ha(),ha())}}class ga{constructor(t,e,n,s){this.Tt=t,this.removedTargetIds=e,this.key=n,this.Et=s}}class pa{constructor(t,e){this.targetId=t,this.At=e}}class ya{constructor(t,e,n=Qr.EMPTY_BYTE_STRING,s=null){this.state=t,this.targetIds=e,this.resumeToken=n,this.cause=s}}class wa{constructor(){this.Rt=0,this.bt=ba(),this.Pt=Qr.EMPTY_BYTE_STRING,this.vt=!1,this.Vt=!0}get current(){return this.vt}get resumeToken(){return this.Pt}get St(){return 0!==this.Rt}get Dt(){return this.Vt}Ct(t){t.approximateByteSize()>0&&(this.Vt=!0,this.Pt=t)}xt(){let t=ha(),e=ha(),n=ha();return this.bt.forEach(((s,r)=>{switch(r){case 0:t=t.add(s);break;case 2:e=e.add(s);break;case 1:n=n.add(s);break;default:Os()}})),new ma(this.Pt,this.vt,t,e,n)}Nt(){this.Vt=!1,this.bt=ba()}kt(t,e){this.Vt=!0,this.bt=this.bt.insert(t,e)}Mt(t){this.Vt=!0,this.bt=this.bt.remove(t)}Ot(){this.Rt+=1}Ft(){this.Rt-=1}$t(){this.Vt=!0,this.vt=!0}}class va{constructor(t){this.Bt=t,this.Lt=new Map,this.Ut=ea(),this.qt=Ia(),this.Kt=new Gr(Zs)}Gt(t){for(const e of t.Tt)t.Et&&t.Et.isFoundDocument()?this.Qt(e,t.Et):this.jt(e,t.key,t.Et);for(const e of t.removedTargetIds)this.jt(e,t.key,t.Et)}Wt(t){this.forEachTarget(t,(e=>{const n=this.zt(e);switch(t.state){case 0:this.Ht(e)&&n.Ct(t.resumeToken);break;case 1:n.Ft(),n.St||n.Nt(),n.Ct(t.resumeToken);break;case 2:n.Ft(),n.St||this.removeTarget(e);break;case 3:this.Ht(e)&&(n.$t(),n.Ct(t.resumeToken));break;case 4:this.Ht(e)&&(this.Jt(e),n.Ct(t.resumeToken));break;default:Os()}}))}forEachTarget(t,e){t.targetIds.length>0?t.targetIds.forEach(e):this.Lt.forEach(((t,n)=>{this.Ht(n)&&e(n)}))}Yt(t){const e=t.targetId,n=t.At.count,s=this.Xt(e);if(s){const t=s.target;if(Mi(t))if(0===n){const n=new ur(t.path);this.jt(e,n,Ci.newNoDocument(n,sr.min()))}else Vs(1===n);else this.Zt(e)!==n&&(this.Jt(e),this.Kt=this.Kt.add(e))}}te(t){const e=new Map;this.Lt.forEach(((n,s)=>{const r=this.Xt(s);if(r){if(n.current&&Mi(r.target)){const e=new ur(r.target.path);null!==this.Ut.get(e)||this.ee(s,e)||this.jt(s,e,Ci.newNoDocument(e,t))}n.Dt&&(e.set(s,n.xt()),n.Nt())}}));let n=ha();this.qt.forEach(((t,e)=>{let s=!0;e.forEachWhile((t=>{const e=this.Xt(t);return!e||2===e.purpose||(s=!1,!1)})),s&&(n=n.add(t))})),this.Ut.forEach(((e,n)=>n.setReadTime(t)));const s=new fa(t,e,this.Kt,this.Ut,n);return this.Ut=ea(),this.qt=Ia(),this.Kt=new Gr(Zs),s}Qt(t,e){if(!this.Ht(t))return;const n=this.ee(t,e.key)?2:0;this.zt(t).kt(e.key,n),this.Ut=this.Ut.insert(e.key,e),this.qt=this.qt.insert(e.key,this.ne(e.key).add(t))}jt(t,e,n){if(!this.Ht(t))return;const s=this.zt(t);this.ee(t,e)?s.kt(e,1):s.Mt(e),this.qt=this.qt.insert(e,this.ne(e).delete(t)),n&&(this.Ut=this.Ut.insert(e,n))}removeTarget(t){this.Lt.delete(t)}Zt(t){const e=this.zt(t).xt();return this.Bt.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size}Ot(t){this.zt(t).Ot()}zt(t){let e=this.Lt.get(t);return e||(e=new wa,this.Lt.set(t,e)),e}ne(t){let e=this.qt.get(t);return e||(e=new Gr(Zs),this.qt=this.qt.insert(t,e)),e}Ht(t){const e=null!==this.Xt(t);return e||ks("WatchChangeAggregator","Detected inactive target",t),e}Xt(t){const e=this.Lt.get(t);return e&&e.St?null:this.Bt.se(t)}Jt(t){this.Lt.set(t,new wa),this.Bt.getRemoteKeysForTarget(t).forEach((e=>{this.jt(t,e,null)}))}ee(t,e){return this.Bt.getRemoteKeysForTarget(t).has(e)}}function Ia(){return new Br(ur.comparator)}function ba(){return new Br(ur.comparator)}const Ea={asc:"ASCENDING",desc:"DESCENDING"},Ta={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"};class Sa{constructor(t,e){this.databaseId=t,this.gt=e}}function xa(t,e){return t.gt?`${new Date(1e3*e.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+e.nanoseconds).slice(-9)}Z`:{seconds:""+e.seconds,nanos:e.nanoseconds}}function Da(t,e){return t.gt?e.toBase64():e.toUint8Array()}function _a(t,e){return xa(t,e.toTimestamp())}function Aa(t){return Vs(!!t),sr.fromTimestamp(function(t){const e=Wr(t);return new nr(e.seconds,e.nanos)}(t))}function Ca(t,e){return function(t){return new ir(["projects",t.projectId,"databases",t.database])}(t).child("documents").child(e).canonicalString()}function Na(t){const e=ir.fromString(t);return Vs(Ja(e)),e}function ka(t,e){return Ca(t.databaseId,e.path)}function Ra(t,e){const n=Na(e);if(n.get(1)!==t.databaseId.projectId)throw new Us(Bs.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+t.databaseId.projectId);if(n.get(3)!==t.databaseId.database)throw new Us(Bs.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+t.databaseId.database);return new ur(Va(n))}function La(t,e){return Ca(t.databaseId,e)}function Ma(t){const e=Na(t);return 4===e.length?ir.emptyPath():Va(e)}function Oa(t){return new ir(["projects",t.databaseId.projectId,"databases",t.databaseId.database]).canonicalString()}function Va(t){return Vs(t.length>4&&"documents"===t.get(4)),t.popFirst(5)}function Fa(t,e,n){return{name:ka(t,e),fields:n.value.mapValue.fields}}function Pa(t,e,n){const s=Ra(t,e.name),r=Aa(e.updateTime),i=new _i({mapValue:{fields:e.fields}}),o=Ci.newFoundDocument(s,r,i);return n&&o.setHasCommittedMutations(),n?o.setHasCommittedMutations():o}function Ba(t,e){let n;if(e instanceof qo)n={update:Fa(t,e.key,e.value)};else if(e instanceof zo)n={delete:ka(t,e.key)};else if(e instanceof Go)n={update:Fa(t,e.key,e.data),updateMask:Xa(e.fieldMask)};else{if(!(e instanceof Qo))return Os();n={verify:ka(t,e.key)}}return e.fieldTransforms.length>0&&(n.updateTransforms=e.fieldTransforms.map((t=>function(t,e){const n=e.transform;if(n instanceof To)return{fieldPath:e.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof So)return{fieldPath:e.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof Do)return{fieldPath:e.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof Ao)return{fieldPath:e.field.canonicalString(),increment:n.yt};throw Os()}(0,t)))),e.precondition.isNone||(n.currentDocument=function(t,e){return void 0!==e.updateTime?{updateTime:_a(t,e.updateTime)}:void 0!==e.exists?{exists:e.exists}:Os()}(t,e.precondition)),n}function Ua(t,e){const n=e.currentDocument?function(t){return void 0!==t.updateTime?Lo.updateTime(Aa(t.updateTime)):void 0!==t.exists?Lo.exists(t.exists):Lo.none()}(e.currentDocument):Lo.none(),s=e.updateTransforms?e.updateTransforms.map((e=>function(t,e){let n=null;if("setToServerValue"in e)Vs("REQUEST_TIME"===e.setToServerValue),n=new To;else if("appendMissingElements"in e){const t=e.appendMissingElements.values||[];n=new So(t)}else if("removeAllFromArray"in e){const t=e.removeAllFromArray.values||[];n=new Do(t)}else"increment"in e?n=new Ao(t,e.increment):Os();const s=ar.fromServerFormat(e.fieldPath);return new ko(s,n)}(t,e))):[];if(e.update){e.update.name;const r=Ra(t,e.update.name),i=new _i({mapValue:{fields:e.update.fields}});if(e.updateMask){const t=function(t){const e=t.fieldPaths||[];return new $r(e.map((t=>ar.fromServerFormat(t))))}(e.updateMask);return new Go(r,i,t,n,s)}return new qo(r,i,n,s)}if(e.delete){const s=Ra(t,e.delete);return new zo(s,n)}if(e.verify){const s=Ra(t,e.verify);return new Qo(s,n)}return Os()}function qa(t,e){return{documents:[La(t,e.path)]}}function Ga(t,e){const n={structuredQuery:{}},s=e.path;null!==e.collectionGroup?(n.parent=La(t,s),n.structuredQuery.from=[{collectionId:e.collectionGroup,allDescendants:!0}]):(n.parent=La(t,s.popLast()),n.structuredQuery.from=[{collectionId:s.lastSegment()}]);const r=function(t){if(0===t.length)return;const e=t.map((t=>function(t){if("=="===t.op){if(vi(t.value))return{unaryFilter:{field:Qa(t.field),op:"IS_NAN"}};if(wi(t.value))return{unaryFilter:{field:Qa(t.field),op:"IS_NULL"}}}else if("!="===t.op){if(vi(t.value))return{unaryFilter:{field:Qa(t.field),op:"IS_NOT_NAN"}};if(wi(t.value))return{unaryFilter:{field:Qa(t.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Qa(t.field),op:za(t.op),value:t.value}}}(t)));return 1===e.length?e[0]:{compositeFilter:{op:"AND",filters:e}}}(e.filters);r&&(n.structuredQuery.where=r);const i=function(t){if(0!==t.length)return t.map((t=>function(t){return{field:Qa(t.field),direction:$a(t.dir)}}(t)))}(e.orderBy);i&&(n.structuredQuery.orderBy=i);const o=function(t,e){return t.gt||si(e)?e:{value:e}}(t,e.limit);var a;return null!==o&&(n.structuredQuery.limit=o),e.startAt&&(n.structuredQuery.startAt={before:(a=e.startAt).inclusive,values:a.position}),e.endAt&&(n.structuredQuery.endAt=function(t){return{before:!t.inclusive,values:t.position}}(e.endAt)),n}function Ka(t){let e=Ma(t.parent);const n=t.structuredQuery,s=n.from?n.from.length:0;let r=null;if(s>0){Vs(1===s);const t=n.from[0];t.allDescendants?r=t.collectionId:e=e.child(t.collectionId)}let i=[];n.where&&(i=ja(n.where));let o=[];n.orderBy&&(o=n.orderBy.map((t=>function(t){return new Hi(Ha(t.field),function(t){switch(t){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(t.direction))}(t))));let a=null;n.limit&&(a=function(t){let e;return e="object"==typeof t?t.value:t,si(e)?null:e}(n.limit));let u=null;n.startAt&&(u=function(t){const e=!!t.before,n=t.values||[];return new Qi(n,e)}(n.startAt));let c=null;return n.endAt&&(c=function(t){const e=!t.before,n=t.values||[];return new Qi(n,e)}(n.endAt)),Zi(e,r,o,i,a,"F",u,c)}function ja(t){return t?void 0!==t.unaryFilter?[Ya(t)]:void 0!==t.fieldFilter?[Wa(t)]:void 0!==t.compositeFilter?t.compositeFilter.filters.map((t=>ja(t))).reduce(((t,e)=>t.concat(e))):Os():[]}function $a(t){return Ea[t]}function za(t){return Ta[t]}function Qa(t){return{fieldPath:t.canonicalString()}}function Ha(t){return ar.fromServerFormat(t.fieldPath)}function Wa(t){return Pi.create(Ha(t.fieldFilter.field),function(t){switch(t){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return Os()}}(t.fieldFilter.op),t.fieldFilter.value)}function Ya(t){switch(t.unaryFilter.op){case"IS_NAN":const e=Ha(t.unaryFilter.field);return Pi.create(e,"==",{doubleValue:NaN});case"IS_NULL":const n=Ha(t.unaryFilter.field);return Pi.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const s=Ha(t.unaryFilter.field);return Pi.create(s,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const r=Ha(t.unaryFilter.field);return Pi.create(r,"!=",{nullValue:"NULL_VALUE"});default:return Os()}}function Xa(t){const e=[];return t.fields.forEach((t=>e.push(t.canonicalString()))),{fieldPaths:e}}function Ja(t){return t.length>=4&&"projects"===t.get(0)&&"databases"===t.get(2)}function Za(t){let e="";for(let n=0;n<t.length;n++)e.length>0&&(e=eu(e)),e=tu(t.get(n),e);return eu(e)}function tu(t,e){let n=e;const s=t.length;for(let e=0;e<s;e++){const s=t.charAt(e);switch(s){case"\0":n+="";break;case"":n+="";break;default:n+=s}}return n}function eu(t){return t+""}function nu(t){const e=t.length;if(Vs(e>=2),2===e)return Vs(""===t.charAt(0)&&""===t.charAt(1)),ir.emptyPath();const n=e-2,s=[];let r="";for(let i=0;i<e;){const e=t.indexOf("",i);switch((e<0||e>n)&&Os(),t.charAt(e+1)){case"":const n=t.substring(i,e);let o;0===r.length?o=n:(r+=n,o=r,r=""),s.push(o);break;case"":r+=t.substring(i,e),r+="\0";break;case"":r+=t.substring(i,e+1);break;default:Os()}i=e+2}return new ir(s)}const su=["userId","batchId"];function ru(t,e){return[t,Za(e)]}function iu(t,e,n){return[t,Za(e),n]}const ou={},au=["prefixPath","collectionGroup","readTime","documentId"],uu=["prefixPath","collectionGroup","documentId"],cu=["collectionGroup","readTime","prefixPath","documentId"],hu=["canonicalId","targetId"],lu=["targetId","path"],du=["path","targetId"],fu=["collectionId","parent"],mu=["indexId","uid"],gu=["uid","sequenceNumber"],pu=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],yu=["indexId","uid","orderedDocumentKey"],wu=["userId","collectionPath","documentId"],vu=["userId","collectionPath","largestBatchId"],Iu=["userId","collectionGroup","largestBatchId"],bu=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],Eu=[...bu,"documentOverlays"],Tu=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],Su=Tu,xu=[...Su,"indexConfiguration","indexState","indexEntries"];class Du extends br{constructor(t,e){super(),this.ie=t,this.currentSequenceNumber=e}}function _u(t,e){const n=Ps(t);return xr.O(n.ie,e)}class Au{constructor(t,e,n,s){this.batchId=t,this.localWriteTime=e,this.baseMutations=n,this.mutations=s}applyToRemoteDocument(t,e){const n=e.mutationResults;for(let e=0;e<this.mutations.length;e++){const s=this.mutations[e];s.key.isEqual(t.key)&&Fo(s,t,n[e])}}applyToLocalView(t,e){for(const n of this.baseMutations)n.key.isEqual(t.key)&&(e=Po(n,t,e,this.localWriteTime));for(const n of this.mutations)n.key.isEqual(t.key)&&(e=Po(n,t,e,this.localWriteTime));return e}applyToLocalDocumentSet(t,e){const n=oa();return this.mutations.forEach((s=>{const r=t.get(s.key),i=r.overlayedDocument;let o=this.applyToLocalView(i,r.mutatedFields);o=e.has(s.key)?null:o;const a=Vo(i,o);null!==a&&n.set(s.key,a),i.isValidDocument()||i.convertToNoDocument(sr.min())})),n}keys(){return this.mutations.reduce(((t,e)=>t.add(e.key)),ha())}isEqual(t){return this.batchId===t.batchId&&tr(this.mutations,t.mutations,((t,e)=>Uo(t,e)))&&tr(this.baseMutations,t.baseMutations,((t,e)=>Uo(t,e)))}}class Cu{constructor(t,e,n,s){this.batch=t,this.commitVersion=e,this.mutationResults=n,this.docVersions=s}static from(t,e,n){Vs(t.mutations.length===n.length);let s=ua;const r=t.mutations;for(let t=0;t<r.length;t++)s=s.insert(r[t].key,n[t].version);return new Cu(t,e,n,s)}}class Nu{constructor(t,e){this.largestBatchId=t,this.mutation=e}getKey(){return this.mutation.key}isEqual(t){return null!==t&&this.mutation===t.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class ku{constructor(t,e,n,s,r=sr.min(),i=sr.min(),o=Qr.EMPTY_BYTE_STRING){this.target=t,this.targetId=e,this.purpose=n,this.sequenceNumber=s,this.snapshotVersion=r,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=o}withSequenceNumber(t){return new ku(this.target,this.targetId,this.purpose,t,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)}withResumeToken(t,e){return new ku(this.target,this.targetId,this.purpose,this.sequenceNumber,e,this.lastLimboFreeSnapshotVersion,t)}withLastLimboFreeSnapshotVersion(t){return new ku(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,t,this.resumeToken)}}class Ru{constructor(t){this.re=t}}function Lu(t,e){const n=e.key,s={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:Mu(e.readTime),hasCommittedMutations:e.hasCommittedMutations};if(e.isFoundDocument())s.document=function(t,e){return{name:ka(t,e.key),fields:e.data.value.mapValue.fields,updateTime:xa(t,e.version.toTimestamp())}}(t.re,e);else if(e.isNoDocument())s.noDocument={path:n.path.toArray(),readTime:Ou(e.version)};else{if(!e.isUnknownDocument())return Os();s.unknownDocument={path:n.path.toArray(),version:Ou(e.version)}}return s}function Mu(t){const e=t.toTimestamp();return[e.seconds,e.nanoseconds]}function Ou(t){const e=t.toTimestamp();return{seconds:e.seconds,nanoseconds:e.nanoseconds}}function Vu(t){const e=new nr(t.seconds,t.nanoseconds);return sr.fromTimestamp(e)}function Fu(t,e){const n=(e.baseMutations||[]).map((e=>Ua(t.re,e)));for(let t=0;t<e.mutations.length-1;++t){const n=e.mutations[t];if(t+1<e.mutations.length&&void 0!==e.mutations[t+1].transform){const s=e.mutations[t+1];n.updateTransforms=s.transform.fieldTransforms,e.mutations.splice(t+1,1),++t}}const s=e.mutations.map((e=>Ua(t.re,e))),r=nr.fromMillis(e.localWriteTimeMs);return new Au(e.batchId,r,n,s)}function Pu(t){const e=Vu(t.readTime),n=void 0!==t.lastLimboFreeSnapshotVersion?Vu(t.lastLimboFreeSnapshotVersion):sr.min();let s;var r;return void 0!==t.query.documents?(Vs(1===(r=t.query).documents.length),s=oo(to(Ma(r.documents[0])))):s=function(t){return oo(Ka(t))}(t.query),new ku(s,t.targetId,0,t.lastListenSequenceNumber,e,n,Qr.fromBase64String(t.resumeToken))}function Bu(t,e){const n=Ou(e.snapshotVersion),s=Ou(e.lastLimboFreeSnapshotVersion);let r;r=Mi(e.target)?qa(t.re,e.target):Ga(t.re,e.target);const i=e.resumeToken.toBase64();return{targetId:e.targetId,canonicalId:Ri(e.target),readTime:n,resumeToken:i,lastListenSequenceNumber:e.sequenceNumber,lastLimboFreeSnapshotVersion:s,query:r}}function Uu(t){const e=Ka({parent:t.parent,structuredQuery:t.structuredQuery});return"LAST"===t.limitType?ao(e,e.limit,"L"):e}function qu(t,e){return new Nu(e.largestBatchId,Ua(t.re,e.overlayMutation))}function Gu(t,e){const n=e.path.lastSegment();return[t,Za(e.path.popLast()),n]}function Ku(t,e,n,s){return{indexId:t,uid:e.uid||"",sequenceNumber:n,readTime:Ou(s.readTime),documentKey:Za(s.documentKey.path),largestBatchId:s.largestBatchId}}class ju{getBundleMetadata(t,e){return $u(t).get(e).next((t=>{if(t)return{id:(e=t).bundleId,createTime:Vu(e.createTime),version:e.version};var e}))}saveBundleMetadata(t,e){return $u(t).put({bundleId:(n=e).id,createTime:Ou(Aa(n.createTime)),version:n.version});var n}getNamedQuery(t,e){return zu(t).get(e).next((t=>{if(t)return{name:(e=t).name,query:Uu(e.bundledQuery),readTime:Vu(e.readTime)};var e}))}saveNamedQuery(t,e){return zu(t).put(function(t){return{name:t.name,readTime:Ou(Aa(t.readTime)),bundledQuery:t.bundledQuery}}(e))}}function $u(t){return _u(t,"bundles")}function zu(t){return _u(t,"namedQueries")}class Qu{constructor(t,e){this.It=t,this.userId=e}static oe(t,e){const n=e.uid||"";return new Qu(t,n)}getOverlay(t,e){return Hu(t).get(Gu(this.userId,e)).next((t=>t?qu(this.It,t):null))}getOverlays(t,e){const n=ia();return Tr.forEach(e,(e=>this.getOverlay(t,e).next((t=>{null!==t&&n.set(e,t)})))).next((()=>n))}saveOverlays(t,e,n){const s=[];return n.forEach(((n,r)=>{const i=new Nu(e,r);s.push(this.ue(t,i))})),Tr.waitFor(s)}removeOverlaysForBatchId(t,e,n){const s=new Set;e.forEach((t=>s.add(Za(t.getCollectionPath()))));const r=[];return s.forEach((e=>{const s=IDBKeyRange.bound([this.userId,e,n],[this.userId,e,n+1],!1,!0);r.push(Hu(t).Y("collectionPathOverlayIndex",s))})),Tr.waitFor(r)}getOverlaysForCollection(t,e,n){const s=ia(),r=Za(e),i=IDBKeyRange.bound([this.userId,r,n],[this.userId,r,Number.POSITIVE_INFINITY],!0);return Hu(t).W("collectionPathOverlayIndex",i).next((t=>{for(const e of t){const t=qu(this.It,e);s.set(t.getKey(),t)}return s}))}getOverlaysForCollectionGroup(t,e,n,s){const r=ia();let i;const o=IDBKeyRange.bound([this.userId,e,n],[this.userId,e,Number.POSITIVE_INFINITY],!0);return Hu(t).Z({index:"collectionGroupOverlayIndex",range:o},((t,e,n)=>{const o=qu(this.It,e);r.size()<s||o.largestBatchId===i?(r.set(o.getKey(),o),i=o.largestBatchId):n.done()})).next((()=>r))}ue(t,e){return Hu(t).put(function(t,e,n){const[s,r,i]=Gu(e,n.mutation.key);return{userId:e,collectionPath:r,documentId:i,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:Ba(t.re,n.mutation)}}(this.It,this.userId,e))}}function Hu(t){return _u(t,"documentOverlays")}class Wu{constructor(){}ce(t,e){this.ae(t,e),e.he()}ae(t,e){if("nullValue"in t)this.le(e,5);else if("booleanValue"in t)this.le(e,10),e.fe(t.booleanValue?1:0);else if("integerValue"in t)this.le(e,15),e.fe(Yr(t.integerValue));else if("doubleValue"in t){const n=Yr(t.doubleValue);isNaN(n)?this.le(e,13):(this.le(e,15),ri(n)?e.fe(0):e.fe(n))}else if("timestampValue"in t){const n=t.timestampValue;this.le(e,20),"string"==typeof n?e.de(n):(e.de(`${n.seconds||""}`),e.fe(n.nanos||0))}else if("stringValue"in t)this._e(t.stringValue,e),this.we(e);else if("bytesValue"in t)this.le(e,30),e.me(Xr(t.bytesValue)),this.we(e);else if("referenceValue"in t)this.ge(t.referenceValue,e);else if("geoPointValue"in t){const n=t.geoPointValue;this.le(e,45),e.fe(n.latitude||0),e.fe(n.longitude||0)}else"mapValue"in t?Ei(t)?this.le(e,Number.MAX_SAFE_INTEGER):(this.ye(t.mapValue,e),this.we(e)):"arrayValue"in t?(this.pe(t.arrayValue,e),this.we(e)):Os()}_e(t,e){this.le(e,25),this.Ie(t,e)}Ie(t,e){e.de(t)}ye(t,e){const n=t.fields||{};this.le(e,55);for(const t of Object.keys(n))this._e(t,e),this.ae(n[t],e)}pe(t,e){const n=t.values||[];this.le(e,50);for(const t of n)this.ae(t,e)}ge(t,e){this.le(e,37),ur.fromName(t).path.forEach((t=>{this.le(e,60),this.Ie(t,e)}))}le(t,e){t.fe(e)}we(t){t.fe(2)}}function Yu(t){if(0===t)return 8;let e=0;return t>>4==0&&(e+=4,t<<=4),t>>6==0&&(e+=2,t<<=2),t>>7==0&&(e+=1),e}function Xu(t){const e=64-function(t){let e=0;for(let n=0;n<8;++n){const s=Yu(255&t[n]);if(e+=s,8!==s)break}return e}(t);return Math.ceil(e/8)}Wu.Te=new Wu;class Ju{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Ee(t){const e=t[Symbol.iterator]();let n=e.next();for(;!n.done;)this.Ae(n.value),n=e.next();this.Re()}be(t){const e=t[Symbol.iterator]();let n=e.next();for(;!n.done;)this.Pe(n.value),n=e.next();this.ve()}Ve(t){for(const e of t){const t=e.charCodeAt(0);if(t<128)this.Ae(t);else if(t<2048)this.Ae(960|t>>>6),this.Ae(128|63&t);else if(e<"\ud800"||"\udbff"<e)this.Ae(480|t>>>12),this.Ae(128|63&t>>>6),this.Ae(128|63&t);else{const t=e.codePointAt(0);this.Ae(240|t>>>18),this.Ae(128|63&t>>>12),this.Ae(128|63&t>>>6),this.Ae(128|63&t)}}this.Re()}Se(t){for(const e of t){const t=e.charCodeAt(0);if(t<128)this.Pe(t);else if(t<2048)this.Pe(960|t>>>6),this.Pe(128|63&t);else if(e<"\ud800"||"\udbff"<e)this.Pe(480|t>>>12),this.Pe(128|63&t>>>6),this.Pe(128|63&t);else{const t=e.codePointAt(0);this.Pe(240|t>>>18),this.Pe(128|63&t>>>12),this.Pe(128|63&t>>>6),this.Pe(128|63&t)}}this.ve()}De(t){const e=this.Ce(t),n=Xu(e);this.xe(1+n),this.buffer[this.position++]=255&n;for(let t=e.length-n;t<e.length;++t)this.buffer[this.position++]=255&e[t]}Ne(t){const e=this.Ce(t),n=Xu(e);this.xe(1+n),this.buffer[this.position++]=~(255&n);for(let t=e.length-n;t<e.length;++t)this.buffer[this.position++]=~(255&e[t])}ke(){this.Me(255),this.Me(255)}Oe(){this.Fe(255),this.Fe(255)}reset(){this.position=0}seed(t){this.xe(t.length),this.buffer.set(t,this.position),this.position+=t.length}$e(){return this.buffer.slice(0,this.position)}Ce(t){const e=function(t){const e=new DataView(new ArrayBuffer(8));return e.setFloat64(0,t,!1),new Uint8Array(e.buffer)}(t),n=0!=(128&e[0]);e[0]^=n?255:128;for(let t=1;t<e.length;++t)e[t]^=n?255:0;return e}Ae(t){const e=255&t;0===e?(this.Me(0),this.Me(255)):255===e?(this.Me(255),this.Me(0)):this.Me(e)}Pe(t){const e=255&t;0===e?(this.Fe(0),this.Fe(255)):255===e?(this.Fe(255),this.Fe(0)):this.Fe(t)}Re(){this.Me(0),this.Me(1)}ve(){this.Fe(0),this.Fe(1)}Me(t){this.xe(1),this.buffer[this.position++]=t}Fe(t){this.xe(1),this.buffer[this.position++]=~t}xe(t){const e=t+this.position;if(e<=this.buffer.length)return;let n=2*this.buffer.length;n<e&&(n=e);const s=new Uint8Array(n);s.set(this.buffer),this.buffer=s}}class Zu{constructor(t){this.Be=t}me(t){this.Be.Ee(t)}de(t){this.Be.Ve(t)}fe(t){this.Be.De(t)}he(){this.Be.ke()}}class tc{constructor(t){this.Be=t}me(t){this.Be.be(t)}de(t){this.Be.Se(t)}fe(t){this.Be.Ne(t)}he(){this.Be.Oe()}}class ec{constructor(){this.Be=new Ju,this.Le=new Zu(this.Be),this.Ue=new tc(this.Be)}seed(t){this.Be.seed(t)}qe(t){return 0===t?this.Le:this.Ue}$e(){return this.Be.$e()}reset(){this.Be.reset()}}class nc{constructor(t,e,n,s){this.indexId=t,this.documentKey=e,this.arrayValue=n,this.directionalValue=s}Ke(){const t=this.directionalValue.length,e=0===t||255===this.directionalValue[t-1]?t+1:t,n=new Uint8Array(e);return n.set(this.directionalValue,0),e!==t?n.set([0],this.directionalValue.length):++n[n.length-1],new nc(this.indexId,this.documentKey,this.arrayValue,n)}}function sc(t,e){let n=t.indexId-e.indexId;return 0!==n?n:(n=rc(t.arrayValue,e.arrayValue),0!==n?n:(n=rc(t.directionalValue,e.directionalValue),0!==n?n:ur.comparator(t.documentKey,e.documentKey)))}function rc(t,e){for(let n=0;n<t.length&&n<e.length;++n){const s=t[n]-e[n];if(0!==s)return s}return t.length-e.length}class ic{constructor(t){this.collectionId=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment(),this.Ge=t.orderBy,this.Qe=[];for(const e of t.filters){const t=e;t.dt()?this.je=t:this.Qe.push(t)}}We(t){const e=hr(t);if(void 0!==e&&!this.ze(e))return!1;const n=lr(t);let s=0,r=0;for(;s<n.length&&this.ze(n[s]);++s);if(s===n.length)return!0;if(void 0!==this.je){const t=n[s];if(!this.He(this.je,t)||!this.Je(this.Ge[r++],t))return!1;++s}for(;s<n.length;++s){const t=n[s];if(r>=this.Ge.length||!this.Je(this.Ge[r++],t))return!1}return!0}ze(t){for(const e of this.Qe)if(this.He(e,t))return!0;return!1}He(t,e){if(void 0===t||!t.field.isEqual(e.fieldPath))return!1;const n="array-contains"===t.op||"array-contains-any"===t.op;return 2===e.kind===n}Je(t,e){return!!t.field.isEqual(e.fieldPath)&&(0===e.kind&&"asc"===t.dir||1===e.kind&&"desc"===t.dir)}}class oc{constructor(){this.Ye=new ac}addToCollectionParentIndex(t,e){return this.Ye.add(e),Tr.resolve()}getCollectionParents(t,e){return Tr.resolve(this.Ye.getEntries(e))}addFieldIndex(t,e){return Tr.resolve()}deleteFieldIndex(t,e){return Tr.resolve()}getDocumentsMatchingTarget(t,e){return Tr.resolve(null)}getIndexType(t,e){return Tr.resolve(0)}getFieldIndexes(t,e){return Tr.resolve([])}getNextCollectionGroupToUpdate(t){return Tr.resolve(null)}getMinOffset(t,e){return Tr.resolve(wr.min())}getMinOffsetFromCollectionGroup(t,e){return Tr.resolve(wr.min())}updateCollectionGroup(t,e,n){return Tr.resolve()}updateIndexEntries(t,e){return Tr.resolve()}}class ac{constructor(){this.index={}}add(t){const e=t.lastSegment(),n=t.popLast(),s=this.index[e]||new Gr(ir.comparator),r=!s.has(n);return this.index[e]=s.add(n),r}has(t){const e=t.lastSegment(),n=t.popLast(),s=this.index[e];return s&&s.has(n)}getEntries(t){return(this.index[t]||new Gr(ir.comparator)).toArray()}}const uc=new Uint8Array(0);class cc{constructor(t,e){this.user=t,this.databaseId=e,this.Xe=new ac,this.Ze=new Zo((t=>Ri(t)),((t,e)=>Li(t,e))),this.uid=t.uid||""}addToCollectionParentIndex(t,e){if(!this.Xe.has(e)){const n=e.lastSegment(),s=e.popLast();t.addOnCommittedListener((()=>{this.Xe.add(e)}));const r={collectionId:n,parent:Za(s)};return hc(t).put(r)}return Tr.resolve()}getCollectionParents(t,e){const n=[],s=IDBKeyRange.bound([e,""],[er(e),""],!1,!0);return hc(t).W(s).next((t=>{for(const s of t){if(s.collectionId!==e)break;n.push(nu(s.parent))}return n}))}addFieldIndex(t,e){const n=dc(t),s=function(t){return{indexId:t.indexId,collectionGroup:t.collectionGroup,fields:t.fields.map((t=>[t.fieldPath.canonicalString(),t.kind]))}}(e);delete s.indexId;const r=n.add(s);if(e.indexState){const n=fc(t);return r.next((t=>{n.put(Ku(t,this.user,e.indexState.sequenceNumber,e.indexState.offset))}))}return r.next()}deleteFieldIndex(t,e){const n=dc(t),s=fc(t),r=lc(t);return n.delete(e.indexId).next((()=>s.delete(IDBKeyRange.bound([e.indexId],[e.indexId+1],!1,!0)))).next((()=>r.delete(IDBKeyRange.bound([e.indexId],[e.indexId+1],!1,!0))))}getDocumentsMatchingTarget(t,e){const n=lc(t);let s=!0;const r=new Map;return Tr.forEach(this.tn(e),(e=>this.en(t,e).next((t=>{s&&(s=!!t),r.set(e,t)})))).next((()=>{if(s){let t=ha();const s=[];return Tr.forEach(r,((r,i)=>{var o;ks("IndexedDbIndexManager",`Using index ${o=r,`id=${o.indexId}|cg=${o.collectionGroup}|f=${o.fields.map((t=>`${t.fieldPath}:${t.kind}`)).join(",")}`} to execute ${Ri(e)}`);const a=function(t,e){const n=hr(e);if(void 0===n)return null;for(const e of Oi(t,n.fieldPath))switch(e.op){case"array-contains-any":return e.value.arrayValue.values||[];case"array-contains":return[e.value]}return null}(i,r),u=function(t,e){const n=new Map;for(const s of lr(e))for(const e of Oi(t,s.fieldPath))switch(e.op){case"==":case"in":n.set(s.fieldPath.canonicalString(),e.value);break;case"not-in":case"!=":return n.set(s.fieldPath.canonicalString(),e.value),Array.from(n.values())}return null}(i,r),c=function(t,e){const n=[];let s=!0;for(const r of lr(e)){const e=0===r.kind?Vi(t,r.fieldPath,t.startAt):Fi(t,r.fieldPath,t.startAt);n.push(e.value),s&&(s=e.inclusive)}return new Qi(n,s)}(i,r),h=function(t,e){const n=[];let s=!0;for(const r of lr(e)){const e=0===r.kind?Fi(t,r.fieldPath,t.endAt):Vi(t,r.fieldPath,t.endAt);n.push(e.value),s&&(s=e.inclusive)}return new Qi(n,s)}(i,r),l=this.nn(r,i,c),d=this.nn(r,i,h),f=this.sn(r,i,u),m=this.rn(r.indexId,a,l,c.inclusive,d,h.inclusive,f);return Tr.forEach(m,(r=>n.J(r,e.limit).next((e=>{e.forEach((e=>{const n=ur.fromSegments(e.documentKey);t.has(n)||(t=t.add(n),s.push(n))}))}))))})).next((()=>s))}return Tr.resolve(null)}))}tn(t){let e=this.Ze.get(t);return e||(e=[t],this.Ze.set(t,e),e)}rn(t,e,n,s,r,i,o){const a=(null!=e?e.length:1)*Math.max(n.length,r.length),u=a/(null!=e?e.length:1),c=[];for(let h=0;h<a;++h){const a=e?this.on(e[h/u]):uc,l=this.un(t,a,n[h%u],s),d=this.cn(t,a,r[h%u],i),f=o.map((e=>this.un(t,a,e,!0)));c.push(...this.createRange(l,d,f))}return c}un(t,e,n,s){const r=new nc(t,ur.empty(),e,n);return s?r:r.Ke()}cn(t,e,n,s){const r=new nc(t,ur.empty(),e,n);return s?r.Ke():r}en(t,e){const n=new ic(e),s=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment();return this.getFieldIndexes(t,s).next((t=>{let e=null;for(const s of t)n.We(s)&&(!e||s.fields.length>e.fields.length)&&(e=s);return e}))}getIndexType(t,e){let n=2;return Tr.forEach(this.tn(e),(e=>this.en(t,e).next((t=>{t?0!==n&&t.fields.length<function(t){let e=new Gr(ar.comparator),n=!1;for(const s of t.filters){const t=s;t.field.isKeyField()||("array-contains"===t.op||"array-contains-any"===t.op?n=!0:e=e.add(t.field))}for(const n of t.orderBy)n.field.isKeyField()||(e=e.add(n.field));return e.size+(n?1:0)}(e)&&(n=1):n=0})))).next((()=>n))}an(t,e){const n=new ec;for(const s of lr(t)){const t=e.data.field(s.fieldPath);if(null==t)return null;const r=n.qe(s.kind);Wu.Te.ce(t,r)}return n.$e()}on(t){const e=new ec;return Wu.Te.ce(t,e.qe(0)),e.$e()}hn(t,e){const n=new ec;return Wu.Te.ce(gi(this.databaseId,e),n.qe(function(t){const e=lr(t);return 0===e.length?0:e[e.length-1].kind}(t))),n.$e()}sn(t,e,n){if(null===n)return[];let s=[];s.push(new ec);let r=0;for(const i of lr(t)){const t=n[r++];for(const n of s)if(this.ln(e,i.fieldPath)&&yi(t))s=this.fn(s,i,t);else{const e=n.qe(i.kind);Wu.Te.ce(t,e)}}return this.dn(s)}nn(t,e,n){return this.sn(t,e,n.position)}dn(t){const e=[];for(let n=0;n<t.length;++n)e[n]=t[n].$e();return e}fn(t,e,n){const s=[...t],r=[];for(const t of n.arrayValue.values||[])for(const n of s){const s=new ec;s.seed(n.$e()),Wu.Te.ce(t,s.qe(e.kind)),r.push(s)}return r}ln(t,e){return!!t.filters.find((t=>t instanceof Pi&&t.field.isEqual(e)&&("in"===t.op||"not-in"===t.op)))}getFieldIndexes(t,e){const n=dc(t),s=fc(t);return(e?n.W("collectionGroupIndex",IDBKeyRange.bound(e,e)):n.W()).next((t=>{const e=[];return Tr.forEach(t,(t=>s.get([t.indexId,this.uid]).next((n=>{e.push(function(t,e){const n=e?new gr(e.sequenceNumber,new wr(Vu(e.readTime),new ur(nu(e.documentKey)),e.largestBatchId)):gr.empty(),s=t.fields.map((([t,e])=>new fr(ar.fromServerFormat(t),e)));return new cr(t.indexId,t.collectionGroup,s,n)}(t,n))})))).next((()=>e))}))}getNextCollectionGroupToUpdate(t){return this.getFieldIndexes(t).next((t=>0===t.length?null:(t.sort(((t,e)=>{const n=t.indexState.sequenceNumber-e.indexState.sequenceNumber;return 0!==n?n:Zs(t.collectionGroup,e.collectionGroup)})),t[0].collectionGroup)))}updateCollectionGroup(t,e,n){const s=dc(t),r=fc(t);return this._n(t).next((t=>s.W("collectionGroupIndex",IDBKeyRange.bound(e,e)).next((e=>Tr.forEach(e,(e=>r.put(Ku(e.indexId,this.user,t,n))))))))}updateIndexEntries(t,e){const n=new Map;return Tr.forEach(e,((e,s)=>{const r=n.get(e.collectionGroup);return(r?Tr.resolve(r):this.getFieldIndexes(t,e.collectionGroup)).next((r=>(n.set(e.collectionGroup,r),Tr.forEach(r,(n=>this.wn(t,e,n).next((e=>{const r=this.mn(s,n);return e.isEqual(r)?Tr.resolve():this.gn(t,s,n,e,r)})))))))}))}yn(t,e,n,s){return lc(t).put({indexId:s.indexId,uid:this.uid,arrayValue:s.arrayValue,directionalValue:s.directionalValue,orderedDocumentKey:this.hn(n,e.key),documentKey:e.key.path.toArray()})}pn(t,e,n,s){return lc(t).delete([s.indexId,this.uid,s.arrayValue,s.directionalValue,this.hn(n,e.key),e.key.path.toArray()])}wn(t,e,n){const s=lc(t);let r=new Gr(sc);return s.Z({index:"documentKeyIndex",range:IDBKeyRange.only([n.indexId,this.uid,this.hn(n,e)])},((t,s)=>{r=r.add(new nc(n.indexId,e,s.arrayValue,s.directionalValue))})).next((()=>r))}mn(t,e){let n=new Gr(sc);const s=this.an(e,t);if(null==s)return n;const r=hr(e);if(null!=r){const i=t.data.field(r.fieldPath);if(yi(i))for(const r of i.arrayValue.values||[])n=n.add(new nc(e.indexId,t.key,this.on(r),s))}else n=n.add(new nc(e.indexId,t.key,uc,s));return n}gn(t,e,n,s,r){ks("IndexedDbIndexManager","Updating index entries for document '%s'",e.key);const i=[];return function(t,e,n,s,r){const i=t.getIterator(),o=e.getIterator();let a=jr(i),u=jr(o);for(;a||u;){let t=!1,e=!1;if(a&&u){const s=n(a,u);s<0?e=!0:s>0&&(t=!0)}else null!=a?e=!0:t=!0;t?(s(u),u=jr(o)):e?(r(a),a=jr(i)):(a=jr(i),u=jr(o))}}(s,r,sc,(s=>{i.push(this.yn(t,e,n,s))}),(s=>{i.push(this.pn(t,e,n,s))})),Tr.waitFor(i)}_n(t){let e=1;return fc(t).Z({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},((t,n,s)=>{s.done(),e=n.sequenceNumber+1})).next((()=>e))}createRange(t,e,n){n=n.sort(((t,e)=>sc(t,e))).filter(((t,e,n)=>!e||0!==sc(t,n[e-1])));const s=[];s.push(t);for(const r of n){const n=sc(r,t),i=sc(r,e);if(0===n)s[0]=t.Ke();else if(n>0&&i<0)s.push(r),s.push(r.Ke());else if(i>0)break}s.push(e);const r=[];for(let t=0;t<s.length;t+=2)r.push(IDBKeyRange.bound([s[t].indexId,this.uid,s[t].arrayValue,s[t].directionalValue,uc,[]],[s[t+1].indexId,this.uid,s[t+1].arrayValue,s[t+1].directionalValue,uc,[]]));return r}getMinOffsetFromCollectionGroup(t,e){return this.getFieldIndexes(t,e).next(mc)}getMinOffset(t,e){return Tr.mapArray(this.tn(e),(e=>this.en(t,e).next((t=>t||Os())))).next(mc)}}function hc(t){return _u(t,"collectionParents")}function lc(t){return _u(t,"indexEntries")}function dc(t){return _u(t,"indexConfiguration")}function fc(t){return _u(t,"indexState")}function mc(t){Vs(0!==t.length);let e=t[0].indexState.offset,n=e.largestBatchId;for(let s=1;s<t.length;s++){const r=t[s].indexState.offset;vr(r,e)<0&&(e=r),n<r.largestBatchId&&(n=r.largestBatchId)}return new wr(e.readTime,e.documentKey,n)}const gc={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class pc{constructor(t,e,n){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=n}static withCacheSize(t){return new pc(t,pc.DEFAULT_COLLECTION_PERCENTILE,pc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function yc(t,e,n){const s=t.store("mutations"),r=t.store("documentMutations"),i=[],o=IDBKeyRange.only(n.batchId);let a=0;const u=s.Z({range:o},((t,e,n)=>(a++,n.delete())));i.push(u.next((()=>{Vs(1===a)})));const c=[];for(const t of n.mutations){const s=iu(e,t.key.path,n.batchId);i.push(r.delete(s)),c.push(t.key)}return Tr.waitFor(i).next((()=>c))}function wc(t){if(!t)return 0;let e;if(t.document)e=t.document;else if(t.unknownDocument)e=t.unknownDocument;else{if(!t.noDocument)throw Os();e=t.noDocument}return JSON.stringify(e).length}pc.DEFAULT_COLLECTION_PERCENTILE=10,pc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,pc.DEFAULT=new pc(41943040,pc.DEFAULT_COLLECTION_PERCENTILE,pc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),pc.DISABLED=new pc(-1,0,0);class vc{constructor(t,e,n,s){this.userId=t,this.It=e,this.indexManager=n,this.referenceDelegate=s,this.In={}}static oe(t,e,n,s){Vs(""!==t.uid);const r=t.isAuthenticated()?t.uid:"";return new vc(r,e,n,s)}checkEmpty(t){let e=!0;const n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return bc(t).Z({index:"userMutationsIndex",range:n},((t,n,s)=>{e=!1,s.done()})).next((()=>e))}addMutationBatch(t,e,n,s){const r=Ec(t),i=bc(t);return i.add({}).next((o=>{Vs("number"==typeof o);const a=new Au(o,e,n,s),u=function(t,e,n){const s=n.baseMutations.map((e=>Ba(t.re,e))),r=n.mutations.map((e=>Ba(t.re,e)));return{userId:e,batchId:n.batchId,localWriteTimeMs:n.localWriteTime.toMillis(),baseMutations:s,mutations:r}}(this.It,this.userId,a),c=[];let h=new Gr(((t,e)=>Zs(t.canonicalString(),e.canonicalString())));for(const t of s){const e=iu(this.userId,t.key.path,o);h=h.add(t.key.path.popLast()),c.push(i.put(u)),c.push(r.put(e,ou))}return h.forEach((e=>{c.push(this.indexManager.addToCollectionParentIndex(t,e))})),t.addOnCommittedListener((()=>{this.In[o]=a.keys()})),Tr.waitFor(c).next((()=>a))}))}lookupMutationBatch(t,e){return bc(t).get(e).next((t=>t?(Vs(t.userId===this.userId),Fu(this.It,t)):null))}Tn(t,e){return this.In[e]?Tr.resolve(this.In[e]):this.lookupMutationBatch(t,e).next((t=>{if(t){const n=t.keys();return this.In[e]=n,n}return null}))}getNextMutationBatchAfterBatchId(t,e){const n=e+1,s=IDBKeyRange.lowerBound([this.userId,n]);let r=null;return bc(t).Z({index:"userMutationsIndex",range:s},((t,e,s)=>{e.userId===this.userId&&(Vs(e.batchId>=n),r=Fu(this.It,e)),s.done()})).next((()=>r))}getHighestUnacknowledgedBatchId(t){const e=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let n=-1;return bc(t).Z({index:"userMutationsIndex",range:e,reverse:!0},((t,e,s)=>{n=e.batchId,s.done()})).next((()=>n))}getAllMutationBatches(t){const e=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return bc(t).W("userMutationsIndex",e).next((t=>t.map((t=>Fu(this.It,t)))))}getAllMutationBatchesAffectingDocumentKey(t,e){const n=ru(this.userId,e.path),s=IDBKeyRange.lowerBound(n),r=[];return Ec(t).Z({range:s},((n,s,i)=>{const[o,a,u]=n,c=nu(a);if(o===this.userId&&e.path.isEqual(c))return bc(t).get(u).next((t=>{if(!t)throw Os();Vs(t.userId===this.userId),r.push(Fu(this.It,t))}));i.done()})).next((()=>r))}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new Gr(Zs);const s=[];return e.forEach((e=>{const r=ru(this.userId,e.path),i=IDBKeyRange.lowerBound(r),o=Ec(t).Z({range:i},((t,s,r)=>{const[i,o,a]=t,u=nu(o);i===this.userId&&e.path.isEqual(u)?n=n.add(a):r.done()}));s.push(o)})),Tr.waitFor(s).next((()=>this.En(t,n)))}getAllMutationBatchesAffectingQuery(t,e){const n=e.path,s=n.length+1,r=ru(this.userId,n),i=IDBKeyRange.lowerBound(r);let o=new Gr(Zs);return Ec(t).Z({range:i},((t,e,r)=>{const[i,a,u]=t,c=nu(a);i===this.userId&&n.isPrefixOf(c)?c.length===s&&(o=o.add(u)):r.done()})).next((()=>this.En(t,o)))}En(t,e){const n=[],s=[];return e.forEach((e=>{s.push(bc(t).get(e).next((t=>{if(null===t)throw Os();Vs(t.userId===this.userId),n.push(Fu(this.It,t))})))})),Tr.waitFor(s).next((()=>n))}removeMutationBatch(t,e){return yc(t.ie,this.userId,e).next((n=>(t.addOnCommittedListener((()=>{this.An(e.batchId)})),Tr.forEach(n,(e=>this.referenceDelegate.markPotentiallyOrphaned(t,e))))))}An(t){delete this.In[t]}performConsistencyCheck(t){return this.checkEmpty(t).next((e=>{if(!e)return Tr.resolve();const n=IDBKeyRange.lowerBound([this.userId]),s=[];return Ec(t).Z({range:n},((t,e,n)=>{if(t[0]===this.userId){const e=nu(t[1]);s.push(e)}else n.done()})).next((()=>{Vs(0===s.length)}))}))}containsKey(t,e){return Ic(t,this.userId,e)}Rn(t){return Tc(t).get(this.userId).next((t=>t||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""}))}}function Ic(t,e,n){const s=ru(e,n.path),r=s[1],i=IDBKeyRange.lowerBound(s);let o=!1;return Ec(t).Z({range:i,X:!0},((t,n,s)=>{const[i,a,u]=t;i===e&&a===r&&(o=!0),s.done()})).next((()=>o))}function bc(t){return _u(t,"mutations")}function Ec(t){return _u(t,"documentMutations")}function Tc(t){return _u(t,"mutationQueues")}class Sc{constructor(t){this.bn=t}next(){return this.bn+=2,this.bn}static Pn(){return new Sc(0)}static vn(){return new Sc(-1)}}class xc{constructor(t,e){this.referenceDelegate=t,this.It=e}allocateTargetId(t){return this.Vn(t).next((e=>{const n=new Sc(e.highestTargetId);return e.highestTargetId=n.next(),this.Sn(t,e).next((()=>e.highestTargetId))}))}getLastRemoteSnapshotVersion(t){return this.Vn(t).next((t=>sr.fromTimestamp(new nr(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds))))}getHighestSequenceNumber(t){return this.Vn(t).next((t=>t.highestListenSequenceNumber))}setTargetsMetadata(t,e,n){return this.Vn(t).next((s=>(s.highestListenSequenceNumber=e,n&&(s.lastRemoteSnapshotVersion=n.toTimestamp()),e>s.highestListenSequenceNumber&&(s.highestListenSequenceNumber=e),this.Sn(t,s))))}addTargetData(t,e){return this.Dn(t,e).next((()=>this.Vn(t).next((n=>(n.targetCount+=1,this.Cn(e,n),this.Sn(t,n))))))}updateTargetData(t,e){return this.Dn(t,e)}removeTargetData(t,e){return this.removeMatchingKeysForTargetId(t,e.targetId).next((()=>Dc(t).delete(e.targetId))).next((()=>this.Vn(t))).next((e=>(Vs(e.targetCount>0),e.targetCount-=1,this.Sn(t,e))))}removeTargets(t,e,n){let s=0;const r=[];return Dc(t).Z(((i,o)=>{const a=Pu(o);a.sequenceNumber<=e&&null===n.get(a.targetId)&&(s++,r.push(this.removeTargetData(t,a)))})).next((()=>Tr.waitFor(r))).next((()=>s))}forEachTarget(t,e){return Dc(t).Z(((t,n)=>{const s=Pu(n);e(s)}))}Vn(t){return _c(t).get("targetGlobalKey").next((t=>(Vs(null!==t),t)))}Sn(t,e){return _c(t).put("targetGlobalKey",e)}Dn(t,e){return Dc(t).put(Bu(this.It,e))}Cn(t,e){let n=!1;return t.targetId>e.highestTargetId&&(e.highestTargetId=t.targetId,n=!0),t.sequenceNumber>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=t.sequenceNumber,n=!0),n}getTargetCount(t){return this.Vn(t).next((t=>t.targetCount))}getTargetData(t,e){const n=Ri(e),s=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]);let r=null;return Dc(t).Z({range:s,index:"queryTargetsIndex"},((t,n,s)=>{const i=Pu(n);Li(e,i.target)&&(r=i,s.done())})).next((()=>r))}addMatchingKeys(t,e,n){const s=[],r=Ac(t);return e.forEach((e=>{const i=Za(e.path);s.push(r.put({targetId:n,path:i})),s.push(this.referenceDelegate.addReference(t,n,e))})),Tr.waitFor(s)}removeMatchingKeys(t,e,n){const s=Ac(t);return Tr.forEach(e,(e=>{const r=Za(e.path);return Tr.waitFor([s.delete([n,r]),this.referenceDelegate.removeReference(t,n,e)])}))}removeMatchingKeysForTargetId(t,e){const n=Ac(t),s=IDBKeyRange.bound([e],[e+1],!1,!0);return n.delete(s)}getMatchingKeysForTargetId(t,e){const n=IDBKeyRange.bound([e],[e+1],!1,!0),s=Ac(t);let r=ha();return s.Z({range:n,X:!0},((t,e,n)=>{const s=nu(t[1]),i=new ur(s);r=r.add(i)})).next((()=>r))}containsKey(t,e){const n=Za(e.path),s=IDBKeyRange.bound([n],[er(n)],!1,!0);let r=0;return Ac(t).Z({index:"documentTargetsIndex",X:!0,range:s},(([t,e],n,s)=>{0!==t&&(r++,s.done())})).next((()=>r>0))}se(t,e){return Dc(t).get(e).next((t=>t?Pu(t):null))}}function Dc(t){return _u(t,"targets")}function _c(t){return _u(t,"targetGlobal")}function Ac(t){return _u(t,"targetDocuments")}function Cc([t,e],[n,s]){const r=Zs(t,n);return 0===r?Zs(e,s):r}class Nc{constructor(t){this.xn=t,this.buffer=new Gr(Cc),this.Nn=0}kn(){return++this.Nn}Mn(t){const e=[t,this.kn()];if(this.buffer.size<this.xn)this.buffer=this.buffer.add(e);else{const t=this.buffer.last();Cc(e,t)<0&&(this.buffer=this.buffer.delete(t).add(e))}}get maxValue(){return this.buffer.last()[0]}}class kc{constructor(t,e,n){this.garbageCollector=t,this.asyncQueue=e,this.localStore=n,this.On=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.Fn(6e4)}stop(){this.On&&(this.On.cancel(),this.On=null)}get started(){return null!==this.On}Fn(t){ks("LruGarbageCollector",`Garbage collection scheduled in ${t}ms`),this.On=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",t,(async()=>{this.On=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(t){Ar(t)?ks("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",t):await Er(t)}await this.Fn(3e5)}))}}class Rc{constructor(t,e){this.$n=t,this.params=e}calculateTargetCount(t,e){return this.$n.Bn(t).next((t=>Math.floor(e/100*t)))}nthSequenceNumber(t,e){if(0===e)return Tr.resolve(Or.at);const n=new Nc(e);return this.$n.forEachTarget(t,(t=>n.Mn(t.sequenceNumber))).next((()=>this.$n.Ln(t,(t=>n.Mn(t))))).next((()=>n.maxValue))}removeTargets(t,e,n){return this.$n.removeTargets(t,e,n)}removeOrphanedDocuments(t,e){return this.$n.removeOrphanedDocuments(t,e)}collect(t,e){return-1===this.params.cacheSizeCollectionThreshold?(ks("LruGarbageCollector","Garbage collection skipped; disabled"),Tr.resolve(gc)):this.getCacheSize(t).next((n=>n<this.params.cacheSizeCollectionThreshold?(ks("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),gc):this.Un(t,e)))}getCacheSize(t){return this.$n.getCacheSize(t)}Un(t,e){let n,s,r,i,o,a,u;const c=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next((e=>(e>this.params.maximumSequenceNumbersToCollect?(ks("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${e}`),s=this.params.maximumSequenceNumbersToCollect):s=e,i=Date.now(),this.nthSequenceNumber(t,s)))).next((s=>(n=s,o=Date.now(),this.removeTargets(t,n,e)))).next((e=>(r=e,a=Date.now(),this.removeOrphanedDocuments(t,n)))).next((t=>(u=Date.now(),Cs()<=w.DEBUG&&ks("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${i-c}ms\n\tDetermined least recently used ${s} in `+(o-i)+"ms\n"+`\tRemoved ${r} targets in `+(a-o)+"ms\n"+`\tRemoved ${t} documents in `+(u-a)+"ms\n"+`Total Duration: ${u-c}ms`),Tr.resolve({didRun:!0,sequenceNumbersCollected:s,targetsRemoved:r,documentsRemoved:t}))))}}class Lc{constructor(t,e){this.db=t,this.garbageCollector=function(t,e){return new Rc(t,e)}(this,e)}Bn(t){const e=this.qn(t);return this.db.getTargetCache().getTargetCount(t).next((t=>e.next((e=>t+e))))}qn(t){let e=0;return this.Ln(t,(t=>{e++})).next((()=>e))}forEachTarget(t,e){return this.db.getTargetCache().forEachTarget(t,e)}Ln(t,e){return this.Kn(t,((t,n)=>e(n)))}addReference(t,e,n){return Mc(t,n)}removeReference(t,e,n){return Mc(t,n)}removeTargets(t,e,n){return this.db.getTargetCache().removeTargets(t,e,n)}markPotentiallyOrphaned(t,e){return Mc(t,e)}Gn(t,e){return function(t,e){let n=!1;return Tc(t).tt((s=>Ic(t,s,e).next((t=>(t&&(n=!0),Tr.resolve(!t)))))).next((()=>n))}(t,e)}removeOrphanedDocuments(t,e){const n=this.db.getRemoteDocumentCache().newChangeBuffer(),s=[];let r=0;return this.Kn(t,((i,o)=>{if(o<=e){const e=this.Gn(t,i).next((e=>{if(!e)return r++,n.getEntry(t,i).next((()=>(n.removeEntry(i,sr.min()),Ac(t).delete([0,Za(i.path)]))))}));s.push(e)}})).next((()=>Tr.waitFor(s))).next((()=>n.apply(t))).next((()=>r))}removeTarget(t,e){const n=e.withSequenceNumber(t.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(t,n)}updateLimboDocument(t,e){return Mc(t,e)}Kn(t,e){const n=Ac(t);let s,r=Or.at;return n.Z({index:"documentTargetsIndex"},(([t,n],{path:i,sequenceNumber:o})=>{0===t?(r!==Or.at&&e(new ur(nu(s)),r),r=o,s=i):r=Or.at})).next((()=>{r!==Or.at&&e(new ur(nu(s)),r)}))}getCacheSize(t){return this.db.getRemoteDocumentCache().getSize(t)}}function Mc(t,e){return Ac(t).put(function(t,e){return{targetId:0,path:Za(t.path),sequenceNumber:e}}(e,t.currentSequenceNumber))}class Oc{constructor(){this.changes=new Zo((t=>t.toString()),((t,e)=>t.isEqual(e))),this.changesApplied=!1}addEntry(t){this.assertNotApplied(),this.changes.set(t.key,t)}removeEntry(t,e){this.assertNotApplied(),this.changes.set(t,Ci.newInvalidDocument(t).setReadTime(e))}getEntry(t,e){this.assertNotApplied();const n=this.changes.get(e);return void 0!==n?Tr.resolve(n):this.getFromCache(t,e)}getEntries(t,e){return this.getAllFromCache(t,e)}apply(t){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(t)}assertNotApplied(){}}class Vc{constructor(t){this.It=t}setIndexManager(t){this.indexManager=t}addEntry(t,e,n){return Uc(t).put(n)}removeEntry(t,e,n){return Uc(t).delete(function(t,e){const n=t.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],Mu(e),n[n.length-1]]}(e,n))}updateMetadata(t,e){return this.getMetadata(t).next((n=>(n.byteSize+=e,this.Qn(t,n))))}getEntry(t,e){let n=Ci.newInvalidDocument(e);return Uc(t).Z({index:"documentKeyIndex",range:IDBKeyRange.only(qc(e))},((t,s)=>{n=this.jn(e,s)})).next((()=>n))}Wn(t,e){let n={size:0,document:Ci.newInvalidDocument(e)};return Uc(t).Z({index:"documentKeyIndex",range:IDBKeyRange.only(qc(e))},((t,s)=>{n={document:this.jn(e,s),size:wc(s)}})).next((()=>n))}getEntries(t,e){let n=ea();return this.zn(t,e,((t,e)=>{const s=this.jn(t,e);n=n.insert(t,s)})).next((()=>n))}Hn(t,e){let n=ea(),s=new Br(ur.comparator);return this.zn(t,e,((t,e)=>{const r=this.jn(t,e);n=n.insert(t,r),s=s.insert(t,wc(e))})).next((()=>({documents:n,Jn:s})))}zn(t,e,n){if(e.isEmpty())return Tr.resolve();let s=new Gr(Kc);e.forEach((t=>s=s.add(t)));const r=IDBKeyRange.bound(qc(s.first()),qc(s.last())),i=s.getIterator();let o=i.getNext();return Uc(t).Z({index:"documentKeyIndex",range:r},((t,e,s)=>{const r=ur.fromSegments([...e.prefixPath,e.collectionGroup,e.documentId]);for(;o&&Kc(o,r)<0;)n(o,null),o=i.getNext();o&&o.isEqual(r)&&(n(o,e),o=i.hasNext()?i.getNext():null),o?s.j(qc(o)):s.done()})).next((()=>{for(;o;)n(o,null),o=i.hasNext()?i.getNext():null}))}getAllFromCollection(t,e,n){const s=[e.popLast().toArray(),e.lastSegment(),Mu(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],r=[e.popLast().toArray(),e.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return Uc(t).W(IDBKeyRange.bound(s,r,!0)).next((t=>{let e=ea();for(const n of t){const t=this.jn(ur.fromSegments(n.prefixPath.concat(n.collectionGroup,n.documentId)),n);e=e.insert(t.key,t)}return e}))}getAllFromCollectionGroup(t,e,n,s){let r=ea();const i=Gc(e,n),o=Gc(e,wr.max());return Uc(t).Z({index:"collectionGroupIndex",range:IDBKeyRange.bound(i,o,!0)},((t,e,n)=>{const i=this.jn(ur.fromSegments(e.prefixPath.concat(e.collectionGroup,e.documentId)),e);r=r.insert(i.key,i),r.size===s&&n.done()})).next((()=>r))}newChangeBuffer(t){return new Pc(this,!!t&&t.trackRemovals)}getSize(t){return this.getMetadata(t).next((t=>t.byteSize))}getMetadata(t){return Bc(t).get("remoteDocumentGlobalKey").next((t=>(Vs(!!t),t)))}Qn(t,e){return Bc(t).put("remoteDocumentGlobalKey",e)}jn(t,e){if(e){const t=function(t,e){let n;if(e.document)n=Pa(t.re,e.document,!!e.hasCommittedMutations);else if(e.noDocument){const t=ur.fromSegments(e.noDocument.path),s=Vu(e.noDocument.readTime);n=Ci.newNoDocument(t,s),e.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!e.unknownDocument)return Os();{const t=ur.fromSegments(e.unknownDocument.path),s=Vu(e.unknownDocument.version);n=Ci.newUnknownDocument(t,s)}}return e.readTime&&n.setReadTime(function(t){const e=new nr(t[0],t[1]);return sr.fromTimestamp(e)}(e.readTime)),n}(this.It,e);if(!t.isNoDocument()||!t.version.isEqual(sr.min()))return t}return Ci.newInvalidDocument(t)}}function Fc(t){return new Vc(t)}class Pc extends Oc{constructor(t,e){super(),this.Yn=t,this.trackRemovals=e,this.Xn=new Zo((t=>t.toString()),((t,e)=>t.isEqual(e)))}applyChanges(t){const e=[];let n=0,s=new Gr(((t,e)=>Zs(t.canonicalString(),e.canonicalString())));return this.changes.forEach(((r,i)=>{const o=this.Xn.get(r);if(e.push(this.Yn.removeEntry(t,r,o.readTime)),i.isValidDocument()){const a=Lu(this.Yn.It,i);s=s.add(r.path.popLast());const u=wc(a);n+=u-o.size,e.push(this.Yn.addEntry(t,r,a))}else if(n-=o.size,this.trackRemovals){const n=Lu(this.Yn.It,i.convertToNoDocument(sr.min()));e.push(this.Yn.addEntry(t,r,n))}})),s.forEach((n=>{e.push(this.Yn.indexManager.addToCollectionParentIndex(t,n))})),e.push(this.Yn.updateMetadata(t,n)),Tr.waitFor(e)}getFromCache(t,e){return this.Yn.Wn(t,e).next((t=>(this.Xn.set(e,{size:t.size,readTime:t.document.readTime}),t.document)))}getAllFromCache(t,e){return this.Yn.Hn(t,e).next((({documents:t,Jn:e})=>(e.forEach(((e,n)=>{this.Xn.set(e,{size:n,readTime:t.get(e).readTime})})),t)))}}function Bc(t){return _u(t,"remoteDocumentGlobal")}function Uc(t){return _u(t,"remoteDocumentsV14")}function qc(t){const e=t.path.toArray();return[e.slice(0,e.length-2),e[e.length-2],e[e.length-1]]}function Gc(t,e){const n=e.documentKey.path.toArray();return[t,Mu(e.readTime),n.slice(0,n.length-2),n.length>0?n[n.length-1]:""]}function Kc(t,e){const n=t.path.toArray(),s=e.path.toArray();let r=0;for(let t=0;t<n.length-2&&t<s.length-2;++t)if(r=Zs(n[t],s[t]),r)return r;return r=Zs(n.length,s.length),r||(r=Zs(n[n.length-2],s[s.length-2]),r||Zs(n[n.length-1],s[s.length-1]))}class jc{constructor(t,e){this.overlayedDocument=t,this.mutatedFields=e}}class $c{constructor(t,e,n,s){this.remoteDocumentCache=t,this.mutationQueue=e,this.documentOverlayCache=n,this.indexManager=s}getDocument(t,e){let n=null;return this.documentOverlayCache.getOverlay(t,e).next((s=>(n=s,this.getBaseDocument(t,e,n)))).next((t=>(null!==n&&Po(n.mutation,t,$r.empty(),nr.now()),t)))}getDocuments(t,e){return this.remoteDocumentCache.getEntries(t,e).next((e=>this.getLocalViewOfDocuments(t,e,ha()).next((()=>e))))}getLocalViewOfDocuments(t,e,n=ha()){const s=ia();return this.populateOverlays(t,s,e).next((()=>this.computeViews(t,e,s,n).next((t=>{let e=sa();return t.forEach(((t,n)=>{e=e.insert(t,n.overlayedDocument)})),e}))))}getOverlayedDocuments(t,e){const n=ia();return this.populateOverlays(t,n,e).next((()=>this.computeViews(t,e,n,ha())))}populateOverlays(t,e,n){const s=[];return n.forEach((t=>{e.has(t)||s.push(t)})),this.documentOverlayCache.getOverlays(t,s).next((t=>{t.forEach(((t,n)=>{e.set(t,n)}))}))}computeViews(t,e,n,s){let r=ea();const i=aa(),o=aa();return e.forEach(((t,e)=>{const o=n.get(e.key);s.has(e.key)&&(void 0===o||o.mutation instanceof Go)?r=r.insert(e.key,e):void 0!==o&&(i.set(e.key,o.mutation.getFieldMask()),Po(o.mutation,e,o.mutation.getFieldMask(),nr.now()))})),this.recalculateAndSaveOverlays(t,r).next((t=>(t.forEach(((t,e)=>i.set(t,e))),e.forEach(((t,e)=>{var n;return o.set(t,new jc(e,null!==(n=i.get(t))&&void 0!==n?n:null))})),o)))}recalculateAndSaveOverlays(t,e){const n=aa();let s=new Br(((t,e)=>t-e)),r=ha();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(t,e).next((t=>{for(const r of t)r.keys().forEach((t=>{const i=e.get(t);if(null===i)return;let o=n.get(t)||$r.empty();o=r.applyToLocalView(i,o),n.set(t,o);const a=(s.get(r.batchId)||ha()).add(t);s=s.insert(r.batchId,a)}))})).next((()=>{const i=[],o=s.getReverseIterator();for(;o.hasNext();){const s=o.getNext(),a=s.key,u=s.value,c=oa();u.forEach((t=>{if(!r.has(t)){const s=Vo(e.get(t),n.get(t));null!==s&&c.set(t,s),r=r.add(t)}})),i.push(this.documentOverlayCache.saveOverlays(t,a,c))}return Tr.waitFor(i)})).next((()=>n))}recalculateAndSaveOverlaysForDocumentKeys(t,e){return this.remoteDocumentCache.getEntries(t,e).next((e=>this.recalculateAndSaveOverlays(t,e)))}getDocumentsMatchingQuery(t,e,n){return function(t){return ur.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}(e)?this.getDocumentsMatchingDocumentQuery(t,e.path):ro(e)?this.getDocumentsMatchingCollectionGroupQuery(t,e,n):this.getDocumentsMatchingCollectionQuery(t,e,n)}getNextDocuments(t,e,n,s){return this.remoteDocumentCache.getAllFromCollectionGroup(t,e,n,s).next((r=>{const i=s-r.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(t,e,n.largestBatchId,s-r.size):Tr.resolve(ia());let o=-1,a=r;return i.next((e=>Tr.forEach(e,((e,n)=>(o<n.largestBatchId&&(o=n.largestBatchId),r.get(e)?Tr.resolve():this.getBaseDocument(t,e,n).next((t=>{a=a.insert(e,t)}))))).next((()=>this.populateOverlays(t,e,r))).next((()=>this.computeViews(t,a,e,ha()))).next((t=>({batchId:o,changes:ra(t)})))))}))}getDocumentsMatchingDocumentQuery(t,e){return this.getDocument(t,new ur(e)).next((t=>{let e=sa();return t.isFoundDocument()&&(e=e.insert(t.key,t)),e}))}getDocumentsMatchingCollectionGroupQuery(t,e,n){const s=e.collectionGroup;let r=sa();return this.indexManager.getCollectionParents(t,s).next((i=>Tr.forEach(i,(i=>{const o=function(t,e){return new Ji(e,null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)}(e,i.child(s));return this.getDocumentsMatchingCollectionQuery(t,o,n).next((t=>{t.forEach(((t,e)=>{r=r.insert(t,e)}))}))})).next((()=>r))))}getDocumentsMatchingCollectionQuery(t,e,n){let s;return this.remoteDocumentCache.getAllFromCollection(t,e.path,n).next((r=>(s=r,this.documentOverlayCache.getOverlaysForCollection(t,e.path,n.largestBatchId)))).next((t=>{t.forEach(((t,e)=>{const n=e.getKey();null===s.get(n)&&(s=s.insert(n,Ci.newInvalidDocument(n)))}));let n=sa();return s.forEach(((s,r)=>{const i=t.get(s);void 0!==i&&Po(i.mutation,r,$r.empty(),nr.now()),lo(e,r)&&(n=n.insert(s,r))})),n}))}getBaseDocument(t,e,n){return null===n||1===n.mutation.type?this.remoteDocumentCache.getEntry(t,e):Tr.resolve(Ci.newInvalidDocument(e))}}class zc{constructor(t){this.It=t,this.Zn=new Map,this.ts=new Map}getBundleMetadata(t,e){return Tr.resolve(this.Zn.get(e))}saveBundleMetadata(t,e){var n;return this.Zn.set(e.id,{id:(n=e).id,version:n.version,createTime:Aa(n.createTime)}),Tr.resolve()}getNamedQuery(t,e){return Tr.resolve(this.ts.get(e))}saveNamedQuery(t,e){return this.ts.set(e.name,function(t){return{name:t.name,query:Uu(t.bundledQuery),readTime:Aa(t.readTime)}}(e)),Tr.resolve()}}class Qc{constructor(){this.overlays=new Br(ur.comparator),this.es=new Map}getOverlay(t,e){return Tr.resolve(this.overlays.get(e))}getOverlays(t,e){const n=ia();return Tr.forEach(e,(e=>this.getOverlay(t,e).next((t=>{null!==t&&n.set(e,t)})))).next((()=>n))}saveOverlays(t,e,n){return n.forEach(((n,s)=>{this.ue(t,e,s)})),Tr.resolve()}removeOverlaysForBatchId(t,e,n){const s=this.es.get(n);return void 0!==s&&(s.forEach((t=>this.overlays=this.overlays.remove(t))),this.es.delete(n)),Tr.resolve()}getOverlaysForCollection(t,e,n){const s=ia(),r=e.length+1,i=new ur(e.child("")),o=this.overlays.getIteratorFrom(i);for(;o.hasNext();){const t=o.getNext().value,i=t.getKey();if(!e.isPrefixOf(i.path))break;i.path.length===r&&t.largestBatchId>n&&s.set(t.getKey(),t)}return Tr.resolve(s)}getOverlaysForCollectionGroup(t,e,n,s){let r=new Br(((t,e)=>t-e));const i=this.overlays.getIterator();for(;i.hasNext();){const t=i.getNext().value;if(t.getKey().getCollectionGroup()===e&&t.largestBatchId>n){let e=r.get(t.largestBatchId);null===e&&(e=ia(),r=r.insert(t.largestBatchId,e)),e.set(t.getKey(),t)}}const o=ia(),a=r.getIterator();for(;a.hasNext()&&(a.getNext().value.forEach(((t,e)=>o.set(t,e))),!(o.size()>=s)););return Tr.resolve(o)}ue(t,e,n){const s=this.overlays.get(n.key);if(null!==s){const t=this.es.get(s.largestBatchId).delete(n.key);this.es.set(s.largestBatchId,t)}this.overlays=this.overlays.insert(n.key,new Nu(e,n));let r=this.es.get(e);void 0===r&&(r=ha(),this.es.set(e,r)),this.es.set(e,r.add(n.key))}}class Hc{constructor(){this.ns=new Gr(Wc.ss),this.rs=new Gr(Wc.os)}isEmpty(){return this.ns.isEmpty()}addReference(t,e){const n=new Wc(t,e);this.ns=this.ns.add(n),this.rs=this.rs.add(n)}us(t,e){t.forEach((t=>this.addReference(t,e)))}removeReference(t,e){this.cs(new Wc(t,e))}hs(t,e){t.forEach((t=>this.removeReference(t,e)))}ls(t){const e=new ur(new ir([])),n=new Wc(e,t),s=new Wc(e,t+1),r=[];return this.rs.forEachInRange([n,s],(t=>{this.cs(t),r.push(t.key)})),r}fs(){this.ns.forEach((t=>this.cs(t)))}cs(t){this.ns=this.ns.delete(t),this.rs=this.rs.delete(t)}ds(t){const e=new ur(new ir([])),n=new Wc(e,t),s=new Wc(e,t+1);let r=ha();return this.rs.forEachInRange([n,s],(t=>{r=r.add(t.key)})),r}containsKey(t){const e=new Wc(t,0),n=this.ns.firstAfterOrEqual(e);return null!==n&&t.isEqual(n.key)}}class Wc{constructor(t,e){this.key=t,this._s=e}static ss(t,e){return ur.comparator(t.key,e.key)||Zs(t._s,e._s)}static os(t,e){return Zs(t._s,e._s)||ur.comparator(t.key,e.key)}}class Yc{constructor(t,e){this.indexManager=t,this.referenceDelegate=e,this.mutationQueue=[],this.ws=1,this.gs=new Gr(Wc.ss)}checkEmpty(t){return Tr.resolve(0===this.mutationQueue.length)}addMutationBatch(t,e,n,s){const r=this.ws;this.ws++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const i=new Au(r,e,n,s);this.mutationQueue.push(i);for(const e of s)this.gs=this.gs.add(new Wc(e.key,r)),this.indexManager.addToCollectionParentIndex(t,e.key.path.popLast());return Tr.resolve(i)}lookupMutationBatch(t,e){return Tr.resolve(this.ys(e))}getNextMutationBatchAfterBatchId(t,e){const n=e+1,s=this.ps(n),r=s<0?0:s;return Tr.resolve(this.mutationQueue.length>r?this.mutationQueue[r]:null)}getHighestUnacknowledgedBatchId(){return Tr.resolve(0===this.mutationQueue.length?-1:this.ws-1)}getAllMutationBatches(t){return Tr.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(t,e){const n=new Wc(e,0),s=new Wc(e,Number.POSITIVE_INFINITY),r=[];return this.gs.forEachInRange([n,s],(t=>{const e=this.ys(t._s);r.push(e)})),Tr.resolve(r)}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new Gr(Zs);return e.forEach((t=>{const e=new Wc(t,0),s=new Wc(t,Number.POSITIVE_INFINITY);this.gs.forEachInRange([e,s],(t=>{n=n.add(t._s)}))})),Tr.resolve(this.Is(n))}getAllMutationBatchesAffectingQuery(t,e){const n=e.path,s=n.length+1;let r=n;ur.isDocumentKey(r)||(r=r.child(""));const i=new Wc(new ur(r),0);let o=new Gr(Zs);return this.gs.forEachWhile((t=>{const e=t.key.path;return!!n.isPrefixOf(e)&&(e.length===s&&(o=o.add(t._s)),!0)}),i),Tr.resolve(this.Is(o))}Is(t){const e=[];return t.forEach((t=>{const n=this.ys(t);null!==n&&e.push(n)})),e}removeMutationBatch(t,e){Vs(0===this.Ts(e.batchId,"removed")),this.mutationQueue.shift();let n=this.gs;return Tr.forEach(e.mutations,(s=>{const r=new Wc(s.key,e.batchId);return n=n.delete(r),this.referenceDelegate.markPotentiallyOrphaned(t,s.key)})).next((()=>{this.gs=n}))}An(t){}containsKey(t,e){const n=new Wc(e,0),s=this.gs.firstAfterOrEqual(n);return Tr.resolve(e.isEqual(s&&s.key))}performConsistencyCheck(t){return this.mutationQueue.length,Tr.resolve()}Ts(t,e){return this.ps(t)}ps(t){return 0===this.mutationQueue.length?0:t-this.mutationQueue[0].batchId}ys(t){const e=this.ps(t);return e<0||e>=this.mutationQueue.length?null:this.mutationQueue[e]}}class Xc{constructor(t){this.Es=t,this.docs=new Br(ur.comparator),this.size=0}setIndexManager(t){this.indexManager=t}addEntry(t,e){const n=e.key,s=this.docs.get(n),r=s?s.size:0,i=this.Es(e);return this.docs=this.docs.insert(n,{document:e.mutableCopy(),size:i}),this.size+=i-r,this.indexManager.addToCollectionParentIndex(t,n.path.popLast())}removeEntry(t){const e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)}getEntry(t,e){const n=this.docs.get(e);return Tr.resolve(n?n.document.mutableCopy():Ci.newInvalidDocument(e))}getEntries(t,e){let n=ea();return e.forEach((t=>{const e=this.docs.get(t);n=n.insert(t,e?e.document.mutableCopy():Ci.newInvalidDocument(t))})),Tr.resolve(n)}getAllFromCollection(t,e,n){let s=ea();const r=new ur(e.child("")),i=this.docs.getIteratorFrom(r);for(;i.hasNext();){const{key:t,value:{document:r}}=i.getNext();if(!e.isPrefixOf(t.path))break;t.path.length>e.length+1||vr(yr(r),n)<=0||(s=s.insert(r.key,r.mutableCopy()))}return Tr.resolve(s)}getAllFromCollectionGroup(t,e,n,s){Os()}As(t,e){return Tr.forEach(this.docs,(t=>e(t)))}newChangeBuffer(t){return new Jc(this)}getSize(t){return Tr.resolve(this.size)}}class Jc extends Oc{constructor(t){super(),this.Yn=t}applyChanges(t){const e=[];return this.changes.forEach(((n,s)=>{s.isValidDocument()?e.push(this.Yn.addEntry(t,s)):this.Yn.removeEntry(n)})),Tr.waitFor(e)}getFromCache(t,e){return this.Yn.getEntry(t,e)}getAllFromCache(t,e){return this.Yn.getEntries(t,e)}}class Zc{constructor(t){this.persistence=t,this.Rs=new Zo((t=>Ri(t)),Li),this.lastRemoteSnapshotVersion=sr.min(),this.highestTargetId=0,this.bs=0,this.Ps=new Hc,this.targetCount=0,this.vs=Sc.Pn()}forEachTarget(t,e){return this.Rs.forEach(((t,n)=>e(n))),Tr.resolve()}getLastRemoteSnapshotVersion(t){return Tr.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(t){return Tr.resolve(this.bs)}allocateTargetId(t){return this.highestTargetId=this.vs.next(),Tr.resolve(this.highestTargetId)}setTargetsMetadata(t,e,n){return n&&(this.lastRemoteSnapshotVersion=n),e>this.bs&&(this.bs=e),Tr.resolve()}Dn(t){this.Rs.set(t.target,t);const e=t.targetId;e>this.highestTargetId&&(this.vs=new Sc(e),this.highestTargetId=e),t.sequenceNumber>this.bs&&(this.bs=t.sequenceNumber)}addTargetData(t,e){return this.Dn(e),this.targetCount+=1,Tr.resolve()}updateTargetData(t,e){return this.Dn(e),Tr.resolve()}removeTargetData(t,e){return this.Rs.delete(e.target),this.Ps.ls(e.targetId),this.targetCount-=1,Tr.resolve()}removeTargets(t,e,n){let s=0;const r=[];return this.Rs.forEach(((i,o)=>{o.sequenceNumber<=e&&null===n.get(o.targetId)&&(this.Rs.delete(i),r.push(this.removeMatchingKeysForTargetId(t,o.targetId)),s++)})),Tr.waitFor(r).next((()=>s))}getTargetCount(t){return Tr.resolve(this.targetCount)}getTargetData(t,e){const n=this.Rs.get(e)||null;return Tr.resolve(n)}addMatchingKeys(t,e,n){return this.Ps.us(e,n),Tr.resolve()}removeMatchingKeys(t,e,n){this.Ps.hs(e,n);const s=this.persistence.referenceDelegate,r=[];return s&&e.forEach((e=>{r.push(s.markPotentiallyOrphaned(t,e))})),Tr.waitFor(r)}removeMatchingKeysForTargetId(t,e){return this.Ps.ls(e),Tr.resolve()}getMatchingKeysForTargetId(t,e){const n=this.Ps.ds(e);return Tr.resolve(n)}containsKey(t,e){return Tr.resolve(this.Ps.containsKey(e))}}class th{constructor(t,e){this.Vs={},this.overlays={},this.Ss=new Or(0),this.Ds=!1,this.Ds=!0,this.referenceDelegate=t(this),this.Cs=new Zc(this),this.indexManager=new oc,this.remoteDocumentCache=function(t){return new Xc(t)}((t=>this.referenceDelegate.xs(t))),this.It=new Ru(e),this.Ns=new zc(this.It)}start(){return Promise.resolve()}shutdown(){return this.Ds=!1,Promise.resolve()}get started(){return this.Ds}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(t){return this.indexManager}getDocumentOverlayCache(t){let e=this.overlays[t.toKey()];return e||(e=new Qc,this.overlays[t.toKey()]=e),e}getMutationQueue(t,e){let n=this.Vs[t.toKey()];return n||(n=new Yc(e,this.referenceDelegate),this.Vs[t.toKey()]=n),n}getTargetCache(){return this.Cs}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Ns}runTransaction(t,e,n){ks("MemoryPersistence","Starting transaction:",t);const s=new eh(this.Ss.next());return this.referenceDelegate.ks(),n(s).next((t=>this.referenceDelegate.Ms(s).next((()=>t)))).toPromise().then((t=>(s.raiseOnCommittedEvent(),t)))}Os(t,e){return Tr.or(Object.values(this.Vs).map((n=>()=>n.containsKey(t,e))))}}class eh extends br{constructor(t){super(),this.currentSequenceNumber=t}}class nh{constructor(t){this.persistence=t,this.Fs=new Hc,this.$s=null}static Bs(t){return new nh(t)}get Ls(){if(this.$s)return this.$s;throw Os()}addReference(t,e,n){return this.Fs.addReference(n,e),this.Ls.delete(n.toString()),Tr.resolve()}removeReference(t,e,n){return this.Fs.removeReference(n,e),this.Ls.add(n.toString()),Tr.resolve()}markPotentiallyOrphaned(t,e){return this.Ls.add(e.toString()),Tr.resolve()}removeTarget(t,e){this.Fs.ls(e.targetId).forEach((t=>this.Ls.add(t.toString())));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(t,e.targetId).next((t=>{t.forEach((t=>this.Ls.add(t.toString())))})).next((()=>n.removeTargetData(t,e)))}ks(){this.$s=new Set}Ms(t){const e=this.persistence.getRemoteDocumentCache().newChangeBuffer();return Tr.forEach(this.Ls,(n=>{const s=ur.fromPath(n);return this.Us(t,s).next((t=>{t||e.removeEntry(s,sr.min())}))})).next((()=>(this.$s=null,e.apply(t))))}updateLimboDocument(t,e){return this.Us(t,e).next((t=>{t?this.Ls.delete(e.toString()):this.Ls.add(e.toString())}))}xs(t){return 0}Us(t,e){return Tr.or([()=>Tr.resolve(this.Fs.containsKey(e)),()=>this.persistence.getTargetCache().containsKey(t,e),()=>this.persistence.Os(t,e)])}}class sh{constructor(t){this.It=t}$(t,e,n,s){const r=new Sr("createOrUpgrade",e);n<1&&s>=1&&(function(t){t.createObjectStore("owner")}(t),function(t){t.createObjectStore("mutationQueues",{keyPath:"userId"}),t.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",su,{unique:!0}),t.createObjectStore("documentMutations")}(t),rh(t),function(t){t.createObjectStore("remoteDocuments")}(t));let i=Tr.resolve();return n<3&&s>=3&&(0!==n&&(function(t){t.deleteObjectStore("targetDocuments"),t.deleteObjectStore("targets"),t.deleteObjectStore("targetGlobal")}(t),rh(t)),i=i.next((()=>function(t){const e=t.store("targetGlobal"),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:sr.min().toTimestamp(),targetCount:0};return e.put("targetGlobalKey",n)}(r)))),n<4&&s>=4&&(0!==n&&(i=i.next((()=>function(t,e){return e.store("mutations").W().next((n=>{t.deleteObjectStore("mutations"),t.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",su,{unique:!0});const s=e.store("mutations"),r=n.map((t=>s.put(t)));return Tr.waitFor(r)}))}(t,r)))),i=i.next((()=>{!function(t){t.createObjectStore("clientMetadata",{keyPath:"clientId"})}(t)}))),n<5&&s>=5&&(i=i.next((()=>this.qs(r)))),n<6&&s>=6&&(i=i.next((()=>(function(t){t.createObjectStore("remoteDocumentGlobal")}(t),this.Ks(r))))),n<7&&s>=7&&(i=i.next((()=>this.Gs(r)))),n<8&&s>=8&&(i=i.next((()=>this.Qs(t,r)))),n<9&&s>=9&&(i=i.next((()=>{!function(t){t.objectStoreNames.contains("remoteDocumentChanges")&&t.deleteObjectStore("remoteDocumentChanges")}(t)}))),n<10&&s>=10&&(i=i.next((()=>this.js(r)))),n<11&&s>=11&&(i=i.next((()=>{!function(t){t.createObjectStore("bundles",{keyPath:"bundleId"})}(t),function(t){t.createObjectStore("namedQueries",{keyPath:"name"})}(t)}))),n<12&&s>=12&&(i=i.next((()=>{!function(t){const e=t.createObjectStore("documentOverlays",{keyPath:wu});e.createIndex("collectionPathOverlayIndex",vu,{unique:!1}),e.createIndex("collectionGroupOverlayIndex",Iu,{unique:!1})}(t)}))),n<13&&s>=13&&(i=i.next((()=>function(t){const e=t.createObjectStore("remoteDocumentsV14",{keyPath:au});e.createIndex("documentKeyIndex",uu),e.createIndex("collectionGroupIndex",cu)}(t))).next((()=>this.Ws(t,r))).next((()=>t.deleteObjectStore("remoteDocuments")))),n<14&&s>=14&&(i=i.next((()=>this.zs(t,r)))),n<15&&s>=15&&(i=i.next((()=>function(t){t.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),t.createObjectStore("indexState",{keyPath:mu}).createIndex("sequenceNumberIndex",gu,{unique:!1}),t.createObjectStore("indexEntries",{keyPath:pu}).createIndex("documentKeyIndex",yu,{unique:!1})}(t)))),i}Ks(t){let e=0;return t.store("remoteDocuments").Z(((t,n)=>{e+=wc(n)})).next((()=>{const n={byteSize:e};return t.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",n)}))}qs(t){const e=t.store("mutationQueues"),n=t.store("mutations");return e.W().next((e=>Tr.forEach(e,(e=>{const s=IDBKeyRange.bound([e.userId,-1],[e.userId,e.lastAcknowledgedBatchId]);return n.W("userMutationsIndex",s).next((n=>Tr.forEach(n,(n=>{Vs(n.userId===e.userId);const s=Fu(this.It,n);return yc(t,e.userId,s).next((()=>{}))}))))}))))}Gs(t){const e=t.store("targetDocuments"),n=t.store("remoteDocuments");return t.store("targetGlobal").get("targetGlobalKey").next((t=>{const s=[];return n.Z(((n,r)=>{const i=new ir(n),o=function(t){return[0,Za(t)]}(i);s.push(e.get(o).next((n=>n?Tr.resolve():(n=>e.put({targetId:0,path:Za(n),sequenceNumber:t.highestListenSequenceNumber}))(i))))})).next((()=>Tr.waitFor(s)))}))}Qs(t,e){t.createObjectStore("collectionParents",{keyPath:fu});const n=e.store("collectionParents"),s=new ac,r=t=>{if(s.add(t)){const e=t.lastSegment(),s=t.popLast();return n.put({collectionId:e,parent:Za(s)})}};return e.store("remoteDocuments").Z({X:!0},((t,e)=>{const n=new ir(t);return r(n.popLast())})).next((()=>e.store("documentMutations").Z({X:!0},(([t,e,n],s)=>{const i=nu(e);return r(i.popLast())}))))}js(t){const e=t.store("targets");return e.Z(((t,n)=>{const s=Pu(n),r=Bu(this.It,s);return e.put(r)}))}Ws(t,e){const n=e.store("remoteDocuments"),s=[];return n.Z(((t,n)=>{const r=e.store("remoteDocumentsV14"),i=(o=n,o.document?new ur(ir.fromString(o.document.name).popFirst(5)):o.noDocument?ur.fromSegments(o.noDocument.path):o.unknownDocument?ur.fromSegments(o.unknownDocument.path):Os()).path.toArray();var o;const a={prefixPath:i.slice(0,i.length-2),collectionGroup:i[i.length-2],documentId:i[i.length-1],readTime:n.readTime||[0,0],unknownDocument:n.unknownDocument,noDocument:n.noDocument,document:n.document,hasCommittedMutations:!!n.hasCommittedMutations};s.push(r.put(a))})).next((()=>Tr.waitFor(s)))}zs(t,e){const n=e.store("mutations"),s=Fc(this.It),r=new th(nh.Bs,this.It.re);return n.W().next((t=>{const n=new Map;return t.forEach((t=>{var e;let s=null!==(e=n.get(t.userId))&&void 0!==e?e:ha();Fu(this.It,t).keys().forEach((t=>s=s.add(t))),n.set(t.userId,s)})),Tr.forEach(n,((t,n)=>{const i=new Ds(n),o=Qu.oe(this.It,i),a=r.getIndexManager(i),u=vc.oe(i,this.It,a,r.referenceDelegate);return new $c(s,u,o,a).recalculateAndSaveOverlaysForDocumentKeys(new Du(e,Or.at),t).next()}))}))}}function rh(t){t.createObjectStore("targetDocuments",{keyPath:lu}).createIndex("documentTargetsIndex",du,{unique:!0}),t.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",hu,{unique:!0}),t.createObjectStore("targetGlobal")}const ih="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class oh{constructor(t,e,n,s,r,i,o,a,u,c,h=15){if(this.allowTabSynchronization=t,this.persistenceKey=e,this.clientId=n,this.Hs=r,this.window=i,this.document=o,this.Js=u,this.Ys=c,this.Xs=h,this.Ss=null,this.Ds=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Zs=null,this.inForeground=!1,this.ti=null,this.ei=null,this.ni=Number.NEGATIVE_INFINITY,this.si=t=>Promise.resolve(),!oh.C())throw new Us(Bs.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new Lc(this,s),this.ii=e+"main",this.It=new Ru(a),this.ri=new xr(this.ii,this.Xs,new sh(this.It)),this.Cs=new xc(this.referenceDelegate,this.It),this.remoteDocumentCache=Fc(this.It),this.Ns=new ju,this.window&&this.window.localStorage?this.oi=this.window.localStorage:(this.oi=null,!1===c&&Rs("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.ui().then((()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new Us(Bs.FAILED_PRECONDITION,ih);return this.ci(),this.ai(),this.hi(),this.runTransaction("getHighestListenSequenceNumber","readonly",(t=>this.Cs.getHighestSequenceNumber(t)))})).then((t=>{this.Ss=new Or(t,this.Js)})).then((()=>{this.Ds=!0})).catch((t=>(this.ri&&this.ri.close(),Promise.reject(t))))}li(t){return this.si=async e=>{if(this.started)return t(e)},t(this.isPrimary)}setDatabaseDeletedListener(t){this.ri.L((async e=>{null===e.newVersion&&await t()}))}setNetworkEnabled(t){this.networkEnabled!==t&&(this.networkEnabled=t,this.Hs.enqueueAndForget((async()=>{this.started&&await this.ui()})))}ui(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",(t=>uh(t).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next((()=>{if(this.isPrimary)return this.fi(t).next((t=>{t||(this.isPrimary=!1,this.Hs.enqueueRetryable((()=>this.si(!1))))}))})).next((()=>this.di(t))).next((e=>this.isPrimary&&!e?this._i(t).next((()=>!1)):!!e&&this.wi(t).next((()=>!0)))))).catch((t=>{if(Ar(t))return ks("IndexedDbPersistence","Failed to extend owner lease: ",t),this.isPrimary;if(!this.allowTabSynchronization)throw t;return ks("IndexedDbPersistence","Releasing owner lease after error during lease refresh",t),!1})).then((t=>{this.isPrimary!==t&&this.Hs.enqueueRetryable((()=>this.si(t))),this.isPrimary=t}))}fi(t){return ah(t).get("owner").next((t=>Tr.resolve(this.mi(t))))}gi(t){return uh(t).delete(this.clientId)}async yi(){if(this.isPrimary&&!this.pi(this.ni,18e5)){this.ni=Date.now();const t=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",(t=>{const e=_u(t,"clientMetadata");return e.W().next((t=>{const n=this.Ii(t,18e5),s=t.filter((t=>-1===n.indexOf(t)));return Tr.forEach(s,(t=>e.delete(t.clientId))).next((()=>s))}))})).catch((()=>[]));if(this.oi)for(const e of t)this.oi.removeItem(this.Ti(e.clientId))}}hi(){this.ei=this.Hs.enqueueAfterDelay("client_metadata_refresh",4e3,(()=>this.ui().then((()=>this.yi())).then((()=>this.hi()))))}mi(t){return!!t&&t.ownerId===this.clientId}di(t){return this.Ys?Tr.resolve(!0):ah(t).get("owner").next((e=>{if(null!==e&&this.pi(e.leaseTimestampMs,5e3)&&!this.Ei(e.ownerId)){if(this.mi(e)&&this.networkEnabled)return!0;if(!this.mi(e)){if(!e.allowTabSynchronization)throw new Us(Bs.FAILED_PRECONDITION,ih);return!1}}return!(!this.networkEnabled||!this.inForeground)||uh(t).W().next((t=>void 0===this.Ii(t,5e3).find((t=>{if(this.clientId!==t.clientId){const e=!this.networkEnabled&&t.networkEnabled,n=!this.inForeground&&t.inForeground,s=this.networkEnabled===t.networkEnabled;if(e||n&&s)return!0}return!1}))))})).next((t=>(this.isPrimary!==t&&ks("IndexedDbPersistence",`Client ${t?"is":"is not"} eligible for a primary lease.`),t)))}async shutdown(){this.Ds=!1,this.Ai(),this.ei&&(this.ei.cancel(),this.ei=null),this.Ri(),this.bi(),await this.ri.runTransaction("shutdown","readwrite",["owner","clientMetadata"],(t=>{const e=new Du(t,Or.at);return this._i(e).next((()=>this.gi(e)))})),this.ri.close(),this.Pi()}Ii(t,e){return t.filter((t=>this.pi(t.updateTimeMs,e)&&!this.Ei(t.clientId)))}vi(){return this.runTransaction("getActiveClients","readonly",(t=>uh(t).W().next((t=>this.Ii(t,18e5).map((t=>t.clientId))))))}get started(){return this.Ds}getMutationQueue(t,e){return vc.oe(t,this.It,e,this.referenceDelegate)}getTargetCache(){return this.Cs}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(t){return new cc(t,this.It.re.databaseId)}getDocumentOverlayCache(t){return Qu.oe(this.It,t)}getBundleCache(){return this.Ns}runTransaction(t,e,n){ks("IndexedDbPersistence","Starting transaction:",t);const s="readonly"===e?"readonly":"readwrite",r=15===(i=this.Xs)?xu:14===i?Su:13===i?Tu:12===i?Eu:11===i?bu:void Os();var i;let o;return this.ri.runTransaction(t,s,r,(s=>(o=new Du(s,this.Ss?this.Ss.next():Or.at),"readwrite-primary"===e?this.fi(o).next((t=>!!t||this.di(o))).next((e=>{if(!e)throw Rs(`Failed to obtain primary lease for action '${t}'.`),this.isPrimary=!1,this.Hs.enqueueRetryable((()=>this.si(!1))),new Us(Bs.FAILED_PRECONDITION,Ir);return n(o)})).next((t=>this.wi(o).next((()=>t)))):this.Vi(o).next((()=>n(o)))))).then((t=>(o.raiseOnCommittedEvent(),t)))}Vi(t){return ah(t).get("owner").next((t=>{if(null!==t&&this.pi(t.leaseTimestampMs,5e3)&&!this.Ei(t.ownerId)&&!this.mi(t)&&!(this.Ys||this.allowTabSynchronization&&t.allowTabSynchronization))throw new Us(Bs.FAILED_PRECONDITION,ih)}))}wi(t){const e={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return ah(t).put("owner",e)}static C(){return xr.C()}_i(t){const e=ah(t);return e.get("owner").next((t=>this.mi(t)?(ks("IndexedDbPersistence","Releasing primary lease."),e.delete("owner")):Tr.resolve()))}pi(t,e){const n=Date.now();return!(t<n-e||t>n&&(Rs(`Detected an update time that is in the future: ${t} > ${n}`),1))}ci(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.ti=()=>{this.Hs.enqueueAndForget((()=>(this.inForeground="visible"===this.document.visibilityState,this.ui())))},this.document.addEventListener("visibilitychange",this.ti),this.inForeground="visible"===this.document.visibilityState)}Ri(){this.ti&&(this.document.removeEventListener("visibilitychange",this.ti),this.ti=null)}ai(){var t;"function"==typeof(null===(t=this.window)||void 0===t?void 0:t.addEventListener)&&(this.Zs=()=>{this.Ai(),h()&&navigator.appVersion.match(/Version\/1[45]/)&&this.Hs.enterRestrictedMode(!0),this.Hs.enqueueAndForget((()=>this.shutdown()))},this.window.addEventListener("pagehide",this.Zs))}bi(){this.Zs&&(this.window.removeEventListener("pagehide",this.Zs),this.Zs=null)}Ei(t){var e;try{const n=null!==(null===(e=this.oi)||void 0===e?void 0:e.getItem(this.Ti(t)));return ks("IndexedDbPersistence",`Client '${t}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(t){return Rs("IndexedDbPersistence","Failed to get zombied client id.",t),!1}}Ai(){if(this.oi)try{this.oi.setItem(this.Ti(this.clientId),String(Date.now()))}catch(t){Rs("Failed to set zombie client id.",t)}}Pi(){if(this.oi)try{this.oi.removeItem(this.Ti(this.clientId))}catch(t){}}Ti(t){return`firestore_zombie_${this.persistenceKey}_${t}`}}function ah(t){return _u(t,"owner")}function uh(t){return _u(t,"clientMetadata")}function ch(t,e){let n=t.projectId;return t.isDefaultDatabase||(n+="."+t.database),"firestore/"+e+"/"+n+"/"}class hh{constructor(t,e,n,s){this.targetId=t,this.fromCache=e,this.Si=n,this.Di=s}static Ci(t,e){let n=ha(),s=ha();for(const t of e.docChanges)switch(t.type){case 0:n=n.add(t.doc.key);break;case 1:s=s.add(t.doc.key)}return new hh(t,e.fromCache,n,s)}}class lh{constructor(){this.xi=!1}initialize(t,e){this.Ni=t,this.indexManager=e,this.xi=!0}getDocumentsMatchingQuery(t,e,n,s){return this.ki(t,e).next((r=>r||this.Mi(t,e,s,n))).next((n=>n||this.Oi(t,e)))}ki(t,e){if(eo(e))return Tr.resolve(null);let n=oo(e);return this.indexManager.getIndexType(t,n).next((s=>0===s?null:(null!==e.limit&&1===s&&(e=ao(e,null,"F"),n=oo(e)),this.indexManager.getDocumentsMatchingTarget(t,n).next((s=>{const r=ha(...s);return this.Ni.getDocuments(t,r).next((s=>this.indexManager.getMinOffset(t,n).next((n=>{const i=this.Fi(e,s);return this.$i(e,i,r,n.readTime)?this.ki(t,ao(e,null,"F")):this.Bi(t,i,e,n)}))))})))))}Mi(t,e,n,s){return eo(e)||s.isEqual(sr.min())?this.Oi(t,e):this.Ni.getDocuments(t,n).next((r=>{const i=this.Fi(e,r);return this.$i(e,i,n,s)?this.Oi(t,e):(Cs()<=w.DEBUG&&ks("QueryEngine","Re-using previous result from %s to execute query: %s",s.toString(),ho(e)),this.Bi(t,i,e,pr(s,-1)))}))}Fi(t,e){let n=new Gr(mo(t));return e.forEach(((e,s)=>{lo(t,s)&&(n=n.add(s))})),n}$i(t,e,n,s){if(null===t.limit)return!1;if(n.size!==e.size)return!0;const r="F"===t.limitType?e.last():e.first();return!!r&&(r.hasPendingWrites||r.version.compareTo(s)>0)}Oi(t,e){return Cs()<=w.DEBUG&&ks("QueryEngine","Using full collection scan to execute query:",ho(e)),this.Ni.getDocumentsMatchingQuery(t,e,wr.min())}Bi(t,e,n,s){return this.Ni.getDocumentsMatchingQuery(t,n,s).next((t=>(e.forEach((e=>{t=t.insert(e.key,e)})),t)))}}class dh{constructor(t,e,n,s){this.persistence=t,this.Li=e,this.It=s,this.Ui=new Br(Zs),this.qi=new Zo((t=>Ri(t)),Li),this.Ki=new Map,this.Gi=t.getRemoteDocumentCache(),this.Cs=t.getTargetCache(),this.Ns=t.getBundleCache(),this.Qi(n)}Qi(t){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(t),this.indexManager=this.persistence.getIndexManager(t),this.mutationQueue=this.persistence.getMutationQueue(t,this.indexManager),this.localDocuments=new $c(this.Gi,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.Gi.setIndexManager(this.indexManager),this.Li.initialize(this.localDocuments,this.indexManager)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",(e=>t.collect(e,this.Ui)))}}function fh(t,e,n,s){return new dh(t,e,n,s)}async function mh(t,e){const n=Ps(t);return await n.persistence.runTransaction("Handle user change","readonly",(t=>{let s;return n.mutationQueue.getAllMutationBatches(t).next((r=>(s=r,n.Qi(e),n.mutationQueue.getAllMutationBatches(t)))).next((e=>{const r=[],i=[];let o=ha();for(const t of s){r.push(t.batchId);for(const e of t.mutations)o=o.add(e.key)}for(const t of e){i.push(t.batchId);for(const e of t.mutations)o=o.add(e.key)}return n.localDocuments.getDocuments(t,o).next((t=>({ji:t,removedBatchIds:r,addedBatchIds:i})))}))}))}function gh(t){const e=Ps(t);return e.persistence.runTransaction("Get last remote snapshot version","readonly",(t=>e.Cs.getLastRemoteSnapshotVersion(t)))}function ph(t,e,n){let s=ha(),r=ha();return n.forEach((t=>s=s.add(t))),e.getEntries(t,s).next((t=>{let s=ea();return n.forEach(((n,i)=>{const o=t.get(n);i.isFoundDocument()!==o.isFoundDocument()&&(r=r.add(n)),i.isNoDocument()&&i.version.isEqual(sr.min())?(e.removeEntry(n,i.readTime),s=s.insert(n,i)):!o.isValidDocument()||i.version.compareTo(o.version)>0||0===i.version.compareTo(o.version)&&o.hasPendingWrites?(e.addEntry(i),s=s.insert(n,i)):ks("LocalStore","Ignoring outdated watch update for ",n,". Current version:",o.version," Watch version:",i.version)})),{Wi:s,zi:r}}))}function yh(t,e){const n=Ps(t);return n.persistence.runTransaction("Get next mutation batch","readonly",(t=>(void 0===e&&(e=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(t,e))))}function wh(t,e){const n=Ps(t);return n.persistence.runTransaction("Allocate target","readwrite",(t=>{let s;return n.Cs.getTargetData(t,e).next((r=>r?(s=r,Tr.resolve(s)):n.Cs.allocateTargetId(t).next((r=>(s=new ku(e,r,0,t.currentSequenceNumber),n.Cs.addTargetData(t,s).next((()=>s)))))))})).then((t=>{const s=n.Ui.get(t.targetId);return(null===s||t.snapshotVersion.compareTo(s.snapshotVersion)>0)&&(n.Ui=n.Ui.insert(t.targetId,t),n.qi.set(e,t.targetId)),t}))}async function vh(t,e,n){const s=Ps(t),r=s.Ui.get(e),i=n?"readwrite":"readwrite-primary";try{n||await s.persistence.runTransaction("Release target",i,(t=>s.persistence.referenceDelegate.removeTarget(t,r)))}catch(t){if(!Ar(t))throw t;ks("LocalStore",`Failed to update sequence numbers for target ${e}: ${t}`)}s.Ui=s.Ui.remove(e),s.qi.delete(r.target)}function Ih(t,e,n){const s=Ps(t);let r=sr.min(),i=ha();return s.persistence.runTransaction("Execute query","readonly",(t=>function(t,e,n){const s=Ps(t),r=s.qi.get(n);return void 0!==r?Tr.resolve(s.Ui.get(r)):s.Cs.getTargetData(e,n)}(s,t,oo(e)).next((e=>{if(e)return r=e.lastLimboFreeSnapshotVersion,s.Cs.getMatchingKeysForTargetId(t,e.targetId).next((t=>{i=t}))})).next((()=>s.Li.getDocumentsMatchingQuery(t,e,n?r:sr.min(),n?i:ha()))).next((t=>(Th(s,fo(e),t),{documents:t,Hi:i})))))}function bh(t,e){const n=Ps(t),s=Ps(n.Cs),r=n.Ui.get(e);return r?Promise.resolve(r.target):n.persistence.runTransaction("Get target data","readonly",(t=>s.se(t,e).next((t=>t?t.target:null))))}function Eh(t,e){const n=Ps(t),s=n.Ki.get(e)||sr.min();return n.persistence.runTransaction("Get new document changes","readonly",(t=>n.Gi.getAllFromCollectionGroup(t,e,pr(s,-1),Number.MAX_SAFE_INTEGER))).then((t=>(Th(n,e,t),t)))}function Th(t,e,n){let s=sr.min();n.forEach(((t,e)=>{e.readTime.compareTo(s)>0&&(s=e.readTime)})),t.Ki.set(e,s)}async function Sh(t,e,n=ha()){const s=await wh(t,oo(Uu(e.bundledQuery))),r=Ps(t);return r.persistence.runTransaction("Save named query","readwrite",(t=>{const i=Aa(e.readTime);if(s.snapshotVersion.compareTo(i)>=0)return r.Ns.saveNamedQuery(t,e);const o=s.withResumeToken(Qr.EMPTY_BYTE_STRING,i);return r.Ui=r.Ui.insert(o.targetId,o),r.Cs.updateTargetData(t,o).next((()=>r.Cs.removeMatchingKeysForTargetId(t,s.targetId))).next((()=>r.Cs.addMatchingKeys(t,n,s.targetId))).next((()=>r.Ns.saveNamedQuery(t,e)))}))}function xh(t,e){return`firestore_clients_${t}_${e}`}function Dh(t,e,n){let s=`firestore_mutations_${t}_${n}`;return e.isAuthenticated()&&(s+=`_${e.uid}`),s}function _h(t,e){return`firestore_targets_${t}_${e}`}class Ah{constructor(t,e,n,s){this.user=t,this.batchId=e,this.state=n,this.error=s}static Zi(t,e,n){const s=JSON.parse(n);let r,i="object"==typeof s&&-1!==["pending","acknowledged","rejected"].indexOf(s.state)&&(void 0===s.error||"object"==typeof s.error);return i&&s.error&&(i="string"==typeof s.error.message&&"string"==typeof s.error.code,i&&(r=new Us(s.error.code,s.error.message))),i?new Ah(t,e,s.state,r):(Rs("SharedClientState",`Failed to parse mutation state for ID '${e}': ${n}`),null)}tr(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class Ch{constructor(t,e,n){this.targetId=t,this.state=e,this.error=n}static Zi(t,e){const n=JSON.parse(e);let s,r="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return r&&n.error&&(r="string"==typeof n.error.message&&"string"==typeof n.error.code,r&&(s=new Us(n.error.code,n.error.message))),r?new Ch(t,n.state,s):(Rs("SharedClientState",`Failed to parse target state for ID '${t}': ${e}`),null)}tr(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class Nh{constructor(t,e){this.clientId=t,this.activeTargetIds=e}static Zi(t,e){const n=JSON.parse(e);let s="object"==typeof n&&n.activeTargetIds instanceof Array,r=da();for(let t=0;s&&t<n.activeTargetIds.length;++t)s=ii(n.activeTargetIds[t]),r=r.add(n.activeTargetIds[t]);return s?new Nh(t,r):(Rs("SharedClientState",`Failed to parse client data for instance '${t}': ${e}`),null)}}class kh{constructor(t,e){this.clientId=t,this.onlineState=e}static Zi(t){const e=JSON.parse(t);return"object"==typeof e&&-1!==["Unknown","Online","Offline"].indexOf(e.onlineState)&&"string"==typeof e.clientId?new kh(e.clientId,e.onlineState):(Rs("SharedClientState",`Failed to parse online state: ${t}`),null)}}class Rh{constructor(){this.activeTargetIds=da()}er(t){this.activeTargetIds=this.activeTargetIds.add(t)}nr(t){this.activeTargetIds=this.activeTargetIds.delete(t)}tr(){const t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)}}class Lh{constructor(t,e,n,s,r){this.window=t,this.Hs=e,this.persistenceKey=n,this.sr=s,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.ir=this.rr.bind(this),this.ur=new Br(Zs),this.started=!1,this.cr=[];const i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=r,this.ar=xh(this.persistenceKey,this.sr),this.hr=function(t){return`firestore_sequence_number_${t}`}(this.persistenceKey),this.ur=this.ur.insert(this.sr,new Rh),this.lr=new RegExp(`^firestore_clients_${i}_([^_]*)$`),this.dr=new RegExp(`^firestore_mutations_${i}_(\\d+)(?:_(.*))?$`),this._r=new RegExp(`^firestore_targets_${i}_(\\d+)$`),this.wr=function(t){return`firestore_online_state_${t}`}(this.persistenceKey),this.mr=function(t){return`firestore_bundle_loaded_v2_${t}`}(this.persistenceKey),this.window.addEventListener("storage",this.ir)}static C(t){return!(!t||!t.localStorage)}async start(){const t=await this.syncEngine.vi();for(const e of t){if(e===this.sr)continue;const t=this.getItem(xh(this.persistenceKey,e));if(t){const n=Nh.Zi(e,t);n&&(this.ur=this.ur.insert(n.clientId,n))}}this.gr();const e=this.storage.getItem(this.wr);if(e){const t=this.yr(e);t&&this.pr(t)}for(const t of this.cr)this.rr(t);this.cr=[],this.window.addEventListener("pagehide",(()=>this.shutdown())),this.started=!0}writeSequenceNumber(t){this.setItem(this.hr,JSON.stringify(t))}getAllActiveQueryTargets(){return this.Ir(this.ur)}isActiveQueryTarget(t){let e=!1;return this.ur.forEach(((n,s)=>{s.activeTargetIds.has(t)&&(e=!0)})),e}addPendingMutation(t){this.Tr(t,"pending")}updateMutationState(t,e,n){this.Tr(t,e,n),this.Er(t)}addLocalQueryTarget(t){let e="not-current";if(this.isActiveQueryTarget(t)){const n=this.storage.getItem(_h(this.persistenceKey,t));if(n){const s=Ch.Zi(t,n);s&&(e=s.state)}}return this.Ar.er(t),this.gr(),e}removeLocalQueryTarget(t){this.Ar.nr(t),this.gr()}isLocalQueryTarget(t){return this.Ar.activeTargetIds.has(t)}clearQueryState(t){this.removeItem(_h(this.persistenceKey,t))}updateQueryState(t,e,n){this.Rr(t,e,n)}handleUserChange(t,e,n){e.forEach((t=>{this.Er(t)})),this.currentUser=t,n.forEach((t=>{this.addPendingMutation(t)}))}setOnlineState(t){this.br(t)}notifyBundleLoaded(t){this.Pr(t)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.ir),this.removeItem(this.ar),this.started=!1)}getItem(t){const e=this.storage.getItem(t);return ks("SharedClientState","READ",t,e),e}setItem(t,e){ks("SharedClientState","SET",t,e),this.storage.setItem(t,e)}removeItem(t){ks("SharedClientState","REMOVE",t),this.storage.removeItem(t)}rr(t){const e=t;if(e.storageArea===this.storage){if(ks("SharedClientState","EVENT",e.key,e.newValue),e.key===this.ar)return void Rs("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.Hs.enqueueRetryable((async()=>{if(this.started){if(null!==e.key)if(this.lr.test(e.key)){if(null==e.newValue){const t=this.vr(e.key);return this.Vr(t,null)}{const t=this.Sr(e.key,e.newValue);if(t)return this.Vr(t.clientId,t)}}else if(this.dr.test(e.key)){if(null!==e.newValue){const t=this.Dr(e.key,e.newValue);if(t)return this.Cr(t)}}else if(this._r.test(e.key)){if(null!==e.newValue){const t=this.Nr(e.key,e.newValue);if(t)return this.kr(t)}}else if(e.key===this.wr){if(null!==e.newValue){const t=this.yr(e.newValue);if(t)return this.pr(t)}}else if(e.key===this.hr){const t=function(t){let e=Or.at;if(null!=t)try{const n=JSON.parse(t);Vs("number"==typeof n),e=n}catch(t){Rs("SharedClientState","Failed to read sequence number from WebStorage",t)}return e}(e.newValue);t!==Or.at&&this.sequenceNumberHandler(t)}else if(e.key===this.mr){const t=this.Mr(e.newValue);await Promise.all(t.map((t=>this.syncEngine.Or(t))))}}else this.cr.push(e)}))}}get Ar(){return this.ur.get(this.sr)}gr(){this.setItem(this.ar,this.Ar.tr())}Tr(t,e,n){const s=new Ah(this.currentUser,t,e,n),r=Dh(this.persistenceKey,this.currentUser,t);this.setItem(r,s.tr())}Er(t){const e=Dh(this.persistenceKey,this.currentUser,t);this.removeItem(e)}br(t){const e={clientId:this.sr,onlineState:t};this.storage.setItem(this.wr,JSON.stringify(e))}Rr(t,e,n){const s=_h(this.persistenceKey,t),r=new Ch(t,e,n);this.setItem(s,r.tr())}Pr(t){const e=JSON.stringify(Array.from(t));this.setItem(this.mr,e)}vr(t){const e=this.lr.exec(t);return e?e[1]:null}Sr(t,e){const n=this.vr(t);return Nh.Zi(n,e)}Dr(t,e){const n=this.dr.exec(t),s=Number(n[1]),r=void 0!==n[2]?n[2]:null;return Ah.Zi(new Ds(r),s,e)}Nr(t,e){const n=this._r.exec(t),s=Number(n[1]);return Ch.Zi(s,e)}yr(t){return kh.Zi(t)}Mr(t){return JSON.parse(t)}async Cr(t){if(t.user.uid===this.currentUser.uid)return this.syncEngine.Fr(t.batchId,t.state,t.error);ks("SharedClientState",`Ignoring mutation for non-active user ${t.user.uid}`)}kr(t){return this.syncEngine.$r(t.targetId,t.state,t.error)}Vr(t,e){const n=e?this.ur.insert(t,e):this.ur.remove(t),s=this.Ir(this.ur),r=this.Ir(n),i=[],o=[];return r.forEach((t=>{s.has(t)||i.push(t)})),s.forEach((t=>{r.has(t)||o.push(t)})),this.syncEngine.Br(i,o).then((()=>{this.ur=n}))}pr(t){this.ur.get(t.clientId)&&this.onlineStateHandler(t.onlineState)}Ir(t){let e=da();return t.forEach(((t,n)=>{e=e.unionWith(n.activeTargetIds)})),e}}class Mh{constructor(){this.Lr=new Rh,this.Ur={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(t){}updateMutationState(t,e,n){}addLocalQueryTarget(t){return this.Lr.er(t),this.Ur[t]||"not-current"}updateQueryState(t,e,n){this.Ur[t]=e}removeLocalQueryTarget(t){this.Lr.nr(t)}isLocalQueryTarget(t){return this.Lr.activeTargetIds.has(t)}clearQueryState(t){delete this.Ur[t]}getAllActiveQueryTargets(){return this.Lr.activeTargetIds}isActiveQueryTarget(t){return this.Lr.activeTargetIds.has(t)}start(){return this.Lr=new Rh,Promise.resolve()}handleUserChange(t,e,n){}setOnlineState(t){}shutdown(){}writeSequenceNumber(t){}notifyBundleLoaded(t){}}class Oh{qr(t){}shutdown(){}}class Vh{constructor(){this.Kr=()=>this.Gr(),this.Qr=()=>this.jr(),this.Wr=[],this.zr()}qr(t){this.Wr.push(t)}shutdown(){window.removeEventListener("online",this.Kr),window.removeEventListener("offline",this.Qr)}zr(){window.addEventListener("online",this.Kr),window.addEventListener("offline",this.Qr)}Gr(){ks("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const t of this.Wr)t(0)}jr(){ks("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const t of this.Wr)t(1)}static C(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}const Fh={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery"};class Ph{constructor(t){this.Hr=t.Hr,this.Jr=t.Jr}Yr(t){this.Xr=t}Zr(t){this.eo=t}onMessage(t){this.no=t}close(){this.Jr()}send(t){this.Hr(t)}so(){this.Xr()}io(t){this.eo(t)}ro(t){this.no(t)}}class Bh extends class{constructor(t){this.databaseInfo=t,this.databaseId=t.databaseId;const e=t.ssl?"https":"http";this.oo=e+"://"+t.host,this.uo="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}co(t,e,n,s,r){const i=this.ao(t,e);ks("RestConnection","Sending: ",i,n);const o={};return this.ho(o,s,r),this.lo(t,i,o,n).then((t=>(ks("RestConnection","Received: ",t),t)),(e=>{throw Ls("RestConnection",`${t} failed with error: `,e,"url: ",i,"request:",n),e}))}fo(t,e,n,s,r,i){return this.co(t,e,n,s,r)}ho(t,e,n){t["X-Goog-Api-Client"]="gl-js/ fire/"+_s,t["Content-Type"]="text/plain",this.databaseInfo.appId&&(t["X-Firebase-GMPID"]=this.databaseInfo.appId),e&&e.headers.forEach(((e,n)=>t[n]=e)),n&&n.headers.forEach(((e,n)=>t[n]=e))}ao(t,e){const n=Fh[t];return`${this.oo}/v1/${e}:${n}`}}{constructor(t){super(t),this.forceLongPolling=t.forceLongPolling,this.autoDetectLongPolling=t.autoDetectLongPolling,this.useFetchStreams=t.useFetchStreams}lo(t,e,n,s){return new Promise(((r,i)=>{const o=new Ss;o.listenOnce(ws.COMPLETE,(()=>{try{switch(o.getLastErrorCode()){case ys.NO_ERROR:const e=o.getResponseJson();ks("Connection","XHR received:",JSON.stringify(e)),r(e);break;case ys.TIMEOUT:ks("Connection",'RPC "'+t+'" timed out'),i(new Us(Bs.DEADLINE_EXCEEDED,"Request time out"));break;case ys.HTTP_ERROR:const n=o.getStatus();if(ks("Connection",'RPC "'+t+'" failed with status:',n,"response text:",o.getResponseText()),n>0){const t=o.getResponseJson().error;if(t&&t.status&&t.message){const e=function(t){const e=t.toLowerCase().replace(/_/g,"-");return Object.values(Bs).indexOf(e)>=0?e:Bs.UNKNOWN}(t.status);i(new Us(e,t.message))}else i(new Us(Bs.UNKNOWN,"Server responded with status "+o.getStatus()))}else i(new Us(Bs.UNAVAILABLE,"Connection failed."));break;default:Os()}}finally{ks("Connection",'RPC "'+t+'" completed.')}}));const a=JSON.stringify(s);o.send(e,"POST",a,n,15)}))}_o(t,e,n){const s=[this.oo,"/","google.firestore.v1.Firestore","/",t,"/channel"],r=new ds,i=he(),o={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling};this.useFetchStreams&&(o.xmlHttpFactory=new Es({})),this.ho(o.initMessageHeaders,e,n),o.encodeInitMessageHeaders=!0;const a=s.join("");ks("Connection","Creating WebChannel: "+a,o);const u=r.createWebChannel(a,o);let c=!1,h=!1;const l=new Ph({Hr:t=>{h?ks("Connection","Not sending because WebChannel is closed:",t):(c||(ks("Connection","Opening WebChannel transport."),u.open(),c=!0),ks("Connection","WebChannel sending:",t),u.send(t))},Jr:()=>u.close()}),d=(t,e,n)=>{t.listen(e,(t=>{try{n(t)}catch(t){setTimeout((()=>{throw t}),0)}}))};return d(u,Ts.EventType.OPEN,(()=>{h||ks("Connection","WebChannel transport opened.")})),d(u,Ts.EventType.CLOSE,(()=>{h||(h=!0,ks("Connection","WebChannel transport closed"),l.io())})),d(u,Ts.EventType.ERROR,(t=>{h||(h=!0,Ls("Connection","WebChannel transport errored:",t),l.io(new Us(Bs.UNAVAILABLE,"The operation could not be completed")))})),d(u,Ts.EventType.MESSAGE,(t=>{var e;if(!h){const n=t.data[0];Vs(!!n);const s=n,r=s.error||(null===(e=s[0])||void 0===e?void 0:e.error);if(r){ks("Connection","WebChannel received error:",r);const t=r.status;let e=function(t){const e=Wo[t];if(void 0!==e)return Jo(e)}(t),n=r.message;void 0===e&&(e=Bs.INTERNAL,n="Unknown error status: "+t+" with message "+r.message),h=!0,l.io(new Us(e,n)),u.close()}else ks("Connection","WebChannel received:",n),l.ro(n)}})),d(i,vs.STAT_EVENT,(t=>{t.stat===Is?ks("Connection","Detected buffering proxy"):t.stat===bs&&ks("Connection","Detected no buffering proxy")})),setTimeout((()=>{l.so()}),0),l}}function Uh(){return"undefined"!=typeof window?window:null}function qh(){return"undefined"!=typeof document?document:null}function Gh(t){return new Sa(t,!0)}class Kh{constructor(t,e,n=1e3,s=1.5,r=6e4){this.Hs=t,this.timerId=e,this.wo=n,this.mo=s,this.yo=r,this.po=0,this.Io=null,this.To=Date.now(),this.reset()}reset(){this.po=0}Eo(){this.po=this.yo}Ao(t){this.cancel();const e=Math.floor(this.po+this.Ro()),n=Math.max(0,Date.now()-this.To),s=Math.max(0,e-n);s>0&&ks("ExponentialBackoff",`Backing off for ${s} ms (base delay: ${this.po} ms, delay with jitter: ${e} ms, last attempt: ${n} ms ago)`),this.Io=this.Hs.enqueueAfterDelay(this.timerId,s,(()=>(this.To=Date.now(),t()))),this.po*=this.mo,this.po<this.wo&&(this.po=this.wo),this.po>this.yo&&(this.po=this.yo)}bo(){null!==this.Io&&(this.Io.skipDelay(),this.Io=null)}cancel(){null!==this.Io&&(this.Io.cancel(),this.Io=null)}Ro(){return(Math.random()-.5)*this.po}}class jh{constructor(t,e,n,s,r,i,o,a){this.Hs=t,this.Po=n,this.vo=s,this.Vo=r,this.authCredentialsProvider=i,this.appCheckCredentialsProvider=o,this.listener=a,this.state=0,this.So=0,this.Do=null,this.Co=null,this.stream=null,this.xo=new Kh(t,e)}No(){return 1===this.state||5===this.state||this.ko()}ko(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.Mo()}async stop(){this.No()&&await this.close(0)}Oo(){this.state=0,this.xo.reset()}Fo(){this.ko()&&null===this.Do&&(this.Do=this.Hs.enqueueAfterDelay(this.Po,6e4,(()=>this.$o())))}Bo(t){this.Lo(),this.stream.send(t)}async $o(){if(this.ko())return this.close(0)}Lo(){this.Do&&(this.Do.cancel(),this.Do=null)}Uo(){this.Co&&(this.Co.cancel(),this.Co=null)}async close(t,e){this.Lo(),this.Uo(),this.xo.cancel(),this.So++,4!==t?this.xo.reset():e&&e.code===Bs.RESOURCE_EXHAUSTED?(Rs(e.toString()),Rs("Using maximum backoff delay to prevent overloading the backend."),this.xo.Eo()):e&&e.code===Bs.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.qo(),this.stream.close(),this.stream=null),this.state=t,await this.listener.Zr(e)}qo(){}auth(){this.state=1;const t=this.Ko(this.So),e=this.So;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then((([t,n])=>{this.So===e&&this.Go(t,n)}),(e=>{t((()=>{const t=new Us(Bs.UNKNOWN,"Fetching auth token failed: "+e.message);return this.Qo(t)}))}))}Go(t,e){const n=this.Ko(this.So);this.stream=this.jo(t,e),this.stream.Yr((()=>{n((()=>(this.state=2,this.Co=this.Hs.enqueueAfterDelay(this.vo,1e4,(()=>(this.ko()&&(this.state=3),Promise.resolve()))),this.listener.Yr())))})),this.stream.Zr((t=>{n((()=>this.Qo(t)))})),this.stream.onMessage((t=>{n((()=>this.onMessage(t)))}))}Mo(){this.state=5,this.xo.Ao((async()=>{this.state=0,this.start()}))}Qo(t){return ks("PersistentStream",`close with error: ${t}`),this.stream=null,this.close(4,t)}Ko(t){return e=>{this.Hs.enqueueAndForget((()=>this.So===t?e():(ks("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())))}}}class $h extends jh{constructor(t,e,n,s,r,i){super(t,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",e,n,s,i),this.It=r}jo(t,e){return this.Vo._o("Listen",t,e)}onMessage(t){this.xo.reset();const e=function(t,e){let n;if("targetChange"in e){e.targetChange;const s=function(t){return"NO_CHANGE"===t?0:"ADD"===t?1:"REMOVE"===t?2:"CURRENT"===t?3:"RESET"===t?4:Os()}(e.targetChange.targetChangeType||"NO_CHANGE"),r=e.targetChange.targetIds||[],i=function(t,e){return t.gt?(Vs(void 0===e||"string"==typeof e),Qr.fromBase64String(e||"")):(Vs(void 0===e||e instanceof Uint8Array),Qr.fromUint8Array(e||new Uint8Array))}(t,e.targetChange.resumeToken),o=e.targetChange.cause,a=o&&function(t){const e=void 0===t.code?Bs.UNKNOWN:Jo(t.code);return new Us(e,t.message||"")}(o);n=new ya(s,r,i,a||null)}else if("documentChange"in e){e.documentChange;const s=e.documentChange;s.document,s.document.name,s.document.updateTime;const r=Ra(t,s.document.name),i=Aa(s.document.updateTime),o=new _i({mapValue:{fields:s.document.fields}}),a=Ci.newFoundDocument(r,i,o),u=s.targetIds||[],c=s.removedTargetIds||[];n=new ga(u,c,a.key,a)}else if("documentDelete"in e){e.documentDelete;const s=e.documentDelete;s.document;const r=Ra(t,s.document),i=s.readTime?Aa(s.readTime):sr.min(),o=Ci.newNoDocument(r,i),a=s.removedTargetIds||[];n=new ga([],a,o.key,o)}else if("documentRemove"in e){e.documentRemove;const s=e.documentRemove;s.document;const r=Ra(t,s.document),i=s.removedTargetIds||[];n=new ga([],i,r,null)}else{if(!("filter"in e))return Os();{e.filter;const t=e.filter;t.targetId;const s=t.count||0,r=new Ho(s),i=t.targetId;n=new pa(i,r)}}return n}(this.It,t),n=function(t){if(!("targetChange"in t))return sr.min();const e=t.targetChange;return e.targetIds&&e.targetIds.length?sr.min():e.readTime?Aa(e.readTime):sr.min()}(t);return this.listener.Wo(e,n)}zo(t){const e={};e.database=Oa(this.It),e.addTarget=function(t,e){let n;const s=e.target;return n=Mi(s)?{documents:qa(t,s)}:{query:Ga(t,s)},n.targetId=e.targetId,e.resumeToken.approximateByteSize()>0?n.resumeToken=Da(t,e.resumeToken):e.snapshotVersion.compareTo(sr.min())>0&&(n.readTime=xa(t,e.snapshotVersion.toTimestamp())),n}(this.It,t);const n=function(t,e){const n=function(t,e){switch(e){case 0:return null;case 1:return"existence-filter-mismatch";case 2:return"limbo-document";default:return Os()}}(0,e.purpose);return null==n?null:{"goog-listen-tags":n}}(this.It,t);n&&(e.labels=n),this.Bo(e)}Ho(t){const e={};e.database=Oa(this.It),e.removeTarget=t,this.Bo(e)}}class zh extends jh{constructor(t,e,n,s,r,i){super(t,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",e,n,s,i),this.It=r,this.Jo=!1}get Yo(){return this.Jo}start(){this.Jo=!1,this.lastStreamToken=void 0,super.start()}qo(){this.Jo&&this.Xo([])}jo(t,e){return this.Vo._o("Write",t,e)}onMessage(t){if(Vs(!!t.streamToken),this.lastStreamToken=t.streamToken,this.Jo){this.xo.reset();const e=function(t,e){return t&&t.length>0?(Vs(void 0!==e),t.map((t=>function(t,e){let n=t.updateTime?Aa(t.updateTime):Aa(e);return n.isEqual(sr.min())&&(n=Aa(e)),new Ro(n,t.transformResults||[])}(t,e)))):[]}(t.writeResults,t.commitTime),n=Aa(t.commitTime);return this.listener.Zo(n,e)}return Vs(!t.writeResults||0===t.writeResults.length),this.Jo=!0,this.listener.tu()}eu(){const t={};t.database=Oa(this.It),this.Bo(t)}Xo(t){const e={streamToken:this.lastStreamToken,writes:t.map((t=>Ba(this.It,t)))};this.Bo(e)}}class Qh extends class{}{constructor(t,e,n,s){super(),this.authCredentials=t,this.appCheckCredentials=e,this.Vo=n,this.It=s,this.nu=!1}su(){if(this.nu)throw new Us(Bs.FAILED_PRECONDITION,"The client has already been terminated.")}co(t,e,n){return this.su(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([s,r])=>this.Vo.co(t,e,n,s,r))).catch((t=>{throw"FirebaseError"===t.name?(t.code===Bs.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),t):new Us(Bs.UNKNOWN,t.toString())}))}fo(t,e,n,s){return this.su(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([r,i])=>this.Vo.fo(t,e,n,r,i,s))).catch((t=>{throw"FirebaseError"===t.name?(t.code===Bs.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),t):new Us(Bs.UNKNOWN,t.toString())}))}terminate(){this.nu=!0}}class Hh{constructor(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state="Unknown",this.iu=0,this.ru=null,this.ou=!0}uu(){0===this.iu&&(this.cu("Unknown"),this.ru=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(()=>(this.ru=null,this.au("Backend didn't respond within 10 seconds."),this.cu("Offline"),Promise.resolve()))))}hu(t){"Online"===this.state?this.cu("Unknown"):(this.iu++,this.iu>=1&&(this.lu(),this.au(`Connection failed 1 times. Most recent error: ${t.toString()}`),this.cu("Offline")))}set(t){this.lu(),this.iu=0,"Online"===t&&(this.ou=!1),this.cu(t)}cu(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))}au(t){const e=`Could not reach Cloud Firestore backend. ${t}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.ou?(Rs(e),this.ou=!1):ks("OnlineStateTracker",e)}lu(){null!==this.ru&&(this.ru.cancel(),this.ru=null)}}class Wh{constructor(t,e,n,s,r){this.localStore=t,this.datastore=e,this.asyncQueue=n,this.remoteSyncer={},this.fu=[],this.du=new Map,this._u=new Set,this.wu=[],this.mu=r,this.mu.qr((t=>{n.enqueueAndForget((async()=>{rl(this)&&(ks("RemoteStore","Restarting streams for network reachability change."),await async function(t){const e=Ps(t);e._u.add(4),await Xh(e),e.gu.set("Unknown"),e._u.delete(4),await Yh(e)}(this))}))})),this.gu=new Hh(n,s)}}async function Yh(t){if(rl(t))for(const e of t.wu)await e(!0)}async function Xh(t){for(const e of t.wu)await e(!1)}function Jh(t,e){const n=Ps(t);n.du.has(e.targetId)||(n.du.set(e.targetId,e),sl(n)?nl(n):El(n).ko()&&tl(n,e))}function Zh(t,e){const n=Ps(t),s=El(n);n.du.delete(e),s.ko()&&el(n,e),0===n.du.size&&(s.ko()?s.Fo():rl(n)&&n.gu.set("Unknown"))}function tl(t,e){t.yu.Ot(e.targetId),El(t).zo(e)}function el(t,e){t.yu.Ot(e),El(t).Ho(e)}function nl(t){t.yu=new va({getRemoteKeysForTarget:e=>t.remoteSyncer.getRemoteKeysForTarget(e),se:e=>t.du.get(e)||null}),El(t).start(),t.gu.uu()}function sl(t){return rl(t)&&!El(t).No()&&t.du.size>0}function rl(t){return 0===Ps(t)._u.size}function il(t){t.yu=void 0}async function ol(t){t.du.forEach(((e,n)=>{tl(t,e)}))}async function al(t,e){il(t),sl(t)?(t.gu.hu(e),nl(t)):t.gu.set("Unknown")}async function ul(t,e,n){if(t.gu.set("Online"),e instanceof ya&&2===e.state&&e.cause)try{await async function(t,e){const n=e.cause;for(const s of e.targetIds)t.du.has(s)&&(await t.remoteSyncer.rejectListen(s,n),t.du.delete(s),t.yu.removeTarget(s))}(t,e)}catch(n){ks("RemoteStore","Failed to remove targets %s: %s ",e.targetIds.join(","),n),await cl(t,n)}else if(e instanceof ga?t.yu.Gt(e):e instanceof pa?t.yu.Yt(e):t.yu.Wt(e),!n.isEqual(sr.min()))try{const e=await gh(t.localStore);n.compareTo(e)>=0&&await function(t,e){const n=t.yu.te(e);return n.targetChanges.forEach(((n,s)=>{if(n.resumeToken.approximateByteSize()>0){const r=t.du.get(s);r&&t.du.set(s,r.withResumeToken(n.resumeToken,e))}})),n.targetMismatches.forEach((e=>{const n=t.du.get(e);if(!n)return;t.du.set(e,n.withResumeToken(Qr.EMPTY_BYTE_STRING,n.snapshotVersion)),el(t,e);const s=new ku(n.target,e,1,n.sequenceNumber);tl(t,s)})),t.remoteSyncer.applyRemoteEvent(n)}(t,n)}catch(e){ks("RemoteStore","Failed to raise snapshot:",e),await cl(t,e)}}async function cl(t,e,n){if(!Ar(e))throw e;t._u.add(1),await Xh(t),t.gu.set("Offline"),n||(n=()=>gh(t.localStore)),t.asyncQueue.enqueueRetryable((async()=>{ks("RemoteStore","Retrying IndexedDB access"),await n(),t._u.delete(1),await Yh(t)}))}function hl(t,e){return e().catch((n=>cl(t,n,e)))}async function ll(t){const e=Ps(t),n=Tl(e);let s=e.fu.length>0?e.fu[e.fu.length-1].batchId:-1;for(;dl(e);)try{const t=await yh(e.localStore,s);if(null===t){0===e.fu.length&&n.Fo();break}s=t.batchId,fl(e,t)}catch(t){await cl(e,t)}ml(e)&&gl(e)}function dl(t){return rl(t)&&t.fu.length<10}function fl(t,e){t.fu.push(e);const n=Tl(t);n.ko()&&n.Yo&&n.Xo(e.mutations)}function ml(t){return rl(t)&&!Tl(t).No()&&t.fu.length>0}function gl(t){Tl(t).start()}async function pl(t){Tl(t).eu()}async function yl(t){const e=Tl(t);for(const n of t.fu)e.Xo(n.mutations)}async function wl(t,e,n){const s=t.fu.shift(),r=Cu.from(s,e,n);await hl(t,(()=>t.remoteSyncer.applySuccessfulWrite(r))),await ll(t)}async function vl(t,e){e&&Tl(t).Yo&&await async function(t,e){if(Xo(n=e.code)&&n!==Bs.ABORTED){const n=t.fu.shift();Tl(t).Oo(),await hl(t,(()=>t.remoteSyncer.rejectFailedWrite(n.batchId,e))),await ll(t)}var n}(t,e),ml(t)&&gl(t)}async function Il(t,e){const n=Ps(t);n.asyncQueue.verifyOperationInProgress(),ks("RemoteStore","RemoteStore received new credentials");const s=rl(n);n._u.add(3),await Xh(n),s&&n.gu.set("Unknown"),await n.remoteSyncer.handleCredentialChange(e),n._u.delete(3),await Yh(n)}async function bl(t,e){const n=Ps(t);e?(n._u.delete(2),await Yh(n)):e||(n._u.add(2),await Xh(n),n.gu.set("Unknown"))}function El(t){return t.pu||(t.pu=function(t,e,n){const s=Ps(t);return s.su(),new $h(e,s.Vo,s.authCredentials,s.appCheckCredentials,s.It,n)}(t.datastore,t.asyncQueue,{Yr:ol.bind(null,t),Zr:al.bind(null,t),Wo:ul.bind(null,t)}),t.wu.push((async e=>{e?(t.pu.Oo(),sl(t)?nl(t):t.gu.set("Unknown")):(await t.pu.stop(),il(t))}))),t.pu}function Tl(t){return t.Iu||(t.Iu=function(t,e,n){const s=Ps(t);return s.su(),new zh(e,s.Vo,s.authCredentials,s.appCheckCredentials,s.It,n)}(t.datastore,t.asyncQueue,{Yr:pl.bind(null,t),Zr:vl.bind(null,t),tu:yl.bind(null,t),Zo:wl.bind(null,t)}),t.wu.push((async e=>{e?(t.Iu.Oo(),await ll(t)):(await t.Iu.stop(),t.fu.length>0&&(ks("RemoteStore",`Stopping write stream with ${t.fu.length} pending writes`),t.fu=[]))}))),t.Iu}class Sl{constructor(t,e,n,s,r){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=n,this.op=s,this.removalCallback=r,this.deferred=new qs,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((t=>{}))}static createAndSchedule(t,e,n,s,r){const i=Date.now()+n,o=new Sl(t,e,i,s,r);return o.start(n),o}start(t){this.timerHandle=setTimeout((()=>this.handleDelayElapsed()),t)}skipDelay(){return this.handleDelayElapsed()}cancel(t){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new Us(Bs.CANCELLED,"Operation cancelled"+(t?": "+t:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget((()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then((t=>this.deferred.resolve(t)))):Promise.resolve()))}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function xl(t,e){if(Rs("AsyncQueue",`${e}: ${t}`),Ar(t))return new Us(Bs.UNAVAILABLE,`${e}: ${t}`);throw t}class Dl{constructor(t){this.comparator=t?(e,n)=>t(e,n)||ur.comparator(e.key,n.key):(t,e)=>ur.comparator(t.key,e.key),this.keyedMap=sa(),this.sortedSet=new Br(this.comparator)}static emptySet(t){return new Dl(t.comparator)}has(t){return null!=this.keyedMap.get(t)}get(t){return this.keyedMap.get(t)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(t){const e=this.keyedMap.get(t);return e?this.sortedSet.indexOf(e):-1}get size(){return this.sortedSet.size}forEach(t){this.sortedSet.inorderTraversal(((e,n)=>(t(e),!1)))}add(t){const e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))}delete(t){const e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this}isEqual(t){if(!(t instanceof Dl))return!1;if(this.size!==t.size)return!1;const e=this.sortedSet.getIterator(),n=t.sortedSet.getIterator();for(;e.hasNext();){const t=e.getNext().key,s=n.getNext().key;if(!t.isEqual(s))return!1}return!0}toString(){const t=[];return this.forEach((e=>{t.push(e.toString())})),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"}copy(t,e){const n=new Dl;return n.comparator=this.comparator,n.keyedMap=t,n.sortedSet=e,n}}class _l{constructor(){this.Tu=new Br(ur.comparator)}track(t){const e=t.doc.key,n=this.Tu.get(e);n?0!==t.type&&3===n.type?this.Tu=this.Tu.insert(e,t):3===t.type&&1!==n.type?this.Tu=this.Tu.insert(e,{type:n.type,doc:t.doc}):2===t.type&&2===n.type?this.Tu=this.Tu.insert(e,{type:2,doc:t.doc}):2===t.type&&0===n.type?this.Tu=this.Tu.insert(e,{type:0,doc:t.doc}):1===t.type&&0===n.type?this.Tu=this.Tu.remove(e):1===t.type&&2===n.type?this.Tu=this.Tu.insert(e,{type:1,doc:n.doc}):0===t.type&&1===n.type?this.Tu=this.Tu.insert(e,{type:2,doc:t.doc}):Os():this.Tu=this.Tu.insert(e,t)}Eu(){const t=[];return this.Tu.inorderTraversal(((e,n)=>{t.push(n)})),t}}class Al{constructor(t,e,n,s,r,i,o,a){this.query=t,this.docs=e,this.oldDocs=n,this.docChanges=s,this.mutatedKeys=r,this.fromCache=i,this.syncStateChanged=o,this.excludesMetadataChanges=a}static fromInitialDocuments(t,e,n,s){const r=[];return e.forEach((t=>{r.push({type:0,doc:t})})),new Al(t,e,Dl.emptySet(e),r,n,s,!0,!1)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(t){if(!(this.fromCache===t.fromCache&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&uo(this.query,t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;const e=this.docChanges,n=t.docChanges;if(e.length!==n.length)return!1;for(let t=0;t<e.length;t++)if(e[t].type!==n[t].type||!e[t].doc.isEqual(n[t].doc))return!1;return!0}}class Cl{constructor(){this.Au=void 0,this.listeners=[]}}class Nl{constructor(){this.queries=new Zo((t=>co(t)),uo),this.onlineState="Unknown",this.Ru=new Set}}async function kl(t,e){const n=Ps(t),s=e.query;let r=!1,i=n.queries.get(s);if(i||(r=!0,i=new Cl),r)try{i.Au=await n.onListen(s)}catch(t){const n=xl(t,`Initialization of query '${ho(e.query)}' failed`);return void e.onError(n)}n.queries.set(s,i),i.listeners.push(e),e.bu(n.onlineState),i.Au&&e.Pu(i.Au)&&Ol(n)}async function Rl(t,e){const n=Ps(t),s=e.query;let r=!1;const i=n.queries.get(s);if(i){const t=i.listeners.indexOf(e);t>=0&&(i.listeners.splice(t,1),r=0===i.listeners.length)}if(r)return n.queries.delete(s),n.onUnlisten(s)}function Ll(t,e){const n=Ps(t);let s=!1;for(const t of e){const e=t.query,r=n.queries.get(e);if(r){for(const e of r.listeners)e.Pu(t)&&(s=!0);r.Au=t}}s&&Ol(n)}function Ml(t,e,n){const s=Ps(t),r=s.queries.get(e);if(r)for(const t of r.listeners)t.onError(n);s.queries.delete(e)}function Ol(t){t.Ru.forEach((t=>{t.next()}))}class Vl{constructor(t,e,n){this.query=t,this.vu=e,this.Vu=!1,this.Su=null,this.onlineState="Unknown",this.options=n||{}}Pu(t){if(!this.options.includeMetadataChanges){const e=[];for(const n of t.docChanges)3!==n.type&&e.push(n);t=new Al(t.query,t.docs,t.oldDocs,e,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0)}let e=!1;return this.Vu?this.Du(t)&&(this.vu.next(t),e=!0):this.Cu(t,this.onlineState)&&(this.xu(t),e=!0),this.Su=t,e}onError(t){this.vu.error(t)}bu(t){this.onlineState=t;let e=!1;return this.Su&&!this.Vu&&this.Cu(this.Su,t)&&(this.xu(this.Su),e=!0),e}Cu(t,e){if(!t.fromCache)return!0;const n="Offline"!==e;return!(this.options.Nu&&n||t.docs.isEmpty()&&"Offline"!==e)}Du(t){if(t.docChanges.length>0)return!0;const e=this.Su&&this.Su.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&!0===this.options.includeMetadataChanges}xu(t){t=Al.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache),this.Vu=!0,this.vu.next(t)}}class Fl{constructor(t,e){this.payload=t,this.byteLength=e}ku(){return"metadata"in this.payload}}class Pl{constructor(t){this.It=t}Ji(t){return Ra(this.It,t)}Yi(t){return t.metadata.exists?Pa(this.It,t.document,!1):Ci.newNoDocument(this.Ji(t.metadata.name),this.Xi(t.metadata.readTime))}Xi(t){return Aa(t)}}class Bl{constructor(t,e,n){this.Mu=t,this.localStore=e,this.It=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=Ul(t)}Ou(t){this.progress.bytesLoaded+=t.byteLength;let e=this.progress.documentsLoaded;if(t.payload.namedQuery)this.queries.push(t.payload.namedQuery);else if(t.payload.documentMetadata){this.documents.push({metadata:t.payload.documentMetadata}),t.payload.documentMetadata.exists||++e;const n=ir.fromString(t.payload.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else t.payload.document&&(this.documents[this.documents.length-1].document=t.payload.document,++e);return e!==this.progress.documentsLoaded?(this.progress.documentsLoaded=e,Object.assign({},this.progress)):null}Fu(t){const e=new Map,n=new Pl(this.It);for(const s of t)if(s.metadata.queries){const t=n.Ji(s.metadata.name);for(const n of s.metadata.queries){const s=(e.get(n)||ha()).add(t);e.set(n,s)}}return e}async complete(){const t=await async function(t,e,n,s){const r=Ps(t);let i=ha(),o=ea();for(const t of n){const n=e.Ji(t.metadata.name);t.document&&(i=i.add(n));const s=e.Yi(t);s.setReadTime(e.Xi(t.metadata.readTime)),o=o.insert(n,s)}const a=r.Gi.newChangeBuffer({trackRemovals:!0}),u=await wh(r,function(t){return oo(to(ir.fromString(`__bundle__/docs/${t}`)))}(s));return r.persistence.runTransaction("Apply bundle documents","readwrite",(t=>ph(t,a,o).next((e=>(a.apply(t),e))).next((e=>r.Cs.removeMatchingKeysForTargetId(t,u.targetId).next((()=>r.Cs.addMatchingKeys(t,i,u.targetId))).next((()=>r.localDocuments.getLocalViewOfDocuments(t,e.Wi,e.zi))).next((()=>e.Wi))))))}(this.localStore,new Pl(this.It),this.documents,this.Mu.id),e=this.Fu(this.documents);for(const t of this.queries)await Sh(this.localStore,t,e.get(t.name));return this.progress.taskState="Success",{progress:this.progress,$u:this.collectionGroups,Bu:t}}}function Ul(t){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:t.totalDocuments,totalBytes:t.totalBytes}}class ql{constructor(t){this.key=t}}class Gl{constructor(t){this.key=t}}class Kl{constructor(t,e){this.query=t,this.Lu=e,this.Uu=null,this.current=!1,this.qu=ha(),this.mutatedKeys=ha(),this.Ku=mo(t),this.Gu=new Dl(this.Ku)}get Qu(){return this.Lu}ju(t,e){const n=e?e.Wu:new _l,s=e?e.Gu:this.Gu;let r=e?e.mutatedKeys:this.mutatedKeys,i=s,o=!1;const a="F"===this.query.limitType&&s.size===this.query.limit?s.last():null,u="L"===this.query.limitType&&s.size===this.query.limit?s.first():null;if(t.inorderTraversal(((t,e)=>{const c=s.get(t),h=lo(this.query,e)?e:null,l=!!c&&this.mutatedKeys.has(c.key),d=!!h&&(h.hasLocalMutations||this.mutatedKeys.has(h.key)&&h.hasCommittedMutations);let f=!1;c&&h?c.data.isEqual(h.data)?l!==d&&(n.track({type:3,doc:h}),f=!0):this.zu(c,h)||(n.track({type:2,doc:h}),f=!0,(a&&this.Ku(h,a)>0||u&&this.Ku(h,u)<0)&&(o=!0)):!c&&h?(n.track({type:0,doc:h}),f=!0):c&&!h&&(n.track({type:1,doc:c}),f=!0,(a||u)&&(o=!0)),f&&(h?(i=i.add(h),r=d?r.add(t):r.delete(t)):(i=i.delete(t),r=r.delete(t)))})),null!==this.query.limit)for(;i.size>this.query.limit;){const t="F"===this.query.limitType?i.last():i.first();i=i.delete(t.key),r=r.delete(t.key),n.track({type:1,doc:t})}return{Gu:i,Wu:n,$i:o,mutatedKeys:r}}zu(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations}applyChanges(t,e,n){const s=this.Gu;this.Gu=t.Gu,this.mutatedKeys=t.mutatedKeys;const r=t.Wu.Eu();r.sort(((t,e)=>function(t,e){const n=t=>{switch(t){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return Os()}};return n(t)-n(e)}(t.type,e.type)||this.Ku(t.doc,e.doc))),this.Hu(n);const i=e?this.Ju():[],o=0===this.qu.size&&this.current?1:0,a=o!==this.Uu;return this.Uu=o,0!==r.length||a?{snapshot:new Al(this.query,t.Gu,s,r,t.mutatedKeys,0===o,a,!1),Yu:i}:{Yu:i}}bu(t){return this.current&&"Offline"===t?(this.current=!1,this.applyChanges({Gu:this.Gu,Wu:new _l,mutatedKeys:this.mutatedKeys,$i:!1},!1)):{Yu:[]}}Xu(t){return!this.Lu.has(t)&&!!this.Gu.has(t)&&!this.Gu.get(t).hasLocalMutations}Hu(t){t&&(t.addedDocuments.forEach((t=>this.Lu=this.Lu.add(t))),t.modifiedDocuments.forEach((t=>{})),t.removedDocuments.forEach((t=>this.Lu=this.Lu.delete(t))),this.current=t.current)}Ju(){if(!this.current)return[];const t=this.qu;this.qu=ha(),this.Gu.forEach((t=>{this.Xu(t.key)&&(this.qu=this.qu.add(t.key))}));const e=[];return t.forEach((t=>{this.qu.has(t)||e.push(new Gl(t))})),this.qu.forEach((n=>{t.has(n)||e.push(new ql(n))})),e}Zu(t){this.Lu=t.Hi,this.qu=ha();const e=this.ju(t.documents);return this.applyChanges(e,!0)}tc(){return Al.fromInitialDocuments(this.query,this.Gu,this.mutatedKeys,0===this.Uu)}}class jl{constructor(t,e,n){this.query=t,this.targetId=e,this.view=n}}class $l{constructor(t){this.key=t,this.ec=!1}}class zl{constructor(t,e,n,s,r,i){this.localStore=t,this.remoteStore=e,this.eventManager=n,this.sharedClientState=s,this.currentUser=r,this.maxConcurrentLimboResolutions=i,this.nc={},this.sc=new Zo((t=>co(t)),uo),this.ic=new Map,this.rc=new Set,this.oc=new Br(ur.comparator),this.uc=new Map,this.cc=new Hc,this.ac={},this.hc=new Map,this.lc=Sc.vn(),this.onlineState="Unknown",this.fc=void 0}get isPrimaryClient(){return!0===this.fc}}async function Ql(t,e){const n=vd(t);let s,r;const i=n.sc.get(e);if(i)s=i.targetId,n.sharedClientState.addLocalQueryTarget(s),r=i.view.tc();else{const t=await wh(n.localStore,oo(e));n.isPrimaryClient&&Jh(n.remoteStore,t);const i=n.sharedClientState.addLocalQueryTarget(t.targetId);s=t.targetId,r=await Hl(n,e,s,"current"===i)}return r}async function Hl(t,e,n,s){t.dc=(e,n,s)=>async function(t,e,n,s){let r=e.view.ju(n);r.$i&&(r=await Ih(t.localStore,e.query,!1).then((({documents:t})=>e.view.ju(t,r))));const i=s&&s.targetChanges.get(e.targetId),o=e.view.applyChanges(r,t.isPrimaryClient,i);return id(t,e.targetId,o.Yu),o.snapshot}(t,e,n,s);const r=await Ih(t.localStore,e,!0),i=new Kl(e,r.Hi),o=i.ju(r.documents),a=ma.createSynthesizedTargetChangeForCurrentChange(n,s&&"Offline"!==t.onlineState),u=i.applyChanges(o,t.isPrimaryClient,a);id(t,n,u.Yu);const c=new jl(e,n,i);return t.sc.set(e,c),t.ic.has(n)?t.ic.get(n).push(e):t.ic.set(n,[e]),u.snapshot}async function Wl(t,e){const n=Ps(t),s=n.sc.get(e),r=n.ic.get(s.targetId);if(r.length>1)return n.ic.set(s.targetId,r.filter((t=>!uo(t,e)))),void n.sc.delete(e);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(s.targetId),n.sharedClientState.isActiveQueryTarget(s.targetId)||await vh(n.localStore,s.targetId,!1).then((()=>{n.sharedClientState.clearQueryState(s.targetId),Zh(n.remoteStore,s.targetId),sd(n,s.targetId)})).catch(Er)):(sd(n,s.targetId),await vh(n.localStore,s.targetId,!0))}async function Yl(t,e){const n=Ps(t);try{const t=await function(t,e){const n=Ps(t),s=e.snapshotVersion;let r=n.Ui;return n.persistence.runTransaction("Apply remote event","readwrite-primary",(t=>{const i=n.Gi.newChangeBuffer({trackRemovals:!0});r=n.Ui;const o=[];e.targetChanges.forEach(((i,a)=>{const u=r.get(a);if(!u)return;o.push(n.Cs.removeMatchingKeys(t,i.removedDocuments,a).next((()=>n.Cs.addMatchingKeys(t,i.addedDocuments,a))));let c=u.withSequenceNumber(t.currentSequenceNumber);e.targetMismatches.has(a)?c=c.withResumeToken(Qr.EMPTY_BYTE_STRING,sr.min()).withLastLimboFreeSnapshotVersion(sr.min()):i.resumeToken.approximateByteSize()>0&&(c=c.withResumeToken(i.resumeToken,s)),r=r.insert(a,c),function(t,e,n){return 0===t.resumeToken.approximateByteSize()||e.snapshotVersion.toMicroseconds()-t.snapshotVersion.toMicroseconds()>=3e8||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0}(u,c,i)&&o.push(n.Cs.updateTargetData(t,c))}));let a=ea(),u=ha();if(e.documentUpdates.forEach((s=>{e.resolvedLimboDocuments.has(s)&&o.push(n.persistence.referenceDelegate.updateLimboDocument(t,s))})),o.push(ph(t,i,e.documentUpdates).next((t=>{a=t.Wi,u=t.zi}))),!s.isEqual(sr.min())){const e=n.Cs.getLastRemoteSnapshotVersion(t).next((e=>n.Cs.setTargetsMetadata(t,t.currentSequenceNumber,s)));o.push(e)}return Tr.waitFor(o).next((()=>i.apply(t))).next((()=>n.localDocuments.getLocalViewOfDocuments(t,a,u))).next((()=>a))})).then((t=>(n.Ui=r,t)))}(n.localStore,e);e.targetChanges.forEach(((t,e)=>{const s=n.uc.get(e);s&&(Vs(t.addedDocuments.size+t.modifiedDocuments.size+t.removedDocuments.size<=1),t.addedDocuments.size>0?s.ec=!0:t.modifiedDocuments.size>0?Vs(s.ec):t.removedDocuments.size>0&&(Vs(s.ec),s.ec=!1))})),await ud(n,t,e)}catch(t){await Er(t)}}function Xl(t,e,n){const s=Ps(t);if(s.isPrimaryClient&&0===n||!s.isPrimaryClient&&1===n){const t=[];s.sc.forEach(((n,s)=>{const r=s.view.bu(e);r.snapshot&&t.push(r.snapshot)})),function(t,e){const n=Ps(t);n.onlineState=e;let s=!1;n.queries.forEach(((t,n)=>{for(const t of n.listeners)t.bu(e)&&(s=!0)})),s&&Ol(n)}(s.eventManager,e),t.length&&s.nc.Wo(t),s.onlineState=e,s.isPrimaryClient&&s.sharedClientState.setOnlineState(e)}}async function Jl(t,e,n){const s=Ps(t);s.sharedClientState.updateQueryState(e,"rejected",n);const r=s.uc.get(e),i=r&&r.key;if(i){let t=new Br(ur.comparator);t=t.insert(i,Ci.newNoDocument(i,sr.min()));const n=ha().add(i),r=new fa(sr.min(),new Map,new Gr(Zs),t,n);await Yl(s,r),s.oc=s.oc.remove(i),s.uc.delete(e),ad(s)}else await vh(s.localStore,e,!1).then((()=>sd(s,e,n))).catch(Er)}async function Zl(t,e){const n=Ps(t),s=e.batch.batchId;try{const t=await function(t,e){const n=Ps(t);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",(t=>{const s=e.batch.keys(),r=n.Gi.newChangeBuffer({trackRemovals:!0});return function(t,e,n,s){const r=n.batch,i=r.keys();let o=Tr.resolve();return i.forEach((t=>{o=o.next((()=>s.getEntry(e,t))).next((e=>{const i=n.docVersions.get(t);Vs(null!==i),e.version.compareTo(i)<0&&(r.applyToRemoteDocument(e,n),e.isValidDocument()&&(e.setReadTime(n.commitVersion),s.addEntry(e)))}))})),o.next((()=>t.mutationQueue.removeMutationBatch(e,r)))}(n,t,e,r).next((()=>r.apply(t))).next((()=>n.mutationQueue.performConsistencyCheck(t))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(t,s,e.batch.batchId))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(t,function(t){let e=ha();for(let n=0;n<t.mutationResults.length;++n)t.mutationResults[n].transformResults.length>0&&(e=e.add(t.batch.mutations[n].key));return e}(e)))).next((()=>n.localDocuments.getDocuments(t,s)))}))}(n.localStore,e);nd(n,s,null),ed(n,s),n.sharedClientState.updateMutationState(s,"acknowledged"),await ud(n,t)}catch(t){await Er(t)}}async function td(t,e,n){const s=Ps(t);try{const t=await function(t,e){const n=Ps(t);return n.persistence.runTransaction("Reject batch","readwrite-primary",(t=>{let s;return n.mutationQueue.lookupMutationBatch(t,e).next((e=>(Vs(null!==e),s=e.keys(),n.mutationQueue.removeMutationBatch(t,e)))).next((()=>n.mutationQueue.performConsistencyCheck(t))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(t,s,e))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(t,s))).next((()=>n.localDocuments.getDocuments(t,s)))}))}(s.localStore,e);nd(s,e,n),ed(s,e),s.sharedClientState.updateMutationState(e,"rejected",n),await ud(s,t)}catch(n){await Er(n)}}function ed(t,e){(t.hc.get(e)||[]).forEach((t=>{t.resolve()})),t.hc.delete(e)}function nd(t,e,n){const s=Ps(t);let r=s.ac[s.currentUser.toKey()];if(r){const t=r.get(e);t&&(n?t.reject(n):t.resolve(),r=r.remove(e)),s.ac[s.currentUser.toKey()]=r}}function sd(t,e,n=null){t.sharedClientState.removeLocalQueryTarget(e);for(const s of t.ic.get(e))t.sc.delete(s),n&&t.nc._c(s,n);t.ic.delete(e),t.isPrimaryClient&&t.cc.ls(e).forEach((e=>{t.cc.containsKey(e)||rd(t,e)}))}function rd(t,e){t.rc.delete(e.path.canonicalString());const n=t.oc.get(e);null!==n&&(Zh(t.remoteStore,n),t.oc=t.oc.remove(e),t.uc.delete(n),ad(t))}function id(t,e,n){for(const s of n)s instanceof ql?(t.cc.addReference(s.key,e),od(t,s)):s instanceof Gl?(ks("SyncEngine","Document no longer in limbo: "+s.key),t.cc.removeReference(s.key,e),t.cc.containsKey(s.key)||rd(t,s.key)):Os()}function od(t,e){const n=e.key,s=n.path.canonicalString();t.oc.get(n)||t.rc.has(s)||(ks("SyncEngine","New document in limbo: "+n),t.rc.add(s),ad(t))}function ad(t){for(;t.rc.size>0&&t.oc.size<t.maxConcurrentLimboResolutions;){const e=t.rc.values().next().value;t.rc.delete(e);const n=new ur(ir.fromString(e)),s=t.lc.next();t.uc.set(s,new $l(n)),t.oc=t.oc.insert(n,s),Jh(t.remoteStore,new ku(oo(to(n.path)),s,2,Or.at))}}async function ud(t,e,n){const s=Ps(t),r=[],i=[],o=[];s.sc.isEmpty()||(s.sc.forEach(((t,a)=>{o.push(s.dc(a,e,n).then((t=>{if(t){s.isPrimaryClient&&s.sharedClientState.updateQueryState(a.targetId,t.fromCache?"not-current":"current"),r.push(t);const e=hh.Ci(a.targetId,t);i.push(e)}})))})),await Promise.all(o),s.nc.Wo(r),await async function(t,e){const n=Ps(t);try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",(t=>Tr.forEach(e,(e=>Tr.forEach(e.Si,(s=>n.persistence.referenceDelegate.addReference(t,e.targetId,s))).next((()=>Tr.forEach(e.Di,(s=>n.persistence.referenceDelegate.removeReference(t,e.targetId,s)))))))))}catch(t){if(!Ar(t))throw t;ks("LocalStore","Failed to update sequence numbers: "+t)}for(const t of e){const e=t.targetId;if(!t.fromCache){const t=n.Ui.get(e),s=t.snapshotVersion,r=t.withLastLimboFreeSnapshotVersion(s);n.Ui=n.Ui.insert(e,r)}}}(s.localStore,i))}async function cd(t,e){const n=Ps(t);if(!n.currentUser.isEqual(e)){ks("SyncEngine","User change. New user:",e.toKey());const t=await mh(n.localStore,e);n.currentUser=e,function(t,e){t.hc.forEach((t=>{t.forEach((t=>{t.reject(new Us(Bs.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))}))})),t.hc.clear()}(n),n.sharedClientState.handleUserChange(e,t.removedBatchIds,t.addedBatchIds),await ud(n,t.ji)}}function hd(t,e){const n=Ps(t),s=n.uc.get(e);if(s&&s.ec)return ha().add(s.key);{let t=ha();const s=n.ic.get(e);if(!s)return t;for(const e of s){const s=n.sc.get(e);t=t.unionWith(s.view.Qu)}return t}}async function ld(t,e){const n=Ps(t),s=await Ih(n.localStore,e.query,!0),r=e.view.Zu(s);return n.isPrimaryClient&&id(n,e.targetId,r.Yu),r}async function dd(t,e){const n=Ps(t);return Eh(n.localStore,e).then((t=>ud(n,t)))}async function fd(t,e,n,s){const r=Ps(t),i=await function(t,e){const n=Ps(t),s=Ps(n.mutationQueue);return n.persistence.runTransaction("Lookup mutation documents","readonly",(t=>s.Tn(t,e).next((e=>e?n.localDocuments.getDocuments(t,e):Tr.resolve(null)))))}(r.localStore,e);null!==i?("pending"===n?await ll(r.remoteStore):"acknowledged"===n||"rejected"===n?(nd(r,e,s||null),ed(r,e),function(t,e){Ps(Ps(t).mutationQueue).An(e)}(r.localStore,e)):Os(),await ud(r,i)):ks("SyncEngine","Cannot apply mutation batch with id: "+e)}async function md(t,e,n){const s=Ps(t),r=[],i=[];for(const t of e){let e;const n=s.ic.get(t);if(n&&0!==n.length){e=await wh(s.localStore,oo(n[0]));for(const t of n){const e=s.sc.get(t),n=await ld(s,e);n.snapshot&&i.push(n.snapshot)}}else{const n=await bh(s.localStore,t);e=await wh(s.localStore,n),await Hl(s,gd(n),t,!1)}r.push(e)}return s.nc.Wo(i),r}function gd(t){return Zi(t.path,t.collectionGroup,t.orderBy,t.filters,t.limit,"F",t.startAt,t.endAt)}function pd(t){const e=Ps(t);return Ps(Ps(e.localStore).persistence).vi()}async function yd(t,e,n,s){const r=Ps(t);if(r.fc)return void ks("SyncEngine","Ignoring unexpected query state notification.");const i=r.ic.get(e);if(i&&i.length>0)switch(n){case"current":case"not-current":{const t=await Eh(r.localStore,fo(i[0])),s=fa.createSynthesizedRemoteEventForCurrentChange(e,"current"===n);await ud(r,t,s);break}case"rejected":await vh(r.localStore,e,!0),sd(r,e,s);break;default:Os()}}async function wd(t,e,n){const s=vd(t);if(s.fc){for(const t of e){if(s.ic.has(t)){ks("SyncEngine","Adding an already active target "+t);continue}const e=await bh(s.localStore,t),n=await wh(s.localStore,e);await Hl(s,gd(e),n.targetId,!1),Jh(s.remoteStore,n)}for(const t of n)s.ic.has(t)&&await vh(s.localStore,t,!1).then((()=>{Zh(s.remoteStore,t),sd(s,t)})).catch(Er)}}function vd(t){const e=Ps(t);return e.remoteStore.remoteSyncer.applyRemoteEvent=Yl.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=hd.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=Jl.bind(null,e),e.nc.Wo=Ll.bind(null,e.eventManager),e.nc._c=Ml.bind(null,e.eventManager),e}function Id(t){const e=Ps(t);return e.remoteStore.remoteSyncer.applySuccessfulWrite=Zl.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=td.bind(null,e),e}class bd{constructor(){this.synchronizeTabs=!1}async initialize(t){this.It=Gh(t.databaseInfo.databaseId),this.sharedClientState=this.mc(t),this.persistence=this.gc(t),await this.persistence.start(),this.localStore=this.yc(t),this.gcScheduler=this.Ic(t,this.localStore),this.indexBackfillerScheduler=this.Tc(t,this.localStore)}Ic(t,e){return null}Tc(t,e){return null}yc(t){return fh(this.persistence,new lh,t.initialUser,this.It)}gc(t){return new th(nh.Bs,this.It)}mc(t){return new Mh}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class Ed extends bd{constructor(t,e,n){super(),this.Ec=t,this.cacheSizeBytes=e,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(t){await super.initialize(t),await this.Ec.initialize(this,t),await Id(this.Ec.syncEngine),await ll(this.Ec.remoteStore),await this.persistence.li((()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve())))}yc(t){return fh(this.persistence,new lh,t.initialUser,this.It)}Ic(t,e){const n=this.persistence.referenceDelegate.garbageCollector;return new kc(n,t.asyncQueue,e)}Tc(t,e){const n=new Mr(e,this.persistence);return new Lr(t.asyncQueue,n)}gc(t){const e=ch(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?pc.withCacheSize(this.cacheSizeBytes):pc.DEFAULT;return new oh(this.synchronizeTabs,e,t.clientId,n,t.asyncQueue,Uh(),qh(),this.It,this.sharedClientState,!!this.forceOwnership)}mc(t){return new Mh}}class Td extends Ed{constructor(t,e){super(t,e,!1),this.Ec=t,this.cacheSizeBytes=e,this.synchronizeTabs=!0}async initialize(t){await super.initialize(t);const e=this.Ec.syncEngine;this.sharedClientState instanceof Lh&&(this.sharedClientState.syncEngine={Fr:fd.bind(null,e),$r:yd.bind(null,e),Br:wd.bind(null,e),vi:pd.bind(null,e),Or:dd.bind(null,e)},await this.sharedClientState.start()),await this.persistence.li((async t=>{await async function(t,e){const n=Ps(t);if(vd(n),Id(n),!0===e&&!0!==n.fc){const t=n.sharedClientState.getAllActiveQueryTargets(),e=await md(n,t.toArray());n.fc=!0,await bl(n.remoteStore,!0);for(const t of e)Jh(n.remoteStore,t)}else if(!1===e&&!1!==n.fc){const t=[];let e=Promise.resolve();n.ic.forEach(((s,r)=>{n.sharedClientState.isLocalQueryTarget(r)?t.push(r):e=e.then((()=>(sd(n,r),vh(n.localStore,r,!0)))),Zh(n.remoteStore,r)})),await e,await md(n,t),function(t){const e=Ps(t);e.uc.forEach(((t,n)=>{Zh(e.remoteStore,n)})),e.cc.fs(),e.uc=new Map,e.oc=new Br(ur.comparator)}(n),n.fc=!1,await bl(n.remoteStore,!1)}}(this.Ec.syncEngine,t),this.gcScheduler&&(t&&!this.gcScheduler.started?this.gcScheduler.start():t||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(t&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():t||this.indexBackfillerScheduler.stop())}))}mc(t){const e=Uh();if(!Lh.C(e))throw new Us(Bs.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");const n=ch(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey);return new Lh(e,t.asyncQueue,n,t.clientId,t.initialUser)}}class Sd{async initialize(t,e){this.localStore||(this.localStore=t.localStore,this.sharedClientState=t.sharedClientState,this.datastore=this.createDatastore(e),this.remoteStore=this.createRemoteStore(e),this.eventManager=this.createEventManager(e),this.syncEngine=this.createSyncEngine(e,!t.synchronizeTabs),this.sharedClientState.onlineStateHandler=t=>Xl(this.syncEngine,t,1),this.remoteStore.remoteSyncer.handleCredentialChange=cd.bind(null,this.syncEngine),await bl(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(t){return new Nl}createDatastore(t){const e=Gh(t.databaseInfo.databaseId),n=(s=t.databaseInfo,new Bh(s));var s;return function(t,e,n,s){return new Qh(t,e,n,s)}(t.authCredentials,t.appCheckCredentials,n,e)}createRemoteStore(t){return e=this.localStore,n=this.datastore,s=t.asyncQueue,r=t=>Xl(this.syncEngine,t,0),i=Vh.C()?new Vh:new Oh,new Wh(e,n,s,r,i);var e,n,s,r,i}createSyncEngine(t,e){return function(t,e,n,s,r,i,o){const a=new zl(t,e,n,s,r,i);return o&&(a.fc=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,t.initialUser,t.maxConcurrentLimboResolutions,e)}terminate(){return async function(t){const e=Ps(t);ks("RemoteStore","RemoteStore shutting down."),e._u.add(5),await Xh(e),e.mu.shutdown(),e.gu.set("Unknown")}(this.remoteStore)}}function xd(t,e=10240){let n=0;return{async read(){if(n<t.byteLength){const s={value:t.slice(n,n+e),done:!1};return n+=e,s}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.reject("unimplemented")}}class Dd{constructor(t){this.observer=t,this.muted=!1}next(t){this.observer.next&&this.Ac(this.observer.next,t)}error(t){this.observer.error?this.Ac(this.observer.error,t):Rs("Uncaught Error in snapshot listener:",t)}Rc(){this.muted=!0}Ac(t,e){this.muted||setTimeout((()=>{this.muted||t(e)}),0)}}class _d{constructor(t,e){this.bc=t,this.It=e,this.metadata=new qs,this.buffer=new Uint8Array,this.Pc=new TextDecoder("utf-8"),this.vc().then((t=>{t&&t.ku()?this.metadata.resolve(t.payload.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==t?void 0:t.payload)}`))}),(t=>this.metadata.reject(t)))}close(){return this.bc.cancel()}async getMetadata(){return this.metadata.promise}async wc(){return await this.getMetadata(),this.vc()}async vc(){const t=await this.Vc();if(null===t)return null;const e=this.Pc.decode(t),n=Number(e);isNaN(n)&&this.Sc(`length string (${e}) is not valid number`);const s=await this.Dc(n);return new Fl(JSON.parse(s),t.length+n)}Cc(){return this.buffer.findIndex((t=>t==="{".charCodeAt(0)))}async Vc(){for(;this.Cc()<0&&!await this.xc(););if(0===this.buffer.length)return null;const t=this.Cc();t<0&&this.Sc("Reached the end of bundle when a length string is expected.");const e=this.buffer.slice(0,t);return this.buffer=this.buffer.slice(t),e}async Dc(t){for(;this.buffer.length<t;)await this.xc()&&this.Sc("Reached the end of bundle when more is expected.");const e=this.Pc.decode(this.buffer.slice(0,t));return this.buffer=this.buffer.slice(t),e}Sc(t){throw this.bc.cancel(),new Error(`Invalid bundle format: ${t}`)}async xc(){const t=await this.bc.read();if(!t.done){const e=new Uint8Array(this.buffer.length+t.value.length);e.set(this.buffer),e.set(t.value,this.buffer.length),this.buffer=e}return t.done}}class Ad{constructor(t){this.datastore=t,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}async lookup(t){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw new Us(Bs.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");const e=await async function(t,e){const n=Ps(t),s=Oa(n.It)+"/documents",r={documents:e.map((t=>ka(n.It,t)))},i=await n.fo("BatchGetDocuments",s,r,e.length),o=new Map;i.forEach((t=>{const e=function(t,e){return"found"in e?function(t,e){Vs(!!e.found),e.found.name,e.found.updateTime;const n=Ra(t,e.found.name),s=Aa(e.found.updateTime),r=new _i({mapValue:{fields:e.found.fields}});return Ci.newFoundDocument(n,s,r)}(t,e):"missing"in e?function(t,e){Vs(!!e.missing),Vs(!!e.readTime);const n=Ra(t,e.missing),s=Aa(e.readTime);return Ci.newNoDocument(n,s)}(t,e):Os()}(n.It,t);o.set(e.key.toString(),e)}));const a=[];return e.forEach((t=>{const e=o.get(t.toString());Vs(!!e),a.push(e)})),a}(this.datastore,t);return e.forEach((t=>this.recordVersion(t))),e}set(t,e){this.write(e.toMutation(t,this.precondition(t))),this.writtenDocs.add(t.toString())}update(t,e){try{this.write(e.toMutation(t,this.preconditionForUpdate(t)))}catch(t){this.lastWriteError=t}this.writtenDocs.add(t.toString())}delete(t){this.write(new zo(t,this.precondition(t))),this.writtenDocs.add(t.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;const t=this.readVersions;this.mutations.forEach((e=>{t.delete(e.key.toString())})),t.forEach(((t,e)=>{const n=ur.fromPath(e);this.mutations.push(new Qo(n,this.precondition(n)))})),await async function(t,e){const n=Ps(t),s=Oa(n.It)+"/documents",r={writes:e.map((t=>Ba(n.It,t)))};await n.co("Commit",s,r)}(this.datastore,this.mutations),this.committed=!0}recordVersion(t){let e;if(t.isFoundDocument())e=t.version;else{if(!t.isNoDocument())throw Os();e=sr.min()}const n=this.readVersions.get(t.key.toString());if(n){if(!e.isEqual(n))throw new Us(Bs.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(t.key.toString(),e)}precondition(t){const e=this.readVersions.get(t.toString());return!this.writtenDocs.has(t.toString())&&e?e.isEqual(sr.min())?Lo.exists(!1):Lo.updateTime(e):Lo.none()}preconditionForUpdate(t){const e=this.readVersions.get(t.toString());if(!this.writtenDocs.has(t.toString())&&e){if(e.isEqual(sr.min()))throw new Us(Bs.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return Lo.updateTime(e)}return Lo.exists(!0)}write(t){this.ensureCommitNotCalled(),this.mutations.push(t)}ensureCommitNotCalled(){}}class Cd{constructor(t,e,n,s,r){this.asyncQueue=t,this.datastore=e,this.options=n,this.updateFunction=s,this.deferred=r,this.Nc=n.maxAttempts,this.xo=new Kh(this.asyncQueue,"transaction_retry")}run(){this.Nc-=1,this.kc()}kc(){this.xo.Ao((async()=>{const t=new Ad(this.datastore),e=this.Mc(t);e&&e.then((e=>{this.asyncQueue.enqueueAndForget((()=>t.commit().then((()=>{this.deferred.resolve(e)})).catch((t=>{this.Oc(t)}))))})).catch((t=>{this.Oc(t)}))}))}Mc(t){try{const e=this.updateFunction(t);return!si(e)&&e.catch&&e.then?e:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(t){return this.deferred.reject(t),null}}Oc(t){this.Nc>0&&this.Fc(t)?(this.Nc-=1,this.asyncQueue.enqueueAndForget((()=>(this.kc(),Promise.resolve())))):this.deferred.reject(t)}Fc(t){if("FirebaseError"===t.name){const e=t.code;return"aborted"===e||"failed-precondition"===e||!Xo(e)}return!1}}class Nd{constructor(t,e,n,s){this.authCredentials=t,this.appCheckCredentials=e,this.asyncQueue=n,this.databaseInfo=s,this.user=Ds.UNAUTHENTICATED,this.clientId=Js.R(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,(async t=>{ks("FirestoreClient","Received user=",t.uid),await this.authCredentialListener(t),this.user=t})),this.appCheckCredentials.start(n,(t=>(ks("FirestoreClient","Received new app check token=",t),this.appCheckCredentialListener(t,this.user))))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(t){this.authCredentialListener=t}setAppCheckTokenChangeListener(t){this.appCheckCredentialListener=t}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new Us(Bs.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const t=new qs;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((async()=>{try{this.onlineComponents&&await this.onlineComponents.terminate(),this.offlineComponents&&await this.offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),t.resolve()}catch(e){const n=xl(e,"Failed to shutdown persistence");t.reject(n)}})),t.promise}}async function kd(t,e){t.asyncQueue.verifyOperationInProgress(),ks("FirestoreClient","Initializing OfflineComponentProvider");const n=await t.getConfiguration();await e.initialize(n);let s=n.initialUser;t.setCredentialChangeListener((async t=>{s.isEqual(t)||(await mh(e.localStore,t),s=t)})),e.persistence.setDatabaseDeletedListener((()=>t.terminate())),t.offlineComponents=e}async function Rd(t,e){t.asyncQueue.verifyOperationInProgress();const n=await Ld(t);ks("FirestoreClient","Initializing OnlineComponentProvider");const s=await t.getConfiguration();await e.initialize(n,s),t.setCredentialChangeListener((t=>Il(e.remoteStore,t))),t.setAppCheckTokenChangeListener(((t,n)=>Il(e.remoteStore,n))),t.onlineComponents=e}async function Ld(t){return t.offlineComponents||(ks("FirestoreClient","Using default OfflineComponentProvider"),await kd(t,new bd)),t.offlineComponents}async function Md(t){return t.onlineComponents||(ks("FirestoreClient","Using default OnlineComponentProvider"),await Rd(t,new Sd)),t.onlineComponents}function Od(t){return Ld(t).then((t=>t.persistence))}function Vd(t){return Ld(t).then((t=>t.localStore))}function Fd(t){return Md(t).then((t=>t.remoteStore))}function Pd(t){return Md(t).then((t=>t.syncEngine))}async function Bd(t){const e=await Md(t),n=e.eventManager;return n.onListen=Ql.bind(null,e.syncEngine),n.onUnlisten=Wl.bind(null,e.syncEngine),n}function Ud(t,e,n={}){const s=new qs;return t.asyncQueue.enqueueAndForget((async()=>function(t,e,n,s,r){const i=new Dd({next:i=>{e.enqueueAndForget((()=>Rl(t,o)));const a=i.docs.has(n);!a&&i.fromCache?r.reject(new Us(Bs.UNAVAILABLE,"Failed to get document because the client is offline.")):a&&i.fromCache&&s&&"server"===s.source?r.reject(new Us(Bs.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):r.resolve(i)},error:t=>r.reject(t)}),o=new Vl(to(n.path),i,{includeMetadataChanges:!0,Nu:!0});return kl(t,o)}(await Bd(t),t.asyncQueue,e,n,s))),s.promise}function qd(t,e,n={}){const s=new qs;return t.asyncQueue.enqueueAndForget((async()=>function(t,e,n,s,r){const i=new Dd({next:n=>{e.enqueueAndForget((()=>Rl(t,o))),n.fromCache&&"server"===s.source?r.reject(new Us(Bs.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):r.resolve(n)},error:t=>r.reject(t)}),o=new Vl(n,i,{includeMetadataChanges:!0,Nu:!0});return kl(t,o)}(await Bd(t),t.asyncQueue,e,n,s))),s.promise}function Gd(t,e,n,s){const r=function(t,e){let n;return n="string"==typeof t?(new TextEncoder).encode(t):t,function(t,e){return new _d(t,e)}(function(t,e){if(t instanceof Uint8Array)return xd(t,e);if(t instanceof ArrayBuffer)return xd(new Uint8Array(t),e);if(t instanceof ReadableStream)return t.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(n),e)}(n,Gh(e));t.asyncQueue.enqueueAndForget((async()=>{!function(t,e,n){const s=Ps(t);(async function(t,e,n){try{const s=await e.getMetadata();if(await function(t,e){const n=Ps(t),s=Aa(e.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",(t=>n.Ns.getBundleMetadata(t,e.id))).then((t=>!!t&&t.createTime.compareTo(s)>=0))}(t.localStore,s))return await e.close(),n._completeWith(function(t){return{taskState:"Success",documentsLoaded:t.totalDocuments,bytesLoaded:t.totalBytes,totalDocuments:t.totalDocuments,totalBytes:t.totalBytes}}(s)),Promise.resolve(new Set);n._updateProgress(Ul(s));const r=new Bl(s,t.localStore,e.It);let i=await e.wc();for(;i;){const t=await r.Ou(i);t&&n._updateProgress(t),i=await e.wc()}const o=await r.complete();return await ud(t,o.Bu,void 0),await function(t,e){const n=Ps(t);return n.persistence.runTransaction("Save bundle","readwrite",(t=>n.Ns.saveBundleMetadata(t,e)))}(t.localStore,s),n._completeWith(o.progress),Promise.resolve(o.$u)}catch(t){return Ls("SyncEngine",`Loading bundle failed with ${t}`),n._failWith(t),Promise.resolve(new Set)}})(s,e,n).then((t=>{s.sharedClientState.notifyBundleLoaded(t)}))}(await Pd(t),r,s)}))}const Kd=new Map;function jd(t,e,n){if(!n)throw new Us(Bs.INVALID_ARGUMENT,`Function ${t}() cannot be called with an empty ${e}.`)}function $d(t,e,n,s){if(!0===e&&!0===s)throw new Us(Bs.INVALID_ARGUMENT,`${t} and ${n} cannot be used together.`)}function zd(t){if(!ur.isDocumentKey(t))throw new Us(Bs.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${t} has ${t.length}.`)}function Qd(t){if(ur.isDocumentKey(t))throw new Us(Bs.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${t} has ${t.length}.`)}function Hd(t){if(void 0===t)return"undefined";if(null===t)return"null";if("string"==typeof t)return t.length>20&&(t=`${t.substring(0,20)}...`),JSON.stringify(t);if("number"==typeof t||"boolean"==typeof t)return""+t;if("object"==typeof t){if(t instanceof Array)return"an array";{const e=function(t){return t.constructor?t.constructor.name:null}(t);return e?`a custom ${e} object`:"an object"}}return"function"==typeof t?"a function":Os()}function Wd(t,e){if("_delegate"in t&&(t=t._delegate),!(t instanceof e)){if(e.name===t.constructor.name)throw new Us(Bs.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const n=Hd(t);throw new Us(Bs.INVALID_ARGUMENT,`Expected type '${e.name}', but it was: ${n}`)}}return t}function Yd(t,e){if(e<=0)throw new Us(Bs.INVALID_ARGUMENT,`Function ${t}() requires a positive number, but it was: ${e}.`)}class Xd{constructor(t){var e;if(void 0===t.host){if(void 0!==t.ssl)throw new Us(Bs.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=t.host,this.ssl=null===(e=t.ssl)||void 0===e||e;if(this.credentials=t.credentials,this.ignoreUndefinedProperties=!!t.ignoreUndefinedProperties,void 0===t.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==t.cacheSizeBytes&&t.cacheSizeBytes<1048576)throw new Us(Bs.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=t.cacheSizeBytes}this.experimentalForceLongPolling=!!t.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!!t.experimentalAutoDetectLongPolling,this.useFetchStreams=!!t.useFetchStreams,$d("experimentalForceLongPolling",t.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",t.experimentalAutoDetectLongPolling)}isEqual(t){return this.host===t.host&&this.ssl===t.ssl&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.experimentalForceLongPolling===t.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===t.experimentalAutoDetectLongPolling&&this.ignoreUndefinedProperties===t.ignoreUndefinedProperties&&this.useFetchStreams===t.useFetchStreams}}class Jd{constructor(t,e,n,s){this._authCredentials=t,this._appCheckCredentials=e,this._databaseId=n,this._app=s,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Xd({}),this._settingsFrozen=!1}get app(){if(!this._app)throw new Us(Bs.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(t){if(this._settingsFrozen)throw new Us(Bs.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Xd(t),void 0!==t.credentials&&(this._authCredentials=function(t){if(!t)return new Ks;switch(t.type){case"gapi":const e=t.client;return new Qs(e,t.sessionIndex||"0",t.iamToken||null,t.authTokenFactory||null);case"provider":return t.client;default:throw new Us(Bs.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(t.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(t){const e=Kd.get(t);e&&(ks("ComponentProvider","Removing Datastore"),Kd.delete(t),e.terminate())}(this),Promise.resolve()}}function Zd(t,e,n,s={}){var r;const i=(t=Wd(t,Jd))._getSettings();if("firestore.googleapis.com"!==i.host&&i.host!==e&&Ls("Host has been set in both settings() and useEmulator(), emulator host will be used"),t._setSettings(Object.assign(Object.assign({},i),{host:`${e}:${n}`,ssl:!1})),s.mockUserToken){let e,n;if("string"==typeof s.mockUserToken)e=s.mockUserToken,n=Ds.MOCK_USER;else{e=function(t,e){if(t.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');const n=e||"demo-project",s=t.iat||0,r=t.sub||t.user_id;if(!r)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");const i=Object.assign({iss:`https://securetoken.google.com/${n}`,aud:n,iat:s,exp:s+3600,auth_time:s,sub:r,user_id:r,firebase:{sign_in_provider:"custom",identities:{}}},t);return[u(JSON.stringify({alg:"none",type:"JWT"})),u(JSON.stringify(i)),""].join(".")}(s.mockUserToken,null===(r=t._app)||void 0===r?void 0:r.options.projectId);const i=s.mockUserToken.sub||s.mockUserToken.user_id;if(!i)throw new Us(Bs.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new Ds(i)}t._authCredentials=new js(new Gs(e,n))}}class tf{constructor(t,e,n){this.converter=e,this._key=n,this.type="document",this.firestore=t}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new nf(this.firestore,this.converter,this._key.path.popLast())}withConverter(t){return new tf(this.firestore,t,this._key)}}class ef{constructor(t,e,n){this.converter=e,this._query=n,this.type="query",this.firestore=t}withConverter(t){return new ef(this.firestore,t,this._query)}}class nf extends ef{constructor(t,e,n){super(t,e,to(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const t=this._path.popLast();return t.isEmpty()?null:new tf(this.firestore,null,new ur(t))}withConverter(t){return new nf(this.firestore,t,this._path)}}function sf(t,e,...n){if(t=p(t),jd("collection","path",e),t instanceof Jd){const s=ir.fromString(e,...n);return Qd(s),new nf(t,null,s)}{if(!(t instanceof tf||t instanceof nf))throw new Us(Bs.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const s=t._path.child(ir.fromString(e,...n));return Qd(s),new nf(t.firestore,null,s)}}function rf(t,e){if(t=Wd(t,Jd),jd("collectionGroup","collection id",e),e.indexOf("/")>=0)throw new Us(Bs.INVALID_ARGUMENT,`Invalid collection ID '${e}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new ef(t,null,function(t){return new Ji(ir.emptyPath(),t)}(e))}function of(t,e,...n){if(t=p(t),1===arguments.length&&(e=Js.R()),jd("doc","path",e),t instanceof Jd){const s=ir.fromString(e,...n);return zd(s),new tf(t,null,new ur(s))}{if(!(t instanceof tf||t instanceof nf))throw new Us(Bs.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const s=t._path.child(ir.fromString(e,...n));return zd(s),new tf(t.firestore,t instanceof nf?t.converter:null,new ur(s))}}function af(t,e){return t=p(t),e=p(e),(t instanceof tf||t instanceof nf)&&(e instanceof tf||e instanceof nf)&&t.firestore===e.firestore&&t.path===e.path&&t.converter===e.converter}function uf(t,e){return t=p(t),e=p(e),t instanceof ef&&e instanceof ef&&t.firestore===e.firestore&&uo(t._query,e._query)&&t.converter===e.converter}class cf{constructor(){this.$c=Promise.resolve(),this.Bc=[],this.Lc=!1,this.Uc=[],this.qc=null,this.Kc=!1,this.Gc=!1,this.Qc=[],this.xo=new Kh(this,"async_queue_retry"),this.jc=()=>{const t=qh();t&&ks("AsyncQueue","Visibility state changed to "+t.visibilityState),this.xo.bo()};const t=qh();t&&"function"==typeof t.addEventListener&&t.addEventListener("visibilitychange",this.jc)}get isShuttingDown(){return this.Lc}enqueueAndForget(t){this.enqueue(t)}enqueueAndForgetEvenWhileRestricted(t){this.Wc(),this.zc(t)}enterRestrictedMode(t){if(!this.Lc){this.Lc=!0,this.Gc=t||!1;const e=qh();e&&"function"==typeof e.removeEventListener&&e.removeEventListener("visibilitychange",this.jc)}}enqueue(t){if(this.Wc(),this.Lc)return new Promise((()=>{}));const e=new qs;return this.zc((()=>this.Lc&&this.Gc?Promise.resolve():(t().then(e.resolve,e.reject),e.promise))).then((()=>e.promise))}enqueueRetryable(t){this.enqueueAndForget((()=>(this.Bc.push(t),this.Hc())))}async Hc(){if(0!==this.Bc.length){try{await this.Bc[0](),this.Bc.shift(),this.xo.reset()}catch(t){if(!Ar(t))throw t;ks("AsyncQueue","Operation failed with retryable error: "+t)}this.Bc.length>0&&this.xo.Ao((()=>this.Hc()))}}zc(t){const e=this.$c.then((()=>(this.Kc=!0,t().catch((t=>{this.qc=t,this.Kc=!1;const e=function(t){let e=t.message||"";return t.stack&&(e=t.stack.includes(t.message)?t.stack:t.message+"\n"+t.stack),e}(t);throw Rs("INTERNAL UNHANDLED ERROR: ",e),t})).then((t=>(this.Kc=!1,t))))));return this.$c=e,e}enqueueAfterDelay(t,e,n){this.Wc(),this.Qc.indexOf(t)>-1&&(e=0);const s=Sl.createAndSchedule(this,t,e,n,(t=>this.Jc(t)));return this.Uc.push(s),s}Wc(){this.qc&&Os()}verifyOperationInProgress(){}async Yc(){let t;do{t=this.$c,await t}while(t!==this.$c)}Xc(t){for(const e of this.Uc)if(e.timerId===t)return!0;return!1}Zc(t){return this.Yc().then((()=>{this.Uc.sort(((t,e)=>t.targetTimeMs-e.targetTimeMs));for(const e of this.Uc)if(e.skipDelay(),"all"!==t&&e.timerId===t)break;return this.Yc()}))}ta(t){this.Qc.push(t)}Jc(t){const e=this.Uc.indexOf(t);this.Uc.splice(e,1)}}function hf(t){return function(t,e){if("object"!=typeof t||null===t)return!1;const n=t;for(const t of["next","error","complete"])if(t in n&&"function"==typeof n[t])return!0;return!1}(t)}class lf{constructor(){this._progressObserver={},this._taskCompletionResolver=new qs,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(t,e,n){this._progressObserver={next:t,error:e,complete:n}}catch(t){return this._taskCompletionResolver.promise.catch(t)}then(t,e){return this._taskCompletionResolver.promise.then(t,e)}_completeWith(t){this._updateProgress(t),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(t)}_failWith(t){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(t),this._taskCompletionResolver.reject(t)}_updateProgress(t){this._lastProgress=t,this._progressObserver.next&&this._progressObserver.next(t)}}const df=-1;class ff extends Jd{constructor(t,e,n,s){super(t,e,n,s),this.type="firestore",this._queue=new cf,this._persistenceKey=(null==s?void 0:s.name)||"[DEFAULT]"}_terminate(){return this._firestoreClient||yf(this),this._firestoreClient.terminate()}}function mf(t,e,s){s||(s="(default)");const r=n(t,"firestore");if(r.isInitialized(s)){const t=r.getImmediate({identifier:s});if(m(r.getOptions(s),e))return t;throw new Us(Bs.FAILED_PRECONDITION,"initializeFirestore() has already been called with different options. To avoid this error, call initializeFirestore() with the same options as when it was originally called, or call getFirestore() to return the already initialized instance.")}if(void 0!==e.cacheSizeBytes&&-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new Us(Bs.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");return r.initialize({options:e,instanceIdentifier:s})}function gf(t,e){const r="object"==typeof t?t:s(),i="string"==typeof t?t:e||"(default)";return n(r,"firestore").getImmediate({identifier:i})}function pf(t){return t._firestoreClient||yf(t),t._firestoreClient.verifyNotTerminated(),t._firestoreClient}function yf(t){var e;const n=t._freezeSettings(),s=function(t,e,n,s){return new ei(t,e,n,s.host,s.ssl,s.experimentalForceLongPolling,s.experimentalAutoDetectLongPolling,s.useFetchStreams)}(t._databaseId,(null===(e=t._app)||void 0===e?void 0:e.options.appId)||"",t._persistenceKey,n);t._firestoreClient=new Nd(t._authCredentials,t._appCheckCredentials,t._queue,s)}function wf(t,e){Af(t=Wd(t,ff));const n=pf(t),s=t._freezeSettings(),r=new Sd;return If(n,r,new Ed(r,s.cacheSizeBytes,null==e?void 0:e.forceOwnership))}function vf(t){Af(t=Wd(t,ff));const e=pf(t),n=t._freezeSettings(),s=new Sd;return If(e,s,new Td(s,n.cacheSizeBytes))}function If(t,e,n){const s=new qs;return t.asyncQueue.enqueue((async()=>{try{await kd(t,n),await Rd(t,e),s.resolve()}catch(t){const e=t;if(!function(t){return"FirebaseError"===t.name?t.code===Bs.FAILED_PRECONDITION||t.code===Bs.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||(22===t.code||20===t.code||11===t.code)}(e))throw e;Ls("Error enabling offline persistence. Falling back to persistence disabled: "+e),s.reject(e)}})).then((()=>s.promise))}function bf(t){if(t._initialized&&!t._terminated)throw new Us(Bs.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const e=new qs;return t._queue.enqueueAndForgetEvenWhileRestricted((async()=>{try{await async function(t){if(!xr.C())return Promise.resolve();const e=t+"main";await xr.delete(e)}(ch(t._databaseId,t._persistenceKey)),e.resolve()}catch(t){e.reject(t)}})),e.promise}function Ef(t){return function(t){const e=new qs;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e){const n=Ps(t);rl(n.remoteStore)||ks("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const t=await function(t){const e=Ps(t);return e.persistence.runTransaction("Get highest unacknowledged batch id","readonly",(t=>e.mutationQueue.getHighestUnacknowledgedBatchId(t)))}(n.localStore);if(-1===t)return void e.resolve();const s=n.hc.get(t)||[];s.push(e),n.hc.set(t,s)}catch(t){const n=xl(t,"Initialization of waitForPendingWrites() operation failed");e.reject(n)}}(await Pd(t),e))),e.promise}(pf(t=Wd(t,ff)))}function Tf(t){return function(t){return t.asyncQueue.enqueue((async()=>{const e=await Od(t),n=await Fd(t);return e.setNetworkEnabled(!0),function(t){const e=Ps(t);return e._u.delete(0),Yh(e)}(n)}))}(pf(t=Wd(t,ff)))}function Sf(t){return function(t){return t.asyncQueue.enqueue((async()=>{const e=await Od(t),n=await Fd(t);return e.setNetworkEnabled(!1),async function(t){const e=Ps(t);e._u.add(0),await Xh(e),e.gu.set("Offline")}(n)}))}(pf(t=Wd(t,ff)))}function xf(t){return r(t.app,"firestore",t._databaseId.database),t._delete()}function Df(t,e){const n=pf(t=Wd(t,ff)),s=new lf;return Gd(n,t._databaseId,e,s),s}function _f(t,e){return function(t,e){return t.asyncQueue.enqueue((async()=>function(t,e){const n=Ps(t);return n.persistence.runTransaction("Get named query","readonly",(t=>n.Ns.getNamedQuery(t,e)))}(await Vd(t),e)))}(pf(t=Wd(t,ff)),e).then((e=>e?new ef(t,null,e.query):null))}function Af(t){if(t._initialized||t._terminated)throw new Us(Bs.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class Cf{constructor(...t){for(let e=0;e<t.length;++e)if(0===t[e].length)throw new Us(Bs.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new ar(t)}isEqual(t){return this._internalPath.isEqual(t._internalPath)}}function Nf(){return new Cf("__name__")}class kf{constructor(t){this._byteString=t}static fromBase64String(t){try{return new kf(Qr.fromBase64String(t))}catch(t){throw new Us(Bs.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+t)}}static fromUint8Array(t){return new kf(Qr.fromUint8Array(t))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(t){return this._byteString.isEqual(t._byteString)}}class Rf{constructor(t){this._methodName=t}}class Lf{constructor(t,e){if(!isFinite(t)||t<-90||t>90)throw new Us(Bs.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||e>180)throw new Us(Bs.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}get latitude(){return this._lat}get longitude(){return this._long}isEqual(t){return this._lat===t._lat&&this._long===t._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(t){return Zs(this._lat,t._lat)||Zs(this._long,t._long)}}const Mf=/^__.*__$/;class Of{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return null!==this.fieldMask?new Go(t,this.data,this.fieldMask,e,this.fieldTransforms):new qo(t,this.data,e,this.fieldTransforms)}}class Vf{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return new Go(t,this.data,this.fieldMask,e,this.fieldTransforms)}}function Ff(t){switch(t){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw Os()}}class Pf{constructor(t,e,n,s,r,i){this.settings=t,this.databaseId=e,this.It=n,this.ignoreUndefinedProperties=s,void 0===r&&this.ea(),this.fieldTransforms=r||[],this.fieldMask=i||[]}get path(){return this.settings.path}get na(){return this.settings.na}sa(t){return new Pf(Object.assign(Object.assign({},this.settings),t),this.databaseId,this.It,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}ia(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),s=this.sa({path:n,ra:!1});return s.oa(t),s}ua(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),s=this.sa({path:n,ra:!1});return s.ea(),s}ca(t){return this.sa({path:void 0,ra:!0})}aa(t){return rm(t,this.settings.methodName,this.settings.ha||!1,this.path,this.settings.la)}contains(t){return void 0!==this.fieldMask.find((e=>t.isPrefixOf(e)))||void 0!==this.fieldTransforms.find((e=>t.isPrefixOf(e.field)))}ea(){if(this.path)for(let t=0;t<this.path.length;t++)this.oa(this.path.get(t))}oa(t){if(0===t.length)throw this.aa("Document fields must not be empty");if(Ff(this.na)&&Mf.test(t))throw this.aa('Document fields cannot begin and end with "__"')}}class Bf{constructor(t,e,n){this.databaseId=t,this.ignoreUndefinedProperties=e,this.It=n||Gh(t)}fa(t,e,n,s=!1){return new Pf({na:t,methodName:e,la:n,path:ar.emptyPath(),ra:!1,ha:s},this.databaseId,this.It,this.ignoreUndefinedProperties)}}function Uf(t){const e=t._freezeSettings(),n=Gh(t._databaseId);return new Bf(t._databaseId,!!e.ignoreUndefinedProperties,n)}function qf(t,e,n,s,r,i={}){const o=t.fa(i.merge||i.mergeFields?2:0,e,n,r);tm("Data must be an object, but it was:",o,s);const a=Jf(s,o);let u,c;if(i.merge)u=new $r(o.fieldMask),c=o.fieldTransforms;else if(i.mergeFields){const t=[];for(const s of i.mergeFields){const r=em(e,s,n);if(!o.contains(r))throw new Us(Bs.INVALID_ARGUMENT,`Field '${r}' is specified in your field mask but missing from your input data.`);im(t,r)||t.push(r)}u=new $r(t),c=o.fieldTransforms.filter((t=>u.covers(t.field)))}else u=null,c=o.fieldTransforms;return new Of(new _i(a),u,c)}class Gf extends Rf{_toFieldTransform(t){if(2!==t.na)throw 1===t.na?t.aa(`${this._methodName}() can only appear at the top level of your update data`):t.aa(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return t.fieldMask.push(t.path),null}isEqual(t){return t instanceof Gf}}function Kf(t,e,n){return new Pf({na:3,la:e.settings.la,methodName:t._methodName,ra:n},e.databaseId,e.It,e.ignoreUndefinedProperties)}class jf extends Rf{_toFieldTransform(t){return new ko(t.path,new To)}isEqual(t){return t instanceof jf}}class $f extends Rf{constructor(t,e){super(t),this.da=e}_toFieldTransform(t){const e=Kf(this,t,!0),n=this.da.map((t=>Xf(t,e))),s=new So(n);return new ko(t.path,s)}isEqual(t){return this===t}}class zf extends Rf{constructor(t,e){super(t),this.da=e}_toFieldTransform(t){const e=Kf(this,t,!0),n=this.da.map((t=>Xf(t,e))),s=new Do(n);return new ko(t.path,s)}isEqual(t){return this===t}}class Qf extends Rf{constructor(t,e){super(t),this._a=e}_toFieldTransform(t){const e=new Ao(t.It,wo(t.It,this._a));return new ko(t.path,e)}isEqual(t){return this===t}}function Hf(t,e,n,s){const r=t.fa(1,e,n);tm("Data must be an object, but it was:",r,s);const i=[],o=_i.empty();Fr(s,((t,s)=>{const a=sm(e,t,n);s=p(s);const u=r.ua(a);if(s instanceof Gf)i.push(a);else{const t=Xf(s,u);null!=t&&(i.push(a),o.set(a,t))}}));const a=new $r(i);return new Vf(o,a,r.fieldTransforms)}function Wf(t,e,n,s,r,i){const o=t.fa(1,e,n),a=[em(e,s,n)],u=[r];if(i.length%2!=0)throw new Us(Bs.INVALID_ARGUMENT,`Function ${e}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let t=0;t<i.length;t+=2)a.push(em(e,i[t])),u.push(i[t+1]);const c=[],h=_i.empty();for(let t=a.length-1;t>=0;--t)if(!im(c,a[t])){const e=a[t];let n=u[t];n=p(n);const s=o.ua(e);if(n instanceof Gf)c.push(e);else{const t=Xf(n,s);null!=t&&(c.push(e),h.set(e,t))}}const l=new $r(c);return new Vf(h,l,o.fieldTransforms)}function Yf(t,e,n,s=!1){return Xf(n,t.fa(s?4:3,e))}function Xf(t,e){if(Zf(t=p(t)))return tm("Unsupported field value:",e,t),Jf(t,e);if(t instanceof Rf)return function(t,e){if(!Ff(e.na))throw e.aa(`${t._methodName}() can only be used with update() and set()`);if(!e.path)throw e.aa(`${t._methodName}() is not currently supported inside arrays`);const n=t._toFieldTransform(e);n&&e.fieldTransforms.push(n)}(t,e),null;if(void 0===t&&e.ignoreUndefinedProperties)return null;if(e.path&&e.fieldMask.push(e.path),t instanceof Array){if(e.settings.ra&&4!==e.na)throw e.aa("Nested arrays are not supported");return function(t,e){const n=[];let s=0;for(const r of t){let t=Xf(r,e.ca(s));null==t&&(t={nullValue:"NULL_VALUE"}),n.push(t),s++}return{arrayValue:{values:n}}}(t,e)}return function(t,e){if(null===(t=p(t)))return{nullValue:"NULL_VALUE"};if("number"==typeof t)return wo(e.It,t);if("boolean"==typeof t)return{booleanValue:t};if("string"==typeof t)return{stringValue:t};if(t instanceof Date){const n=nr.fromDate(t);return{timestampValue:xa(e.It,n)}}if(t instanceof nr){const n=new nr(t.seconds,1e3*Math.floor(t.nanoseconds/1e3));return{timestampValue:xa(e.It,n)}}if(t instanceof Lf)return{geoPointValue:{latitude:t.latitude,longitude:t.longitude}};if(t instanceof kf)return{bytesValue:Da(e.It,t._byteString)};if(t instanceof tf){const n=e.databaseId,s=t.firestore._databaseId;if(!s.isEqual(n))throw e.aa(`Document reference is for database ${s.projectId}/${s.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:Ca(t.firestore._databaseId||e.databaseId,t._key.path)}}throw e.aa(`Unsupported field value: ${Hd(t)}`)}(t,e)}function Jf(t,e){const n={};return Pr(t)?e.path&&e.path.length>0&&e.fieldMask.push(e.path):Fr(t,((t,s)=>{const r=Xf(s,e.ia(t));null!=r&&(n[t]=r)})),{mapValue:{fields:n}}}function Zf(t){return!("object"!=typeof t||null===t||t instanceof Array||t instanceof Date||t instanceof nr||t instanceof Lf||t instanceof kf||t instanceof tf||t instanceof Rf)}function tm(t,e,n){if(!Zf(n)||!function(t){return"object"==typeof t&&null!==t&&(Object.getPrototypeOf(t)===Object.prototype||null===Object.getPrototypeOf(t))}(n)){const s=Hd(n);throw"an object"===s?e.aa(t+" a custom object"):e.aa(t+" "+s)}}function em(t,e,n){if((e=p(e))instanceof Cf)return e._internalPath;if("string"==typeof e)return sm(t,e);throw rm("Field path arguments must be of type string or ",t,!1,void 0,n)}const nm=new RegExp("[~\\*/\\[\\]]");function sm(t,e,n){if(e.search(nm)>=0)throw rm(`Invalid field path (${e}). Paths must not contain '~', '*', '/', '[', or ']'`,t,!1,void 0,n);try{return new Cf(...e.split("."))._internalPath}catch(s){throw rm(`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,t,!1,void 0,n)}}function rm(t,e,n,s,r){const i=s&&!s.isEmpty(),o=void 0!==r;let a=`Function ${e}() called with invalid data`;n&&(a+=" (via `toFirestore()`)"),a+=". ";let u="";return(i||o)&&(u+=" (found",i&&(u+=` in field ${s}`),o&&(u+=` in document ${r}`),u+=")"),new Us(Bs.INVALID_ARGUMENT,a+t+u)}function im(t,e){return t.some((t=>t.isEqual(e)))}class om{constructor(t,e,n,s,r){this._firestore=t,this._userDataWriter=e,this._key=n,this._document=s,this._converter=r}get id(){return this._key.path.lastSegment()}get ref(){return new tf(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const t=new am(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(t)}return this._userDataWriter.convertValue(this._document.data.value)}}get(t){if(this._document){const e=this._document.data.field(um("DocumentSnapshot.get",t));if(null!==e)return this._userDataWriter.convertValue(e)}}}class am extends om{data(){return super.data()}}function um(t,e){return"string"==typeof e?sm(t,e):e instanceof Cf?e._internalPath:e._delegate._internalPath}class cm{constructor(t,e){this.hasPendingWrites=t,this.fromCache=e}isEqual(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache}}class hm extends om{constructor(t,e,n,s,r,i){super(t,e,n,s,i),this._firestore=t,this._firestoreImpl=t,this.metadata=r}exists(){return super.exists()}data(t={}){if(this._document){if(this._converter){const e=new lm(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(e,t)}return this._userDataWriter.convertValue(this._document.data.value,t.serverTimestamps)}}get(t,e={}){if(this._document){const n=this._document.data.field(um("DocumentSnapshot.get",t));if(null!==n)return this._userDataWriter.convertValue(n,e.serverTimestamps)}}}class lm extends hm{data(t={}){return super.data(t)}}class dm{constructor(t,e,n,s){this._firestore=t,this._userDataWriter=e,this._snapshot=s,this.metadata=new cm(s.hasPendingWrites,s.fromCache),this.query=n}get docs(){const t=[];return this.forEach((e=>t.push(e))),t}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(t,e){this._snapshot.docs.forEach((n=>{t.call(e,new lm(this._firestore,this._userDataWriter,n.key,n,new cm(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))}))}docChanges(t={}){const e=!!t.includeMetadataChanges;if(e&&this._snapshot.excludesMetadataChanges)throw new Us(Bs.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(t,e){if(t._snapshot.oldDocs.isEmpty()){let e=0;return t._snapshot.docChanges.map((n=>({type:"added",doc:new lm(t._firestore,t._userDataWriter,n.doc.key,n.doc,new cm(t._snapshot.mutatedKeys.has(n.doc.key),t._snapshot.fromCache),t.query.converter),oldIndex:-1,newIndex:e++})))}{let n=t._snapshot.oldDocs;return t._snapshot.docChanges.filter((t=>e||3!==t.type)).map((e=>{const s=new lm(t._firestore,t._userDataWriter,e.doc.key,e.doc,new cm(t._snapshot.mutatedKeys.has(e.doc.key),t._snapshot.fromCache),t.query.converter);let r=-1,i=-1;return 0!==e.type&&(r=n.indexOf(e.doc.key),n=n.delete(e.doc.key)),1!==e.type&&(n=n.add(e.doc),i=n.indexOf(e.doc.key)),{type:fm(e.type),doc:s,oldIndex:r,newIndex:i}}))}}(this,e),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges}}function fm(t){switch(t){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return Os()}}function mm(t,e){return t instanceof hm&&e instanceof hm?t._firestore===e._firestore&&t._key.isEqual(e._key)&&(null===t._document?null===e._document:t._document.isEqual(e._document))&&t._converter===e._converter:t instanceof dm&&e instanceof dm&&t._firestore===e._firestore&&uf(t.query,e.query)&&t.metadata.isEqual(e.metadata)&&t._snapshot.isEqual(e._snapshot)}function gm(t){if("L"===t.limitType&&0===t.explicitOrderBy.length)throw new Us(Bs.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class pm{}function ym(t,...e){for(const n of e)t=n._apply(t);return t}class wm extends pm{constructor(t,e,n){super(),this.wa=t,this.ma=e,this.ga=n,this.type="where"}_apply(t){const e=Uf(t.firestore),n=function(t,e,n,s,r,i,o){let a;if(r.isKeyField()){if("array-contains"===i||"array-contains-any"===i)throw new Us(Bs.INVALID_ARGUMENT,`Invalid Query. You can't perform '${i}' queries on documentId().`);if("in"===i||"not-in"===i){Lm(o,i);const e=[];for(const n of o)e.push(Rm(s,t,n));a={arrayValue:{values:e}}}else a=Rm(s,t,o)}else"in"!==i&&"not-in"!==i&&"array-contains-any"!==i||Lm(o,i),a=Yf(n,"where",o,"in"===i||"not-in"===i);const u=Pi.create(r,i,a);return function(t,e){if(e.dt()){const n=so(t);if(null!==n&&!n.isEqual(e.field))throw new Us(Bs.INVALID_ARGUMENT,`Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '${n.toString()}' and '${e.field.toString()}'`);const s=no(t);null!==s&&Mm(t,e.field,s)}const n=function(t,e){for(const n of t.filters)if(e.indexOf(n.op)>=0)return n.op;return null}(t,function(t){switch(t){case"!=":return["!=","not-in"];case"array-contains":return["array-contains","array-contains-any","not-in"];case"in":return["array-contains-any","in","not-in"];case"array-contains-any":return["array-contains","array-contains-any","in","not-in"];case"not-in":return["array-contains","array-contains-any","in","not-in","!="];default:return[]}}(e.op));if(null!==n)throw n===e.op?new Us(Bs.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${e.op.toString()}' filter.`):new Us(Bs.INVALID_ARGUMENT,`Invalid query. You cannot use '${e.op.toString()}' filters with '${n.toString()}' filters.`)}(t,u),u}(t._query,0,e,t.firestore._databaseId,this.wa,this.ma,this.ga);return new ef(t.firestore,t.converter,function(t,e){const n=t.filters.concat([e]);return new Ji(t.path,t.collectionGroup,t.explicitOrderBy.slice(),n,t.limit,t.limitType,t.startAt,t.endAt)}(t._query,n))}}function vm(t,e,n){const s=e,r=um("where",t);return new wm(r,s,n)}class Im extends pm{constructor(t,e){super(),this.wa=t,this.ya=e,this.type="orderBy"}_apply(t){const e=function(t,e,n){if(null!==t.startAt)throw new Us(Bs.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==t.endAt)throw new Us(Bs.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");const s=new Hi(e,n);return function(t,e){if(null===no(t)){const n=so(t);null!==n&&Mm(t,n,e.field)}}(t,s),s}(t._query,this.wa,this.ya);return new ef(t.firestore,t.converter,function(t,e){const n=t.explicitOrderBy.concat([e]);return new Ji(t.path,t.collectionGroup,n,t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)}(t._query,e))}}function bm(t,e="asc"){const n=e,s=um("orderBy",t);return new Im(s,n)}class Em extends pm{constructor(t,e,n){super(),this.type=t,this.pa=e,this.Ia=n}_apply(t){return new ef(t.firestore,t.converter,ao(t._query,this.pa,this.Ia))}}function Tm(t){return Yd("limit",t),new Em("limit",t,"F")}function Sm(t){return Yd("limitToLast",t),new Em("limitToLast",t,"L")}class xm extends pm{constructor(t,e,n){super(),this.type=t,this.Ta=e,this.Ea=n}_apply(t){const e=km(t,this.type,this.Ta,this.Ea);return new ef(t.firestore,t.converter,function(t,e){return new Ji(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,e,t.endAt)}(t._query,e))}}function Dm(...t){return new xm("startAt",t,!0)}function _m(...t){return new xm("startAfter",t,!1)}class Am extends pm{constructor(t,e,n){super(),this.type=t,this.Ta=e,this.Ea=n}_apply(t){const e=km(t,this.type,this.Ta,this.Ea);return new ef(t.firestore,t.converter,function(t,e){return new Ji(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,e)}(t._query,e))}}function Cm(...t){return new Am("endBefore",t,!1)}function Nm(...t){return new Am("endAt",t,!0)}function km(t,e,n,s){if(n[0]=p(n[0]),n[0]instanceof om)return function(t,e,n,s,r){if(!s)throw new Us(Bs.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const i=[];for(const n of io(t))if(n.field.isKeyField())i.push(gi(e,s.key));else{const t=s.data.field(n.field);if(Jr(t))throw new Us(Bs.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===t){const t=n.field.canonicalString();throw new Us(Bs.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${t}' (used as the orderBy) does not exist.`)}i.push(t)}return new Qi(i,r)}(t._query,t.firestore._databaseId,e,n[0]._document,s);{const r=Uf(t.firestore);return function(t,e,n,s,r,i){const o=t.explicitOrderBy;if(r.length>o.length)throw new Us(Bs.INVALID_ARGUMENT,`Too many arguments provided to ${s}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const a=[];for(let i=0;i<r.length;i++){const u=r[i];if(o[i].field.isKeyField()){if("string"!=typeof u)throw new Us(Bs.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${s}(), but got a ${typeof u}`);if(!ro(t)&&-1!==u.indexOf("/"))throw new Us(Bs.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${s}() must be a plain document ID, but '${u}' contains a slash.`);const n=t.path.child(ir.fromString(u));if(!ur.isDocumentKey(n))throw new Us(Bs.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${s}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const r=new ur(n);a.push(gi(e,r))}else{const t=Yf(n,s,u);a.push(t)}}return new Qi(a,i)}(t._query,t.firestore._databaseId,r,e,n,s)}}function Rm(t,e,n){if("string"==typeof(n=p(n))){if(""===n)throw new Us(Bs.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!ro(e)&&-1!==n.indexOf("/"))throw new Us(Bs.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);const s=e.path.child(ir.fromString(n));if(!ur.isDocumentKey(s))throw new Us(Bs.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${s}' is not because it has an odd number of segments (${s.length}).`);return gi(t,new ur(s))}if(n instanceof tf)return gi(t,n._key);throw new Us(Bs.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${Hd(n)}.`)}function Lm(t,e){if(!Array.isArray(t)||0===t.length)throw new Us(Bs.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${e.toString()}' filters.`);if(t.length>10)throw new Us(Bs.INVALID_ARGUMENT,`Invalid Query. '${e.toString()}' filters support a maximum of 10 elements in the value array.`)}function Mm(t,e,n){if(!n.isEqual(e))throw new Us(Bs.INVALID_ARGUMENT,`Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '${e.toString()}' and so you must also use '${e.toString()}' as your first argument to orderBy(), but your first orderBy() is on field '${n.toString()}' instead.`)}const Om={maxAttempts:5};class Vm{convertValue(t,e="none"){switch(ui(t)){case 0:return null;case 1:return t.booleanValue;case 2:return Yr(t.integerValue||t.doubleValue);case 3:return this.convertTimestamp(t.timestampValue);case 4:return this.convertServerTimestamp(t,e);case 5:return t.stringValue;case 6:return this.convertBytes(Xr(t.bytesValue));case 7:return this.convertReference(t.referenceValue);case 8:return this.convertGeoPoint(t.geoPointValue);case 9:return this.convertArray(t.arrayValue,e);case 10:return this.convertObject(t.mapValue,e);default:throw Os()}}convertObject(t,e){const n={};return Fr(t.fields,((t,s)=>{n[t]=this.convertValue(s,e)})),n}convertGeoPoint(t){return new Lf(Yr(t.latitude),Yr(t.longitude))}convertArray(t,e){return(t.values||[]).map((t=>this.convertValue(t,e)))}convertServerTimestamp(t,e){switch(e){case"previous":const n=Zr(t);return null==n?null:this.convertValue(n,e);case"estimate":return this.convertTimestamp(ti(t));default:return null}}convertTimestamp(t){const e=Wr(t);return new nr(e.seconds,e.nanos)}convertDocumentKey(t,e){const n=ir.fromString(t);Vs(Ja(n));const s=new ni(n.get(1),n.get(3)),r=new ur(n.popFirst(5));return s.isEqual(e)||Rs(`Document ${r} contains a document reference within a different database (${s.projectId}/${s.database}) which is not supported. It will be treated as a reference in the current database (${e.projectId}/${e.database}) instead.`),r}}function Fm(t,e,n){let s;return s=t?n&&(n.merge||n.mergeFields)?t.toFirestore(e,n):t.toFirestore(e):e,s}class Pm extends Vm{constructor(t){super(),this.firestore=t}convertBytes(t){return new kf(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new tf(this.firestore,null,e)}}class Bm{constructor(t,e){this._firestore=t,this._commitHandler=e,this._mutations=[],this._committed=!1,this._dataReader=Uf(t)}set(t,e,n){this._verifyNotCommitted();const s=Um(t,this._firestore),r=Fm(s.converter,e,n),i=qf(this._dataReader,"WriteBatch.set",s._key,r,null!==s.converter,n);return this._mutations.push(i.toMutation(s._key,Lo.none())),this}update(t,e,n,...s){this._verifyNotCommitted();const r=Um(t,this._firestore);let i;return i="string"==typeof(e=p(e))||e instanceof Cf?Wf(this._dataReader,"WriteBatch.update",r._key,e,n,s):Hf(this._dataReader,"WriteBatch.update",r._key,e),this._mutations.push(i.toMutation(r._key,Lo.exists(!0))),this}delete(t){this._verifyNotCommitted();const e=Um(t,this._firestore);return this._mutations=this._mutations.concat(new zo(e._key,Lo.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new Us(Bs.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function Um(t,e){if((t=p(t)).firestore!==e)throw new Us(Bs.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return t}function qm(t){t=Wd(t,tf);const e=Wd(t.firestore,ff);return Ud(pf(e),t._key).then((n=>eg(e,t,n)))}class Gm extends Vm{constructor(t){super(),this.firestore=t}convertBytes(t){return new kf(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new tf(this.firestore,null,e)}}function Km(t){t=Wd(t,tf);const e=Wd(t.firestore,ff),n=pf(e),s=new Gm(e);return function(t,e){const n=new qs;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){try{const s=await function(t,e){const n=Ps(t);return n.persistence.runTransaction("read document","readonly",(t=>n.localDocuments.getDocument(t,e)))}(t,e);s.isFoundDocument()?n.resolve(s):s.isNoDocument()?n.resolve(null):n.reject(new Us(Bs.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(t){const s=xl(t,`Failed to get document '${e} from cache`);n.reject(s)}}(await Vd(t),e,n))),n.promise}(n,t._key).then((n=>new hm(e,s,t._key,n,new cm(null!==n&&n.hasLocalMutations,!0),t.converter)))}function jm(t){t=Wd(t,tf);const e=Wd(t.firestore,ff);return Ud(pf(e),t._key,{source:"server"}).then((n=>eg(e,t,n)))}function $m(t){t=Wd(t,ef);const e=Wd(t.firestore,ff),n=pf(e),s=new Gm(e);return gm(t._query),qd(n,t._query).then((n=>new dm(e,s,t,n)))}function zm(t){t=Wd(t,ef);const e=Wd(t.firestore,ff),n=pf(e),s=new Gm(e);return function(t,e){const n=new qs;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){try{const s=await Ih(t,e,!0),r=new Kl(e,s.Hi),i=r.ju(s.documents),o=r.applyChanges(i,!1);n.resolve(o.snapshot)}catch(t){const s=xl(t,`Failed to execute query '${e} against cache`);n.reject(s)}}(await Vd(t),e,n))),n.promise}(n,t._query).then((n=>new dm(e,s,t,n)))}function Qm(t){t=Wd(t,ef);const e=Wd(t.firestore,ff),n=pf(e),s=new Gm(e);return qd(n,t._query,{source:"server"}).then((n=>new dm(e,s,t,n)))}function Hm(t,e,n){t=Wd(t,tf);const s=Wd(t.firestore,ff),r=Fm(t.converter,e,n);return tg(s,[qf(Uf(s),"setDoc",t._key,r,null!==t.converter,n).toMutation(t._key,Lo.none())])}function Wm(t,e,n,...s){t=Wd(t,tf);const r=Wd(t.firestore,ff),i=Uf(r);let o;return o="string"==typeof(e=p(e))||e instanceof Cf?Wf(i,"updateDoc",t._key,e,n,s):Hf(i,"updateDoc",t._key,e),tg(r,[o.toMutation(t._key,Lo.exists(!0))])}function Ym(t){return tg(Wd(t.firestore,ff),[new zo(t._key,Lo.none())])}function Xm(t,e){const n=Wd(t.firestore,ff),s=of(t),r=Fm(t.converter,e);return tg(n,[qf(Uf(t.firestore),"addDoc",s._key,r,null!==t.converter,{}).toMutation(s._key,Lo.exists(!1))]).then((()=>s))}function Jm(t,...e){var n,s,r;t=p(t);let i={includeMetadataChanges:!1},o=0;"object"!=typeof e[o]||hf(e[o])||(i=e[o],o++);const a={includeMetadataChanges:i.includeMetadataChanges};if(hf(e[o])){const t=e[o];e[o]=null===(n=t.next)||void 0===n?void 0:n.bind(t),e[o+1]=null===(s=t.error)||void 0===s?void 0:s.bind(t),e[o+2]=null===(r=t.complete)||void 0===r?void 0:r.bind(t)}let u,c,h;if(t instanceof tf)c=Wd(t.firestore,ff),h=to(t._key.path),u={next:n=>{e[o]&&e[o](eg(c,t,n))},error:e[o+1],complete:e[o+2]};else{const n=Wd(t,ef);c=Wd(n.firestore,ff),h=n._query;const s=new Gm(c);u={next:t=>{e[o]&&e[o](new dm(c,s,n,t))},error:e[o+1],complete:e[o+2]},gm(t._query)}return function(t,e,n,s){const r=new Dd(s),i=new Vl(e,r,n);return t.asyncQueue.enqueueAndForget((async()=>kl(await Bd(t),i))),()=>{r.Rc(),t.asyncQueue.enqueueAndForget((async()=>Rl(await Bd(t),i)))}}(pf(c),h,a,u)}function Zm(t,e){return function(t,e){const n=new Dd(e);return t.asyncQueue.enqueueAndForget((async()=>function(t,e){Ps(t).Ru.add(e),e.next()}(await Bd(t),n))),()=>{n.Rc(),t.asyncQueue.enqueueAndForget((async()=>function(t,e){Ps(t).Ru.delete(e)}(await Bd(t),n)))}}(pf(t=Wd(t,ff)),hf(e)?e:{next:e})}function tg(t,e){return function(t,e){const n=new qs;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){const s=Id(t);try{const t=await function(t,e){const n=Ps(t),s=nr.now(),r=e.reduce(((t,e)=>t.add(e.key)),ha());let i,o;return n.persistence.runTransaction("Locally write mutations","readwrite",(t=>{let a=ea(),u=ha();return n.Gi.getEntries(t,r).next((t=>{a=t,a.forEach(((t,e)=>{e.isValidDocument()||(u=u.add(t))}))})).next((()=>n.localDocuments.getOverlayedDocuments(t,a))).next((r=>{i=r;const o=[];for(const t of e){const e=Bo(t,i.get(t.key).overlayedDocument);null!=e&&o.push(new Go(t.key,e,Ai(e.value.mapValue),Lo.exists(!0)))}return n.mutationQueue.addMutationBatch(t,s,o,e)})).next((e=>{o=e;const s=e.applyToLocalDocumentSet(i,u);return n.documentOverlayCache.saveOverlays(t,e.batchId,s)}))})).then((()=>({batchId:o.batchId,changes:ra(i)})))}(s.localStore,e);s.sharedClientState.addPendingMutation(t.batchId),function(t,e,n){let s=t.ac[t.currentUser.toKey()];s||(s=new Br(Zs)),s=s.insert(e,n),t.ac[t.currentUser.toKey()]=s}(s,t.batchId,n),await ud(s,t.changes),await ll(s.remoteStore)}catch(t){const e=xl(t,"Failed to persist write");n.reject(e)}}(await Pd(t),e,n))),n.promise}(pf(t),e)}function eg(t,e,n){const s=n.docs.get(e._key),r=new Gm(t);return new hm(t,r,e._key,s,new cm(n.hasPendingWrites,n.fromCache),e.converter)}class ng extends class{constructor(t,e){this._firestore=t,this._transaction=e,this._dataReader=Uf(t)}get(t){const e=Um(t,this._firestore),n=new Pm(this._firestore);return this._transaction.lookup([e._key]).then((t=>{if(!t||1!==t.length)return Os();const s=t[0];if(s.isFoundDocument())return new om(this._firestore,n,s.key,s,e.converter);if(s.isNoDocument())return new om(this._firestore,n,e._key,null,e.converter);throw Os()}))}set(t,e,n){const s=Um(t,this._firestore),r=Fm(s.converter,e,n),i=qf(this._dataReader,"Transaction.set",s._key,r,null!==s.converter,n);return this._transaction.set(s._key,i),this}update(t,e,n,...s){const r=Um(t,this._firestore);let i;return i="string"==typeof(e=p(e))||e instanceof Cf?Wf(this._dataReader,"Transaction.update",r._key,e,n,s):Hf(this._dataReader,"Transaction.update",r._key,e),this._transaction.update(r._key,i),this}delete(t){const e=Um(t,this._firestore);return this._transaction.delete(e._key),this}}{constructor(t,e){super(t,e),this._firestore=t}get(t){const e=Um(t,this._firestore),n=new Gm(this._firestore);return super.get(t).then((t=>new hm(this._firestore,n,e._key,t._document,new cm(!1,!1),e.converter)))}}function sg(t,e,n){t=Wd(t,ff);const s=Object.assign(Object.assign({},Om),n);return function(t){if(t.maxAttempts<1)throw new Us(Bs.INVALID_ARGUMENT,"Max attempts must be at least 1")}(s),function(t,e,n){const s=new qs;return t.asyncQueue.enqueueAndForget((async()=>{const r=await function(t){return Md(t).then((t=>t.datastore))}(t);new Cd(t.asyncQueue,r,n,e,s).run()})),s.promise}(pf(t),(n=>e(new ng(t,n))),s)}function rg(){return new Gf("deleteField")}function ig(){return new jf("serverTimestamp")}function og(...t){return new $f("arrayUnion",t)}function ag(...t){return new zf("arrayRemove",t)}function ug(t){return new Qf("increment",t)}function cg(t){return pf(t=Wd(t,ff)),new Bm(t,(e=>tg(t,e)))}function hg(t,e){var n;const s=pf(t=Wd(t,ff));if(!(null===(n=s.offlineComponents)||void 0===n?void 0:n.indexBackfillerScheduler))return Ls("Cannot enable indexes when persistence is disabled"),Promise.resolve();const r=function(t){const e="string"==typeof t?function(t){var e;try{return JSON.parse(t)}catch(t){throw new Us(Bs.INVALID_ARGUMENT,"Failed to parse JSON: "+(null===(e=t)||void 0===e?void 0:e.message))}}(t):t,n=[];if(Array.isArray(e.indexes))for(const t of e.indexes){const e=lg(t,"collectionGroup"),s=[];if(Array.isArray(t.fields))for(const e of t.fields){const t=sm("setIndexConfiguration",lg(e,"fieldPath"));"CONTAINS"===e.arrayConfig?s.push(new fr(t,2)):"ASCENDING"===e.order?s.push(new fr(t,0)):"DESCENDING"===e.order&&s.push(new fr(t,1))}n.push(new cr(cr.UNKNOWN_ID,e,s,gr.empty()))}return n}(e);return Vd(s).then((t=>async function(t,e){const n=Ps(t),s=n.indexManager,r=[];return n.persistence.runTransaction("Configure indexes","readwrite",(t=>s.getFieldIndexes(t).next((n=>function(t,e,n,s,r){t=[...t],e=[...e],t.sort(n),e.sort(n);const i=t.length,o=e.length;let a=0,u=0;for(;a<o&&u<i;){const i=n(t[u],e[a]);i<0?r(t[u++]):i>0?s(e[a++]):(a++,u++)}for(;a<o;)s(e[a++]);for(;u<i;)r(t[u++])}(n,e,dr,(e=>{r.push(s.addFieldIndex(t,e))}),(e=>{r.push(s.deleteFieldIndex(t,e))})))).next((()=>Tr.waitFor(r)))))}(t,r)))}function lg(t,e){if("string"!=typeof t[e])throw new Us(Bs.INVALID_ARGUMENT,"Missing string value for: "+e);return t[e]}!function(n,s=!0){_s=i,t(new y("firestore",((t,{instanceIdentifier:e,options:n})=>{const r=t.getProvider("app").getImmediate(),i=new ff(new $s(t.getProvider("auth-internal")),new Ws(t.getProvider("app-check-internal")),function(t,e){if(!Object.prototype.hasOwnProperty.apply(t.options,["projectId"]))throw new Us(Bs.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new ni(t.options.projectId,e)}(r,e),r);return n=Object.assign({useFetchStreams:s},n),i._setSettings(n),i}),"PUBLIC").setMultipleInstances(!0)),e(xs,"3.5.0",n),e(xs,"3.5.0","esm2017")}();export{Vm as AbstractUserDataWriter,kf as Bytes,df as CACHE_SIZE_UNLIMITED,nf as CollectionReference,tf as DocumentReference,hm as DocumentSnapshot,Cf as FieldPath,Rf as FieldValue,ff as Firestore,Us as FirestoreError,Lf as GeoPoint,lf as LoadBundleTask,ef as Query,pm as QueryConstraint,lm as QueryDocumentSnapshot,dm as QuerySnapshot,cm as SnapshotMetadata,nr as Timestamp,ng as Transaction,Bm as WriteBatch,ni as _DatabaseId,ur as _DocumentKey,Ys as _EmptyAppCheckTokenProvider,Ks as _EmptyAuthCredentialsProvider,ar as _FieldPath,Wd as _cast,Fs as _debugAssert,zr as _isBase64Available,Ls as _logWarn,$d as _validateIsNotUsedTogether,Xm as addDoc,ag as arrayRemove,og as arrayUnion,bf as clearIndexedDbPersistence,sf as collection,rf as collectionGroup,Zd as connectFirestoreEmulator,Ym as deleteDoc,rg as deleteField,Sf as disableNetwork,of as doc,Nf as documentId,wf as enableIndexedDbPersistence,vf as enableMultiTabIndexedDbPersistence,Tf as enableNetwork,Nm as endAt,Cm as endBefore,pf as ensureFirestoreConfigured,tg as executeWrite,qm as getDoc,Km as getDocFromCache,jm as getDocFromServer,$m as getDocs,zm as getDocsFromCache,Qm as getDocsFromServer,gf as getFirestore,ug as increment,mf as initializeFirestore,Tm as limit,Sm as limitToLast,Df as loadBundle,_f as namedQuery,Jm as onSnapshot,Zm as onSnapshotsInSync,bm as orderBy,ym as query,uf as queryEqual,af as refEqual,sg as runTransaction,ig as serverTimestamp,Hm as setDoc,hg as setIndexConfiguration,Ns as setLogLevel,mm as snapshotEqual,_m as startAfter,Dm as startAt,xf as terminate,Wm as updateDoc,Ef as waitForPendingWrites,vm as where,cg as writeBatch};

//# sourceMappingURL=firebase-firestore.js.map
